import{a as T0,b as Qt,c as E}from"../chunks/chunk-75YVQ3JR.js";var H0=document.getElementById("view");H0.width=480;H0.height=270;var A=480,m=270,dt=new OffscreenCanvas(A,m),p=dt.getContext("2d");p.imageSmoothingEnabled=!1;var pt=H0.getContext("2d");pt.imageSmoothingEnabled=!1;var K=document.getElementById("mini"),R=K.getContext("2d");R.imageSmoothingEnabled=!1;var te=document.getElementById("hpBar"),ee=document.getElementById("ammoBar"),oe=document.getElementById("hpText"),ne=document.getElementById("ammoText"),ie=document.getElementById("msg"),re=document.getElementById("btnReset"),ae=document.getElementById("btnToggleMap");var co=90*Math.PI/180,mt=co*.5,ht=.01,gt=.01,de=15;var P0=.6,n0="#101b2e";var i={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,mouseSensitivity:.22,calculatePlayerHeight:()=>i.height<.01?.01:i.height*1},yt=.2,b0=1,pe=1,fo=99;function xt(t){b0=Math.max(pe,Math.min(fo,t|0||pe))}function K0(){let t=Math.cos(i.a),e=Math.sin(i.a),o=-e*Math.tan(mt),n=t*Math.tan(mt),a=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:a}}var ue=[{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"},{index:8,image:"OfficeWall.png"},{index:9,image:"OfficeDoorBlue.png"}],me={0:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:3,9:3};function po(t=64,e=64){return new OffscreenCanvas(t,e)}var J=new Array(8).fill(null);function he(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let a=0;a<t.width;a++){let r=new Uint8ClampedArray(t.height*4);for(let s=0;s<t.height;s++){let l=(s*t.width+a)*4,f=s*4;r[f]=o.data[l],r[f+1]=o.data[l+1],r[f+2]=o.data[l+2],r[f+3]=o.data[l+3]}n.push({data:r,h:t.height})}return{cols:n,w:t.width,h:t.height}}var B0=J.map(t=>t?he(t):null);function uo(){B0.length=0,J.forEach(t=>{B0.push(t?he(t):null)})}var Q0=Array.from({length:82},(t,e)=>e*.0125),J0={};function mo(){for(let t=1;t<J.length;t++)if(J[t]){J0[t]={};for(let e of Q0){let o=new OffscreenCanvas(J[t].width,J[t].height),n=o.getContext("2d");n.drawImage(J[t],0,0);let a=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${a},${a},${a})`,n.fillRect(0,0,o.width,o.height),J0[t][e]=o}}}async function ho(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let a=new Image;a.onload=()=>{let r=po(64,64),s=r.getContext("2d",{willReadFrequently:!0});s.imageSmoothingEnabled=!1,s.drawImage(a,0,0,64,64),o(r)},a.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),a.src=e})}async function ge(){try{await go(ue),uo(),mo()}catch(t){console.warn("Failed to init wall textures:",t)}}async function go(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:a,image:r}=o||{};try{let s=await ho(r);return a&&a>=0&&(J[a]=s),s}catch(s){return console.warn(`Failed to load texture "${r}" for index ${a} and dont support replacing with cool gmod missing texture:`,s),null}});await Promise.all(e)}var ye=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{color:"#054213",x:0,y:0,w:1,h:1,floorColorBack:"#101b2e",cielingColorFront:"#6495ed",fogColor:"#101b2e",spawnRules:[]},{color:"#8b8000",x:3,y:5,w:14,h:12,cielingColorFront:"#8b8000",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",ceilingHeight:6,spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5},{entityType:"food",amount:2}]},{color:"#054213",x:1,y:0,w:18,h:19,cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",fogColor:"#101b2e",spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];function u0(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=q(t.length)-1;return t[e]}function q(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function tt(t,e,o){return t+(e-t)*o}function xe(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,a=o-1;for(;n<=a;){let r=n+a>>1,s=t[r];if(s===e)return r;s<e?n=r+1:a=r-1}return e-t[a]<=t[n]-e?a:n}function Et(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var i0={x:10,y:8},m0={x:3.5,y:3.5};var d={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},Y0=ye,Ee=new Map;function Me(t){let e=d.zones,o=e&&e[t]?.color||n0,n=Ee.get(o);return n||(n=Et(o),Ee.set(o,n)),n}var we=new Map;function Ae(t){let e=d.zones,o=e&&e[t]?.cielingColorFront||n0,n=we.get(o);return n||(n=Et(o),we.set(o,n)),n}function Ce(t,e,o){for(let n=0;n<o.length;n++){let a=o[n],r=Math.min(a.x,a.x+a.w),s=Math.max(a.x,a.x+a.w)-1,l=Math.min(a.y,a.y+a.h),f=Math.max(a.y,a.y+a.h)-1;if(t>=r&&t<=s&&e>=l&&e<=f)return n}return 0}var Q=new Float32Array(A),B=m>>1,nt=new Int16Array(A).fill(B),it=new Int16Array(A).fill(B),N0=new Float32Array(m),wt=new Float32Array(m),et={},I0={};function kt(){for(let r in I0)delete I0[r];for(let r in et)delete et[r];let t=B,e=i.calculatePlayerHeight(),n=2-0,a=m*(n-e)*.5;for(let r=0;r<m;r++){let s=r-t;N0[r]=s!==0?a/s:1e-6;let f=2-2,c=m*(f+e)*.5;wt[r]=s!==0?-c/s:-1e-6}for(let r=0;r<d.zones.length;r++){let s=d.zones[r];if(s.ceilingHeight!==void 0){I0[r]=new Float32Array(m);for(let l=0;l<m;l++){let f=l-t,h=s.ceilingHeight-2,u=m*(h+e)*.5;I0[r][l]=f!==0?-u/f:-1e-6}}if(s.floorDepth!==void 0){let f=2-s.floorDepth,c=m*(f-e)*.5;et[r]=new Float32Array(m);for(let h=0;h<m;h++){let u=h-t;et[r][h]=u!==0?c/u:1e-6}}}}kt();var Mt=[],At=[],Ct=[],rt=[],t0=[],St=[];function Te(){Mt.length=0,At.length=0,Ct.length=0,rt.length=0,St.length=0,Tt.clear(),bt.clear()}function X0(t,e,o,n,a,r,s,l,f,c){if(!a)return;let h=n-o;if(h<=0)return;let u=l||0,y=u<0?0:u>a.height?a.height:u,g=f||a.height,w=a.height-y,x=g<0?0:g>w?w:g,F=xe(Q0,s);t.drawImage(J0[c][Q0[F]],r,y,1,x,e,o,1,h)}function be(t){let e=i.x|0,o=i.y|0,n=t0[o*d.MAP_W+e],a=Mt[n];if(!a){a=t.createLinearGradient(0,0,0,B);let r=d.zones[n].cielingColorFront,s=d.zones[n].cielingColorBack,l=d.zones[n].fogColor;a.addColorStop(0,r||d.cielingColorFront||"#6495ED"),d.cielingColorBack&&a.addColorStop(.5,s||d.cielingColorBack||"#6495ED"),a.addColorStop(.9,l||n0),Mt[n]=a}t.fillStyle=a,t.fillRect(0,0,A,B)}var Tt=new Map;function Se(t){let e=Tt.get(t);if(!e){let[o,n,a]=Me(t);e=`rgb(${o|0},${n|0},${a|0})`,Tt.set(t,e)}return e}var bt=new Map;function ot(t){let e=bt.get(t);if(!e){let[o,n,a]=Ae(t);e=`rgb(${o|0},${n|0},${a|0})`,bt.set(t,e)}return e}function ke(){t0.length=0;let t=d.zones,e=d.MAP_W,o=d.MAP_H;for(let n=0;n<o;n++)for(let a=0;a<e;a++)t0[n*e+a]=Ce(a,n,t)}function De(t,e,o,n=0){let{dirX:a,dirY:r,planeX:s,planeY:l}=e;n=nt[o]??B;let f=n<B?B:n;if(f>=m)return;let c=2*(o+.5)/A-1,h=a+s*c,u=r+l*c,y=1/(a*h+r*u),g=f;if(i.sightDist>0)for(;g<m&&(N0[g]??1/0)>i.sightDist&&Math.abs(N0[g]??1/0)>Q[o];)g++;if(g>=m)return;let w=N0[g],x=i.x+h*w*y,F=i.y+u*w*y,O=g,k=null,D=0;for(let C=g;C<m;C++){let P=x|0,v=F|0,T=P>=0&&v>=0&&P<d.MAP_W&&v<d.MAP_H?t0[v*d.MAP_W+P]:D;if(T!==D){let H=Se(D);H!==k&&(p.fillStyle=H,k=H),p.fillRect(o,O,1,C-O),D=T,O=C}let N=N0[C+1]??w,s0=N-w;x+=h*s0*y,F+=u*s0*y,w=N}let L=Se(D);L!==k&&(p.fillStyle=L),p.fillRect(o,O,1,m-O)}function Fe(t,e,o,n=0){let{dirX:a,dirY:r,planeX:s,planeY:l}=e,f=it[o]??B,c=0;if(f<=0)return;let h=2*(o+.5)/A-1,u=a+s*h,y=r+l*h,g=1/(a*u+r*y),w=0,x=I0?.[w]?.[c]??wt[c],F=i.x+u*x*g,O=i.y+y*x*g,k=c,D=null;for(let C=c;C<f;C++){if(i.sightDist>0&&Math.abs(x)>i.sightDist){let H=ot(w);H!==D&&(p.fillStyle=H),p.fillRect(o,k,1,C-k);return}if(x>Q[o]){let H=ot(w);H!==D&&(p.fillStyle=H),p.fillRect(o,k,1,C-k);return}let P=F|0,v=O|0,T=P>=0&&v>=0&&P<d.MAP_W&&v<d.MAP_H?t0[v*d.MAP_W+P]:w;if(T!==w){let H=ot(w);H!==D&&(p.fillStyle=H,D=H),p.fillRect(o,k,1,C-k),w=T,k=C}let N=I0?.[w]?.[C+1]??wt[C+1]??x,s0=N-x;F+=u*s0*g,O+=y*s0*g,x=N}let L=ot(w);L!==D&&(p.fillStyle=L),p.fillRect(o,k,1,f-k)}function ve(t){let e=Ct[0];e||(e=t.createLinearGradient(0,0,0,m),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),Ct[0]=e),t.fillStyle=e,t.fillRect(0,0,A,m)}function _e(t){let e=B-1,o=m-e,n=i.x|0,a=i.y|0,r=t0[a*d.MAP_W+n],s=At[r];if(!s){let l=d.zones[r].floorColorBack;s=t.createLinearGradient(0,e,0,m),s.addColorStop(.05,d.zones[r].fogColor||n0),s.addColorStop(.15,l||d.floorColorBack||"#03210A"),s.addColorStop(1,"rgba(0,0,0,0)"),At[r]=s}t.fillStyle=s,t.fillRect(0,e,A,o)}function Pe(t){let o=B+1,n=i.x|0,a=i.y|0,r=t0[a*d.MAP_W+n],s=St[r];if(!s){let l=d.zones[r].fogColor||n0,f=d.zones[r].cielingColorBack||d.cielingColorBack||"#6495ED";s=t.createLinearGradient(0,0,0,0+o),s.addColorStop(0,"rgba(0,0,0,0)"),s.addColorStop(.85,f),s.addColorStop(.95,l),St[r]=s}t.fillStyle=s,t.fillRect(0,0,A,o)}function Ie(t,e,o,n,a){let{dirX:r,dirY:s,planeX:l,planeY:f}=e;for(let c=0;c<A;c++){let h=2*(c+.5)/A-1,u=r+l*h,y=s+f*h;if(u<1e-8&&u>-1e-8&&y<1e-8&&y>-1e-8){Q[c]=Number.POSITIVE_INFINITY,nt[c]=B,it[c]=B;continue}let g=1/(u||1e-9),w=1/(y||1e-9),x=i.x|0,F=i.y|0,O=g<0?-g:g,k=w<0?-w:w,D,L,C,P;u<0?(D=-1,C=(i.x-x)*O):(D=1,C=(x+1-i.x)*O),y<0?(L=-1,P=(i.y-F)*k):(L=1,P=(F+1-i.y)*k);let v=0,T=1,N=!1,s0=0,H=0;for(;!N&&s0++<256;){if(C<P?(C+=O,x+=D,v=0):(P+=k,F+=L,v=1),i.sightDist>0){let $=Math.min(C,P);if($>i.sightDist){N=!1,T=0,H=$;break}}if(x<0||F<0||x>=n||F>=a){N=!0,T=1;break}let I=o[F][x];if(I>0){N=!0,T=I;break}}if(T===0){Q[c]=Number.POSITIVE_INFINITY,nt[c]=B,it[c]=B;continue}let X;v===0?X=C-O:X=P-k,X=ht>X?ht:X;let $t=0,ro=v===0?D:0,ao=v===1?L:0,Vt=Math.abs(ro*r+ao*s)>=.9&&Math.abs(h)<=.9&&X<$t?$t:X,qt=i.x+Vt*u,Ut=i.y+Vt*y,y0;v===0?y0=Ut-(Ut|0):y0=qt-(qt|0),y0=y0<0?0:y0>.999999?.999999:y0+1e-6;let U0=B0[T]||B0[4],Z=J[T],Z0=Z?Z.width|0:U0.w|0,j=y0*Z0|0;(v===0&&D>0||v===1&&L<0)&&(j=Z0-j-1),j=j<0?0:j>=Z0?Z0-1:j;let so=X<gt?gt:X,x0=m/so|0,L0=(m-x0*i.calculatePlayerHeight())/2|0,ft=L0+x0,l0=L0,E0=ft;l0<0&&(l0=0),E0>m&&(E0=m);let Zt=E0-l0;nt[c]=E0;let w0=me[T]||1;if(it[c]=l0*w0,Zt<=0){Q[c]=X;continue}let jt=(Z?Z.height:U0.h||J[T]?.height||64)|0,Kt=(l0-L0)*(jt/(x0>1?x0:1)),Jt=Zt*(jt/Math.max(1,x0)),v0=1/(1+X*.25)*(v?.5:1);if(T===7&&(v0*=.8+.2*Math.sin(t*6+c*.05)),w0==1)X0(p,c,l0,E0,Z,j,v0,Kt,Jt,T);else if(w0>1){X0(p,c,l0,E0,Z,j,v0,Kt,Jt,T);let I=x0,$=(Z?.height||U0.h||64)|0,e0=$/Math.max(1,I),f0=Math.floor(w0)-1;for(let V=0;V<f0;V++){let d0=L0-I*(V+1),M0=ft-I*(V+1),o0=Math.max(0,Math.ceil(d0)),p0=Math.min(m,Math.floor(M0)),A0=p0-o0;if(A0<=0)continue;let C0=(o0-d0)*e0,S0=A0*e0;X0(p,c,o0,p0,Z,j,v0,C0,S0,1)}let _0=w0-(1+f0);if(_0>1e-6){let V=I*_0,d0=L0-I*f0,M0=d0-V,o0=Math.max(0,Math.ceil(M0)),p0=Math.min(m,Math.floor(d0)),A0=p0-o0;if(A0>0){let C0=d0-I,S0=(o0-C0)*e0%$;S0<0&&(S0+=$);let lo=A0*e0;X0(p,c,o0,p0,Z,j,v0,S0,lo,1)}}}else if(w0<1){let I=x0,$=(Z?.height||U0.h||64)|0,e0=$/Math.max(1,I),f0=w0;if(f0>1e-6){let _0=I*f0,V=ft,d0=V-_0,M0=Math.max(0,Math.ceil(d0)),o0=Math.min(m,Math.floor(V)),p0=o0-M0;if(p0>0){let A0=V-I,C0=(M0-A0)*e0%$;C0<0&&(C0+=$);let S0=p0*e0;X0(p,c,M0,o0,Z,j,v0,C0,S0,T)}}}if(i.sightDist>0&&X>i.sightDist*P0){let I=i.sightDist*P0,$=i.sightDist,e0=Math.min(1,Math.max(0,(X-I)/Math.max(1e-6,$-I)));if(e0>0){let f0=i.x|0,_0=i.y|0,V=t0.length>0?t0[_0*d.MAP_W+f0]:0;p.save(),p.globalAlpha=e0*.85,p.fillStyle=d.zones[V].fogColor||n0,p.fillRect(c,l0,1,E0-l0),p.restore()}}Q[c]=X}}var S={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function r0(t,e){return await yo(t,e,1)}async function yo(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((a,r)=>{let s=new Image;s.onload=()=>{let l=new OffscreenCanvas(s.width*e,s.height*e),f=l.getContext("2d");f.imageSmoothingEnabled=!1,f.drawImage(s,0,0,l.width,l.height),l.baseline=o,l.scale=e,a(l)},s.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),s.src=n})}async function Re(){S.food=await r0("noodles.png",3),S.bow=await r0("bow.png",3),S.pitchfork=await r0("pitchfork.png",3),S.keycard1=await r0("keycard1.png",3),S.barrel=await r0("emp.png",3),S.aiDrone1=await r0("aiDrone1.png",3),S.aiDrone2=await r0("aiDrone2.png",3),S.aiDrone3=await r0("aiDrone3.png",3),S.ball=await r0("Palantrash1.png",3),S.sparkle=await r0("sparkle.png",3)}var _=[];function xo(t){return m/t}function Eo(t,e,o){let{dirY:n,dirX:a,planeY:r,planeX:s,invDet:l}=o,f=l*(n*t-a*e),c=l*(-r*t+s*e);return{transX:f,transY:c}}function wo(t,e){return Math.round((A>>1)*(1+t/e))}function W0(t,e){let o=t.x-i.x,n=t.y-i.y,{transX:a,transY:r}=Eo(o,n,e);if(r<=.01)return null;let s=wo(a,r),l=t&&typeof t.scale=="number"?t.scale:t&&S[t.img]&&typeof S[t.img].scale=="number"?S[t.img].scale:1,f=xo(r)*l,c=typeof t._hR=="number"?t._hR:Math.round(f),h=.1,u=c;(f>c+h||f<c-h)&&(u=Math.round(f)),t._hR=u;let y=u,g=S[t.img],w=g&&g.width&&g.height?g.width/g.height:1,x=Math.max(1,Math.round(y*w)),F=m,O=i.calculatePlayerHeight(),k=m*.5,D,L;if(t.ground){let T=t.floorBiasFrac??.04,N=k+m*(2-O)/(2*r)-T*y,s0=N-y;D=Math.round(s0),L=Math.round(N)}else{let T=Math.round(k-y*.5);D=T,L=T+y}let C={startY:D,endY:L},P=Math.round(s-(x>>1)),v=P+x;return{drawStartX:P,drawEndX:v,drawStartY:C.startY,drawEndY:C.endY,depth:r,size:y,width:v-P}}var Oe={0:"#0c1220",1:"#ECDE60",2:"#707a88",3:"#00e676",4:"#996633",5:"#FFE300",6:" #3561ff",7:"#00FFFF"},Dt={[E.entity]:"#ffeb9c",[E.barrel]:"#CD1C18",[E.key]:"#6aa2ff",[E.food]:"#7fffd4",default:"#ffffff"};var U=6,k0=20,a0=2,Le=Math.floor(k0/2);K.width=a0+k0*U+a0;K.height=a0+k0*U+a0;function He(t){R.clearRect(0,0,K.width,K.height);let e=Math.max(0,Math.min((i.x|0)-Le,d.MAP_W-k0)),o=Math.max(0,Math.min((i.y|0)-Le,d.MAP_H-k0));for(let l=0;l<k0;l++)for(let f=0;f<k0;f++){let c=o+l,h=e+f,u=d.MAP[c]?.[h]??0,y=Oe[u]||"#000000";R.fillStyle=y,R.fillRect(a0+f*U,a0+l*U,U-1,U-1)}for(let l of t){if(!l.alive)continue;let f=a0+(l.x-e)*U,c=a0+(l.y-o)*U;R.fillStyle=Dt[l.type]||Dt.default,R.fillRect(f-2,c-2,4,4)}let n=a0+(i.x-e)*U,a=a0+(i.y-o)*U;R.fillStyle="#e7f3ff",R.beginPath(),R.arc(n,a,2.5,0,Qt),R.fill();let r=Math.cos(i.a),s=Math.sin(i.a);R.strokeStyle="#78f3d3",R.beginPath(),R.moveTo(n,a),R.lineTo(n+r*1.5*U,a+s*1.5*U),R.stroke()}var b=null,D0=null,G=null,Ft=null,Be=null;function _t(){b||(b=new(window.AudioContext||window.webkitAudioContext))}function W({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:a=0}){if(!b)return;let r=b.createOscillator(),s=b.createGain();r.type=o,r.frequency.value=t,s.gain.value=n,r.connect(s).connect(b.destination);let l=b.currentTime;a&&(r.frequency.setValueAtTime(t,l),r.frequency.linearRampToValueAtTime(t+a,l+e)),s.gain.setValueAtTime(n,l),s.gain.exponentialRampToValueAtTime(.001,l+e),r.start(l),r.stop(l+e)}function vt({dur:t=.2,vol:e=.2,lp:o=1200}){if(!b)return;let n=b.createBuffer(1,b.sampleRate*t,b.sampleRate),a=n.getChannelData(0);for(let c=0;c<a.length;c++)a[c]=Math.random()*2-1;let r=b.createBufferSource(),s=b.createGain(),l=b.createBiquadFilter();r.buffer=n,s.gain.value=e,l.type="lowpass",l.frequency.value=o,r.connect(l).connect(s).connect(b.destination);let f=b.currentTime;r.start(f),r.stop(f+t)}var Y={shot:()=>{let t=q(50),e=-q(50);W({freq:220+t+e,dur:.05+q(3)/100,type:"square",vol:.25,slide:120}),vt({dur:.03+q(3)/100,vol:.15,lp:800})},pickup:()=>{W({freq:880,dur:.06,type:"triangle",vol:.2}),W({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{vt({dur:1,vol:.3,lp:800}),W({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{W({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;W({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),W({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),W({freq:90,dur:.08,type:"sine",vol:.18}),vt({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{W({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{W({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{W({freq:600,dur:.5,type:"sawtooth",vol:.2}),W({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),W({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function Mo(t,{volume:e=.15}={}){if(b)try{if(!Ft||t!==Be){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();Ft=await b.decodeAudioData(n),Be=t}Ye(),G=b.createBufferSource(),G.buffer=Ft,G.loop=!0,D0=b.createGain(),D0.gain.value=e,G.connect(D0).connect(b.destination),G.start()}catch(o){try{Ye();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),G={stop:()=>n.pause(),disconnect:()=>{}},D0=null}catch(n){}}}function Ye(){try{G&&G.stop(0)}catch(t){}if(G&&G.disconnect)try{G.disconnect()}catch(t){}if(D0)try{D0.disconnect()}catch(t){}G=null,D0=null}var Xe=!1;async function Pt(){if(!b||G||Xe)return;Xe=!0,await Mo("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function F0(t,e){if(t<0||e<0||t>=d.MAP_W||e>=d.MAP_H)return!0;let o=d.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!i.hasBlueKey:!(o===6||o===9)}function h0(t,e,o){return!!(F0(t,e)||F0(t-o,e)||F0(t+o,e)||F0(t,e-o)||F0(t,e+o))}var R0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},Ao={[R0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:Fo,ignoreBounds:!1},[R0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:vo,ignoreBounds:!0}},G0=[];function Ne(t,e,o,n,a={}){let r=Ao[t];if(!r)return console.warn(`Unknown effect type: ${t}`),null;let s={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:a.lifetime??r.lifetime,opacity:a.startOpacity??r.startOpacity,startOpacity:a.startOpacity??r.startOpacity,endOpacity:a.endOpacity??r.endOpacity,...r,...a};return G0.push(s),s}function We(t,e,o,n={}){return Ne(R0.EXPLOSION,t,e,o,n)}function It({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){Ne(R0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function Ge(t){for(let e=G0.length-1;e>=0;e--){let o=G0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);Co(o,n),o.age>=o.lifetime&&G0.splice(e,1)}}function Co(t,e){switch(t.type){case R0.EXPLOSION:So(t,e);break;case R0.SCREEN_FLASH:To(t,e);break}}function So(t,e){t.opacity=tt(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=tt(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function To(t,e){let o=1-(1-e)*(1-e);t.opacity=tt(t.startOpacity,t.endOpacity,o)}function bo(){return G0}function ze(t,e,o,n,a){let r=bo();if(r.length!==0){t.save();for(let s of r)ko(t,s,e,o,n,a);t.restore()}}function ko(t,e,o,n,a,r){let s=Do(e.x,e.y,o,n,a,r,e.ignoreBounds);!s&&!e.ignoreBounds||e.renderFunction(t,e,s)}function Do(t,e,o,n,a,r,s=!1){let l=t-r.x,f=e-r.y,{dirY:c,dirX:h,planeY:u,planeX:y,invDet:g}=o,w=g*(c*l-h*f),x=g*(-u*l+y*f);return x<=.1&&!s?null:s?{x:n/2,y:a/2,radius:a,depth:x}:{x:n/2*(1+w/x),y:a/2+64,radius:a/x*.5,depth:x}}function Fo(t,e,o){let n=o.radius*e.radius,a=performance.now()*.001,r=Math.sin(a*8)*12,s=Math.sin(a*12)*.15+1,l=o.y,f=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+r*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(f,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+r}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(f,l,n*s,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+r*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(f,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+r*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(f,l,n*.5,0,2*Math.PI),t.stroke()}function vo(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var $0={[E.entity]:{type:E.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[E.ball]:{type:E.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[E.sparkle]:{type:E.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[E.barrel]:{type:E.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[E.food]:{type:E.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[E.key]:{type:E.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},Rt=null,z0=null;function $e(t,e){Rt=t,z0=e}var V0={[E.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,Rt&&_.push(Rt(E.sparkle,{x:t.x,y:t.y})));let o=i.x-t.x,n=i.y-t.y,a=Math.hypot(o,n);if(a>.3){let r=1*e,s=o/a,l=n/a,f=t.x+s*r,c=t.y+l*r;h0(f,t.y,.4)||(t.x=f),h0(t.x,c,.4)||(t.y=c)}a<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,c0(),M("Ball attacks!"),Y.hurt(),t.hurtCD=.8,It({color:"	#740707",duration:.5}),Lt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(M(u0(["Ball Hit!"])),t.health-=1,Y.killedEntity()):(t.alive=!1,M(u0(["Ball Busted!"])),Y.killedEntity()):M("No arrows.")},onTouch(t){at(E.entity,1e4)&&M("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,Y.killedEntity(),M("The ball is blown to bits.")}},[E.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[E.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=i.x-t.x,n=i.y-t.y,a=Math.hypot(o,n);if(a>.3){let r=1.5*e,s=o/a,l=n/a,f=t.x+s*r,c=t.y+l*r;h0(f,t.y,.4)||(t.x=f),h0(t.x,c,.4)||(t.y=c)}a<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,c0(),M("Entity attacks!"),Y.hurt(),t.hurtCD=.8,It({color:"	#740707",duration:.5}),Lt()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,M(u0(["Entity murdered!","Entity destroyed!","Entity purged!"])),Y.killedEntity()):M("No arrows.")},onTouch(t){at(E.entity,1e4)&&M("You hear something like water nearby...")},onExplode(t){t.alive=!1,Y.killedEntity(),M("The entity is blown to gibs.")}},[E.barrel]:{onHit(t,e){e?(t.alive=!1,z0&&z0(t.x,t.y,2.5),M("Kaboom!"),Y.explode()):M("No arrows.")},onTouch(t){at(E.barrel,1e4)&&M("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,z0&&z0(t.x,t.y,2.5)}},[E.food]:{onTouch(t){t.alive=!1;let e=i.health>=i.maxHealth;e&&(i.maxHealth+=1),i.health=T0(i.health+10,0,i.maxHealth),M(e?"Yummy!":"Health restored."),c0(),Y.pickup()},onExplode(t){}},[E.key]:{onTouch(t){t.alive=!1,i.hasBlueKey=!0,Y.door(),M("Keycard found! Find the exit!"),Ot()},onExplode(t){t.alive=!1,i.hasBlueKey=!0,Y.door(),M("The forcefield protecting the exit has suddenly lifted!"),Ot()}}};Object.freeze($0);for(let t in $0)Object.freeze($0[t]);Object.freeze(V0);for(let t in V0)Object.freeze(V0[t]);var _o=$0,Po=V0,Io=0;function g0(t,e={x:0,y:0},o=void 0){let n=_o[t],a=Po[t],r=Object.assign(Object.create(a),n);return r.id=Io++,r.x=e.x,r.y=e.y,r.dist=0,r.alive=!0,r.hurtCD=0,o&&Object.assign(r,o),r}function Ro(t,e,o){We(t,e,o);for(let n of _){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}$e(g0,Ro);var Ht=0,z=new Set,Oo=0,Bt=!1;function Ue(t){window.addEventListener("keydown",e=>{if(z.add(e.code),_t(),Pt(),e.code==="Space"&&(e.preventDefault(),Ve()),e.code==="KeyM"&&(e.preventDefault(),K.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(i.mouseSensitivity){case .33:M("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .22:M("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break;case .11:M("Mouse sensitivity set to low."),i.mouseSensitivity=.05;break;case .05:M("Mouse sensitivity already lowest."),i.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(i.mouseSensitivity){case .33:M("Mouse sensitivity already set to highest."),i.mouseSensitivity=.33;break;case .22:M("Mouse sensitivity set to highest."),i.mouseSensitivity=.33;break;case .11:M("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .05:M("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>z.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Ve(),Oo=e.clientX,_t(),Pt()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*i.mouseSensitivity);i.a+=n}}),re.onclick=()=>Xo(),ae.onclick=()=>K.classList.toggle("visible")}function Ze(t){let e=z.has("ShiftLeft")||z.has("ShiftRight"),o=i.rotSpeed*t,n=i.accel*t,a=Math.cos(i.a),r=Math.sin(i.a),s=-r,l=a;i.weaponAnim>.75&&(i.weaponAnim=-1),i.weaponAnim>=0&&(i.weaponAnim+=t);let f=3;i.velX-=i.velX*f*t,i.velY-=i.velY*f*t,Math.abs(i.velX)<.002&&(i.velX=0),Math.abs(i.velY)<.002&&(i.velY=0),i.isMoving=!1;let c=0,h=0;z.has("ArrowLeft")&&(i.a-=o),z.has("ArrowRight")&&(i.a+=o),(z.has("ArrowUp")||z.has("KeyW"))&&(c+=a*n,h+=r*n,i.isMoving=!0),(z.has("ArrowDown")||z.has("KeyS"))&&(c-=a*n,h-=r*n,i.isMoving=!0),z.has("KeyA")&&(c-=s*n,h-=l*n,i.isMoving=!0),z.has("KeyD")&&(c+=s*n,h+=l*n,i.isMoving=!0),i.velX+=c,i.velY+=h;let u=Math.hypot(i.velX,i.velY);u>20&&(i.velX*=20/u,i.velY*=20/u);let y=i.x+i.velX*t,g=i.y+i.velY*t;h0(y,i.y,yt)?i.velX=0:i.x=y,h0(i.x,g,yt)?i.velY=0:i.y=g}function Ve(){if(i.weaponAnim>=0)return;i.weaponAnim=0,c0(),Y.shot();let t=K0(),e=Lo(t);!e||W0(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function je(){for(let t of _)!t.alive||Math.hypot(t.x-i.x,t.y-i.y)>=.6||t.onTouch&&t.onTouch(t)}function Ke(){if(Bt)return;let t=i.x|0,e=i.y|0;d.MAP[e][t]===5&&(Y.portal(),M(`Floor ${b0} cleared.`),xt(b0+1),Bt=!0,i.velX=0,i.velY=0,setTimeout(()=>{Yo(!0),Bt=!1},100))}function Lo(t){let o=document.getElementById("view").width>>1|0,n=Q[o]||1e9,a=null,r=1e9;for(let s of _){if(!s.alive)continue;let l=W0(s,t);l&&(i.sightDist>0&&l.depth>i.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<r&&(a=s,r=l.depth))}return a}function q0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(d.MAP_W-2)|0)+1,n=(Math.random()*(d.MAP_H-2)|0)+1;if(d.MAP[n][o]!==0)continue;let a=o+.5-i.x,r=n+.5-i.y;if(!(Math.hypot(a,r)<t))return{x:o,y:n}}return{x:9,y:9}}var Xt=new Map;function Je(){Xt.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=d;for(let a=0;a<n.length;a++){let r=n[a],s=Math.min(r.x,r.x+r.w),l=Math.max(r.x,r.x+r.w)-1,f=Math.min(r.y,r.y+r.h),c=Math.max(r.y,r.y+r.h)-1,h=T0(s,0,t-1),u=T0(l,0,t-1),y=T0(f,0,e-1),g=T0(c,0,e-1),w=[];for(let x=y;x<=g;x++)for(let F=h;F<=u;F++)F0(F,x)||w.push({x:F,y:x});Xt.set(a,w)}}function Ho(t){let e=Xt.get(t);return!e||e.length===0?null:u0(e)}function Ot(){let t=d.MAP_W,e=d.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)d.MAP[o][n]===7&&(d.MAP[o][n]=0)}function Qe(){let t=i0.x,e=i0.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(d.MAP[o][n]=7)}function to(){if(_.length=0,q(100)<50)for(let o=0;o<q(2)*(d.MAP_H/20|0);o++){let n=q0(1);_.push(g0(E.barrel,{x:n.x+.5,y:n.y+.5}))}let t=q0(4);_.push(g0(E.key,{x:t.x+.5,y:t.y+.5})),t=q0(4),_.push(g0(E.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(b0-1)*2)*(d.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=q0(3.5);_.push(g0(E.entity,{x:n.x+.5,y:n.y+.5}))}t=q0(4),_.push(g0(E.ball,{x:t.x+.5,y:t.y+.5})),d.zones.forEach((o,n)=>{let a=n;o.spawnRules?.forEach(s=>{let l=Math.max(0,s.amount|0);for(let f=0;f<l;f++){let c=Ho(a);if(!c)break;_.push(g0(s.entityType,{x:c.x+.5,y:c.y+.5}))}})})}function c0(){te.style.width=`${i.health/i.maxHealth*100}%`,ee.style.width=`${i.ammo/60*100}%`,oe.textContent=Math.max(0,i.health),ne.textContent=i.ammo}var Yt=0,Nt=0,Wt=!1,qe=!1;function M(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let r=n.innerHTML,s=r.match(/^(.*?)(?:\s+x(\d+))?$/),l=s?s[1]:r,f=s&&s[2]?parseInt(s[2]):1;if(l===t){let c=s&&s[2]?f+1:2;n.innerHTML=`${t} x${c}`;return}}let a=document.createElement("div");a.innerHTML=t,o.prepend(a),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function eo(t){Yt>0&&(Yt-=t,Yt<=0&&(ie.textContent=i.hasBlueKey?"Find the exit.":"Find the key card."))}function Lt(){Wt||i.health<=0&&(Wt=!0,i.speed=0,i.rotSpeed=0,Nt=2,M("YOU DIED! Soul disconnecting from the node..."))}function oo(t){Wt&&(Nt-=t,Nt<=0&&Bo())}function Bo(){if(qe)return;qe=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",a=>{a.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),z.clear()}}function Gt(t=!1){t&&O0(),i.x=m0.x,i.y=m0.y,i.a=0,i.hasBlueKey=!1,d.MAP[i0.y][i0.x]=5,Qe(),to(),c0(),M(`Floor ${b0}: Find the keycard.`)}function Yo(t=!1){t&&(Ht>=Y0.length-1?O0():(Ht+=1,O0(Ht))),i.x=m0.x,i.y=m0.y,i.a=0,i.hasBlueKey=!1,d.MAP[i0.y][i0.x]=5,Qe(),to(),c0(),M(`Floor ${b0}: Find the keycard.`)}function Xo(){xt(1),O0(0),Gt()}function no(t){for(let e of _)e.alive&&e.ai&&e.ai(e,t)}var ct=performance.now(),lt=new Map;function at(t,e=0){if(e===0)return!(ct<lt.get(t));let o=ct,n=lt.get(t)??0;return o<n?!1:(lt.set(t,o+e),!0)}function ar(t){lt.set(t,performance.now())}var zt=m>>1;Ue(H0);var st=0;function No(t){let e=`FPS: ${Math.round(t)}`;p.save(),p.font="12px monospace",p.textAlign="right",p.textBaseline="top";let o=A-8,n=6,a=p.measureText(e).width+8,r=16;p.fillStyle="rgba(10, 15, 25, 0.6)",p.fillRect(o-a,n-2,a,r),p.strokeStyle="rgba(60, 80, 130, 0.9)",p.strokeRect(o-a+.5,n-2+.5,a-1,r-1),p.fillStyle="#dfe6ff",p.fillText(e,o,n),p.restore()}function O0(t=-1){let e;if(t!==-1){let o=Y0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=u0(Y0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}i0.x=e.exitPos.x,i0.y=e.exitPos.y,m0.x=e.startPos.x,m0.y=e.startPos.y,i.sightDist=e.sightDist||de,d.cielingColorFront=e.cielingColorFront||"#6495ED",d.floorColorFront=e.floorColorFront||"#054213",d.cielingColorBack=e.cielingColorBack||"#6495ED",d.floorColorBack=e.floorColorBack||"#03210A",d.MAP=e.mapLayout,d.MAP_W=d.MAP[0].length,d.MAP_H=d.MAP.length,d.zones=e.zones,Je(),Te(),ke(),kt(),i.x=i.x=e.startPos.x,i.y=e.startPos.y}async function Wo(){await Re(),await ge(),O0(0),Gt(),i.maxHealth=20+q(6),i.health=i.maxHealth,i.ammo=5+q(5),c0(),requestAnimationFrame(io)}function Go(t){let e=K0();if(d.zones.length<=2)be(p);else{for(let o=0;o<A;o++)Fe(t,e,o,0);Pe(p)}if(d.zones.length<=2){let o=i.x|0,n=i.y|0,a=t0[n*d.MAP_W+o],r=rt[a];if(!r){let s=d.zones[a].fogColor;r=p.createLinearGradient(0,m,0,zt),r.addColorStop(0,d.floorColorFront||"#054213"),r.addColorStop(.85,d.floorColorBack||"#03210A"),r.addColorStop(.95,s||n0),rt[a]=r}p.fillStyle=r,p.fillRect(0,zt,A,zt)}else{for(let o=0;o<A;o++)De(t,e,o,0);_e(p)}ve(p),Ie(t,e,d.MAP,d.MAP_W,d.MAP_H),zo(),_.sort((o,n)=>n.dist-o.dist),$o(e),Uo(t),ze(p,e,A,m,i)}function zo(){for(let t of _){let e=t.x-i.x,o=t.y-i.y;t.dist=e*e+o*o}}function $o(t){p.save();for(let e of _){if(!e.alive||Math.hypot(e.x-i.x,e.y-i.y)>i.sightDist)continue;let n=W0(e,t);if(!n||i.sightDist>0&&n.depth>i.sightDist)continue;let a=3,r=0;for(let l=0;l<a;l++){let f=n.drawStartX+l*(n.drawEndX-n.drawStartX)/(a-1);n.depth<=Q[Math.floor(f)]&&r++}if(r===0)continue;let s=Vo(n);qo(e,n,s),p.filter="none"}p.restore()}function Vo(t){let e=1/(1+t.depth*.3);if(i.sightDist>0&&t.depth>i.sightDist*P0){let a=i.sightDist*P0,r=Math.min(1,Math.max(0,(t.depth-a)/Math.max(1e-6,i.sightDist-a)));e*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((a,r)=>Math.abs(r-e)<Math.abs(a-e)?r:a,o[0])}}function qo(t,e,o){o.quantizedShade<.999&&(p.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),a=e.drawStartY,r=e.drawEndY-e.drawStartY,s=c=>(c-e.drawStartX)*S[t.img].width/n|0,l=-1,f=0;for(let c=e.drawStartX;c<=e.drawEndX;c++){let u=c>=0&&c<A&&c<e.drawEndX&&e.depth<=Q[c];if(u&&l===-1&&(l=c,f=s(c)),(!u||c===e.drawEndX)&&l!==-1){let y=c,g=y-l,w=s(y);w<=f&&(w=f+1);let x=Math.min(S[t.img].width-f,w-f);g>0&&x>0&&r>0&&p.drawImage(S[t.img],f,0,x,S[t.img].height,l,a,g,r),l=-1}}}function Uo(t){if(!S.pitchfork)return;let e=Math.round(A*.42),o=Math.round(e*(S.pitchfork.height/S.pitchfork.width)),n=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*5):0,a=Math.max(8,A*.02|0),r=A*.5-e/2-a/2+n,s=(i.weaponAnim+1)**10,l=s>7?7:s,f=i.weaponAnim>=0?100-l*20:0,c=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*10):0,h=m-o-a+70+c+f;p.drawImage(S.pitchfork,r,h,e,o)}function io(t){let e=Math.min(.05,(t-ct)/1e3);ct=t;let o=e>0?1/e:0;st=st?st*.9+o*.1:o,Ze(e),no(e),Ge(e),je(),Go(t/1e3),K.classList.contains("visible")&&He(_),Ke(),eo(e),oo(e),No(st),pt.drawImage(dt,0,0),requestAnimationFrame(io)}await Wo().catch(console.error);export{O0 as ChangeMapLevel,ar as resetCooldown,at as tryCooldown};
