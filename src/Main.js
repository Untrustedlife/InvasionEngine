import{a as Ct,b as He,c as C}from"../chunks/chunk-75YVQ3JR.js";var Jt=document.getElementById("view");Jt.width=480;Jt.height=270;var _=480,m=270,z0=new OffscreenCanvas(_,m),p=z0.getContext("2d",{colorSpace:"srgb"});p.imageSmoothingEnabled=!1;var G0=Jt.getContext("2d",{colorSpace:"srgb"});G0.imageSmoothingEnabled=!1;Jt.style.filter="brightness(1.15) contrast(1.06)";var gt=document.getElementById("mini"),$=gt.getContext("2d");$.imageSmoothingEnabled=!1;var Be=document.getElementById("hpBar"),Ye=document.getElementById("ammoBar"),Ne=document.getElementById("hpText"),Xe=document.getElementById("ammoText"),We=document.getElementById("msg"),ze=document.getElementById("btnReset"),Ge=document.getElementById("btnToggleMap");var qo=90*Math.PI/180,V0=qo*.5,$0=.01,S0=.01,Ze=15;var a0=.6,At="#101b2e";var i={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,mouseSensitivity:.22,height:1.2,calculatePlayerHeight:()=>{if(2-i.height<.01)return .01;let t=i.getCurrentFloorDepth?i.getCurrentFloorDepth():0;return(2-i.height-t)*1},getCurrentZoneId:()=>i._currentZoneId||0,getCurrentFloorDepth:()=>i._currentFloorDepth||0,_currentZoneId:0,_currentFloorDepth:0},U0=.2,Gt=1,je=1,Vo=99;function Z0(t){Gt=Math.max(je,Math.min(Vo,t|0||je))}function T0(){let t=Math.cos(i.a),e=Math.sin(i.a),o=-e*Math.tan(V0),n=t*Math.tan(V0),r=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:r}}var Ke=[{index:1,image:"OfficeWall.png"},{index:2,image:"Panel.png"},{index:3,image:"Hedge.png"},{index:4,image:"OfficeDoor.png"},{index:5,image:"Portal.png"},{index:6,image:"OfficeDoorBlue.png"},{index:7,image:"Field.png"},{index:8,image:"OfficeWall.png"},{index:9,image:"OfficeDoorBlue.png"}],j0={0:0,1:1,2:1,3:1,4:1,5:1,6:1,7:1,8:3,9:3};function $o(t=64,e=64){return new OffscreenCanvas(t,e)}var ct=new Array(8).fill(null);function Je(t){let o=t.getContext("2d").getImageData(0,0,t.width,t.height),n=[];for(let r=0;r<t.width;r++){let s=new Uint8ClampedArray(t.height*4);for(let a=0;a<t.height;a++){let l=(a*t.width+r)*4,c=a*4;s[c]=o.data[l],s[c+1]=o.data[l+1],s[c+2]=o.data[l+2],s[c+3]=o.data[l+3]}n.push({data:s,h:t.height})}return{cols:n,w:t.width,h:t.height}}var qt=ct.map(t=>t?Je(t):null);function Uo(){qt.length=0,ct.forEach(t=>{qt.push(t?Je(t):null)})}var D0=Array.from({length:82},(t,e)=>e*.0125),b0={};function Zo(){for(let t=1;t<ct.length;t++)if(ct[t]){b0[t]={};for(let e of D0){let o=new OffscreenCanvas(ct[t].width,ct[t].height),n=o.getContext("2d");n.drawImage(ct[t],0,0);let r=e*255|0;n.globalCompositeOperation="multiply",n.fillStyle=`rgb(${r},${r},${r})`,n.fillRect(0,0,o.width,o.height),b0[t][e]=o}}}async function jo(t){let e=`../assets/gfx/${t}`;return new Promise((o,n)=>{let r=new Image;r.onload=()=>{let s=$o(64,64),a=s.getContext("2d",{willReadFrequently:!0});a.imageSmoothingEnabled=!1,a.drawImage(r,0,0,64,64),o(s)},r.onerror=()=>n(new Error(`Failed to load texture: ${e}`)),r.src=e})}async function Qe(){try{await Ko(Ke),Uo(),Zo()}catch(t){console.warn("Failed to init wall textures:",t)}}async function Ko(t){if(!Array.isArray(t)){console.warn("Expected an array of { index, image } objects. In loadImagesToReplaceTextures");return}let e=t.map(async(o,n)=>{let{index:r,image:s}=o||{};try{let a=await jo(s);return r&&r>=0&&(ct[r]=a),a}catch(a){return console.warn(`Failed to load texture "${s}" for index ${r} and dont support replacing with cool gmod missing texture:`,a),null}});await Promise.all(e)}var to=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{x:0,y:0,w:1,h:1,color:"#054213",cielingColorFront:"#6495ed",spawnRules:[]},{x:0,y:2,w:20,h:2,color:"#0011ff",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",spawnRules:[],floorDepth:-.5,isLiquid:!0},{x:3,y:5,w:14,h:12,color:"#8b8000",cielingColorFront:"#8b8000",cielingColorBack:"#00000000",ceilingHeight:6,floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5},{entityType:"food",amount:2}]},{x:1,y:0,w:18,h:19,color:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];function Ot(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=ft(t.length)-1;return t[e]}function ft(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function F0(t,e,o){return t+(e-t)*o}function eo(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,r=o-1;for(;n<=r;){let s=n+r>>1,a=t[s];if(a===e)return s;a<e?n=s+1:r=s-1}return e-t[r]<=t[n]-e?r:n}function K0(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var St={x:10,y:8},Lt={x:3.5,y:3.5};var f={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},l0=to,oo=new Map;function io(t){let e=f.zones,o=e&&e[t]?.color||At,n=oo.get(o);return n||(n=K0(o),oo.set(o,n)),n}var no=new Map;function ro(t){let e=f.zones,o=e&&e[t]?.cielingColorFront||At,n=no.get(o);return n||(n=K0(o),no.set(o,n)),n}function so(t,e,o){for(let n=0;n<o.length;n++){let r=o[n],s=Math.min(r.x,r.x+r.w),a=Math.max(r.x,r.x+r.w)-1,l=Math.min(r.y,r.y+r.h),c=Math.max(r.y,r.y+r.h)-1;if(t>=s&&t<=a&&e>=l&&e<=c)return n}return 0}var dt=new Float32Array(_),G=m>>1,c0=new Int16Array(_).fill(G),et=new Int16Array(_).fill(G),Qt=new Float32Array(m),te=new Float32Array(m),t0={},e0={},J0=G;function f0(){for(let r in e0)delete e0[r];for(let r in t0)delete t0[r];let t=i.calculatePlayerHeight(),o=2-0,n=m*(o-t)*.5;for(let r=0;r<m;r++){let s=r-J0;Qt[r]=s!==0?n/s:1e-6;let l=2-2,c=m*(l+t)*.5;te[r]=s!==0?-c/s:-1e-6}for(let r=0;r<f.zones.length;r++){let s=f.zones[r];if(s.ceilingHeight!==void 0){e0[r]=new Float32Array(m);for(let a=0;a<m;a++){let l=a-J0,u=s.ceilingHeight-2,d=m*(u+t)*.5;e0[r][a]=l!==0?-d/l:-1e-6}}if(s.floorDepth!==void 0){let l=2-s.floorDepth,c=m*(l-t)*.5;t0[r]=new Float32Array(m);for(let u=0;u<m;u++){let d=u-J0;t0[r][u]=d!==0?c/d:1e-6}}}}f0();var ee=[],oe=[],ne=[],_0=[],j=[],ie=[];function ao(){ee.length=0,oe.length=0,ne.length=0,_0.length=0,ie.length=0,re.clear(),se.clear()}function Ht(t,e,o,n,r,s,a,l,c,u){if(!r)return;let d=n-o;if(d<=0)return;let A=l||0,x=A<0?0:A>r.height?r.height:A,g=c||r.height,w=r.height-x,h=g<0?0:g>w?w:g,T=eo(D0,a);t.drawImage(b0[u][D0[T]],s,x,1,h,e,o,1,d)}function lo(t){let e=i.x|0,o=i.y|0,n=j[o*f.MAP_W+e],r=ee[n];if(!r){r=t.createLinearGradient(0,0,0,G);let s=f.zones[n].cielingColorFront,a=f.zones[n].cielingColorBack,l=f.zones[n].fogColor;r.addColorStop(0,s||f.cielingColorFront||"#6495ED"),f.cielingColorBack&&r.addColorStop(.5,a||f.cielingColorBack||"#6495ED"),r.addColorStop(.9,l||At),ee[n]=r}t.fillStyle=r,t.fillRect(0,0,_,G)}var re=new Map;function Q0(t){let e=re.get(t);if(!e){let[o,n,r]=io(t);e=`rgb(${o|0},${n|0},${r|0})`,re.set(t,e)}return e}var se=new Map;function k0(t){let e=se.get(t);if(!e){let[o,n,r]=ro(t);e=`rgb(${o|0},${n|0},${r|0})`,se.set(t,e)}return e}function co(){j.length=0;let t=f.zones,e=f.MAP_W,o=f.MAP_H;for(let n=0;n<o;n++)for(let r=0;r<e;r++)j[n*e+r]=so(r,n,t)}function fo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e;n=c0[o]??G;let c=n<G?G:n;if(c>=m)return;let u=2*(o+.5)/_-1,d=r+a*u,A=s+l*u;if(i.sightDist>0){let k=dt[o]??1/0;for(;c<m;){let b=Qt[c]??1/0;if(b<=i.sightDist&&b<=k)break;c++}if(c>=m)return}let x="#000000",g=f.MAP_W,w=f.MAP_H,h=1/(r*d+s*A),T=d*h,I=A*h,y=0;function D(k,b=0){let H=Qt[k]??Qt[Qt.length-1]??1/0,X=i.x+T*H,F=i.y+I*H,rt=X|0,R=F|0;return rt>=0&&R>=0&&rt<g&&R<w?j[R*g+rt]:0}let P=k=>Math.max(8,Math.min(64,8+(k-G>>>3)));y=D(c,y);let E=c,O=null;for(;c<m;){let k=Math.min(P(c),m-1-c);if(k<=0)break;let b=c+k;if(D(b,y)===y){let V=c+b>>1;if(D(V,y)===y){let pt=Q0(y);pt!==O&&(p.fillStyle=pt,O=pt);let W=b+1-E;W>0&&p.fillRect(o,E,1,W),c=b+1,E=c;continue}}let X=c,F=b;for(;F-X>1;){let V=X+F>>1;D(V,y)===y?X=V:F=V}let rt=Q0(y);rt!==O&&(p.fillStyle=rt,O=rt);let R=F-E;R>0&&p.fillRect(o,E,1,R);let st=D(F,y),i0=f.zones[y]?.floorDepth??0,y0=f.zones[st]?.floorDepth??0,x0=c0[o]??G,Nt=Qt[F]??1/0,w0=dt[o]??1/0,Se=F===x0,E0=Nt>=w0-.11;if(!!x&&i0!==y0&&!Se&&!E0&&!(E===x0)){let V=f.zones[y]||{},pt=f.zones[st]||{},W=V.floorDepth??0,kt=pt.floorDepth??0,Q=!!V.isLiquid,H0=!!pt.isLiquid,U=0;if(Q||H0)U=W>kt?5:1;else{let B0=Math.abs(W-kt),_t=t0?.[y]?.[F],Xt=t0?.[st]?.[F],at=Nt;(Number.isFinite(_t)||Number.isFinite(Xt))&&(at=Math.min(_t??1/0,Xt??1/0,Nt??1/0),Number.isFinite(at)||(at=Nt));let yt=m*B0*.5/Math.max(.001,at);U=Math.max(1,yt|0),U=W>kt?U:2}let Zt=F,r0=Math.min(m,Zt+U);r0>Zt&&(p.fillStyle!==x&&(p.fillStyle=x),p.fillRect(o,Zt,1,r0-Zt)),O=null,y=st,c=r0,E=c;continue}y=st,c=F,E=c}if(E<m){let k=Q0(y);k!==O&&(p.fillStyle=k),p.fillRect(o,E,1,m-E)}}function uo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e,c=et[o]??G,u=0;if(c<=0)return;let d=2*(o+.5)/_-1,A=r+a*d,x=s+l*d,g=1/(r*A+s*x),w=0,h=e0?.[w]?.[u]??te[u],T=i.x+A*h*g,I=i.y+x*h*g,y=u,D=null;for(let E=u;E<c;E++){if(i.sightDist>0&&Math.abs(h)>i.sightDist){let F=k0(w);F!==D&&(p.fillStyle=F),p.fillRect(o,y,1,E-y);return}if(h>dt[o]){let F=k0(w);F!==D&&(p.fillStyle=F),p.fillRect(o,y,1,E-y);return}let O=T|0,k=I|0,b=O>=0&&k>=0&&O<f.MAP_W&&k<f.MAP_H?j[k*f.MAP_W+O]:w;if(b!==w){let F=k0(w);F!==D&&(p.fillStyle=F,D=F),p.fillRect(o,y,1,E-y),w=b,y=E}let H=e0?.[w]?.[E+1]??te[E+1]??h,X=H-h;T+=A*X*g,I+=x*X*g,h=H}let P=k0(w);P!==D&&(p.fillStyle=P),p.fillRect(o,y,1,c-y)}function po(t){let e=ne[0];e||(e=t.createLinearGradient(0,0,0,m),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),ne[0]=e),t.fillStyle=e,t.fillRect(0,0,_,m)}function ho(t){let e=G-1,o=m-e,n=i.x|0,r=i.y|0,s=j[r*f.MAP_W+n],a=oe[s];if(!a){let l=f.zones[s].floorColorBack;a=t.createLinearGradient(0,e,0,m),a.addColorStop(.05,f.zones[s].fogColor||At),a.addColorStop(.15,l||f.floorColorBack||"#03210A"),a.addColorStop(1,"rgba(0,0,0,0)"),oe[s]=a}t.fillStyle=a,t.fillRect(0,e,_,o)}function mo(t){let o=G+1,n=i.x|0,r=i.y|0,s=j[r*f.MAP_W+n],a=ie[s];if(!a){let l=f.zones[s].fogColor||At,c=f.zones[s].cielingColorBack||f.cielingColorBack||"#6495ED";a=t.createLinearGradient(0,0,0,0+o),a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(.85,c),a.addColorStop(.95,l),ie[s]=a}t.fillStyle=a,t.fillRect(0,0,_,o)}function go(t,e,o,n,r){let{dirX:s,dirY:a,planeX:l,planeY:c}=e;function u(d,A,x,g){if(i.sightDist<=0)return;let w=i.sightDist*a0,h=i.sightDist;if(g<=w)return;let T=A|0,I=x|0;if(T<0&&(T=0),I>m&&(I=m),I<=T)return;let y=Math.min(1,Math.max(0,(g-w)/Math.max(1e-6,h-w))),D=i.x|0,P=i.y|0,E=j.length>0?j[P*f.MAP_W+D]|0:0;p.save(),p.globalAlpha=y*.85,p.fillStyle=f.zones[E].fogColor||At,p.fillRect(d,T,1,I-T),p.restore()}for(let d=0;d<_;d++){let A=2*(d+.5)/_-1,x=s+l*A,g=a+c*A;if(x<1e-8&&x>-1e-8&&g<1e-8&&g>-1e-8){dt[d]=Number.POSITIVE_INFINITY,c0[d]=G,et[d]=G;continue}let w=1/(x||1e-9),h=1/(g||1e-9),T=i.x|0,I=i.y|0,y=w<0?-w:w,D=h<0?-h:h,P,E,O,k;x<0?(P=-1,O=(i.x-T)*y):(P=1,O=(T+1-i.x)*y),g<0?(E=-1,k=(i.y-I)*D):(E=1,k=(I+1-i.y)*D);let b=0,H=1,X=!1,F=0,rt=0;for(;!X&&F++<256;){if(O<k?(O+=y,T+=P,b=0):(k+=D,I+=E,b=1),i.sightDist>0){let q=Math.min(O,k);if(q>i.sightDist){X=!1,H=0,rt=q;break}}if(T<0||I<0||T>=n||I>=r){X=!0,H=1;break}let M=o[I][T];if(M>0){X=!0,H=M;break}}if(H===0){dt[d]=Number.POSITIVE_INFINITY,c0[d]=G,et[d]=G;continue}let R;b===0?R=O-y:R=k-D,R=$0>R?$0:R;let st=0,i0=b===0?P:0,y0=b===1?E:0,E0=Math.abs(i0*s+y0*a)>=.9&&Math.abs(A)<=.9&&R<st?st:R,O0=i.x+E0*x,L0=i.y+E0*g,V;b===0?V=L0-(L0|0):V=O0-(O0|0),V=V<0?0:V>.999999?.999999:V+1e-6;let pt=qt[H]||qt[4],W=ct[H],kt=W?W.width|0:pt.w|0,Q=V*kt|0;(b===0&&P>0||b===1&&E<0)&&(Q=kt-Q-1),Q=Q<0?0:Q>=kt?kt-1:Q;let H0=R<S0?S0:R,U=m/H0|0,Zt=i.calculatePlayerHeight(),r0=G,B0=m*(2-Zt)*.5,_t=(m-U*i.calculatePlayerHeight())/2|0,Xt=_t+U,at=_t,yt=Xt;at<0&&(at=0),yt>m&&(yt=m);let Te=yt-at;c0[d]=yt;let lt=j0[H]||1;et[d]=at*lt;let Wo=yt-U*(lt>0?lt:1);if(et[d]=Wo,Te<=0){dt[d]=R;continue}let be=(W?W.height:pt.h||ct[H]?.height||64)|0,De=(at-_t)*(be/(U>1?U:1)),Fe=Te*(be/Math.max(1,U)),jt=1/(1+R*.25)*(b?.5:1);if(H===7&&(jt*=.8+.2*Math.sin(t*6+d*.05)),lt==1)Ht(p,d,at,yt,W,Q,jt,De,Fe,H);else if(lt>1){Ht(p,d,at,yt,W,Q,jt,De,Fe,H);let M=U,q=(W?.height||pt.h||64)|0,J=q/Math.max(1,M),xt=Math.floor(lt)-1;for(let z=0;z<xt;z++){let wt=_t-M*(z+1),Z=Xt-M*(z+1),B=Math.max(0,Math.ceil(wt)),Et=Math.min(m,Math.floor(Z)),Mt=Et-B;if(Mt<=0)continue;let tt=(B-wt)*J,ht=Mt*J;Ht(p,d,B,Et,W,Q,jt,tt,ht,1)}let vt=lt-(1+xt);if(vt>1e-6){let z=M*vt,wt=_t-M*xt,Z=wt-z,B=Math.max(0,Math.ceil(Z)),Et=Math.min(m,Math.floor(wt)),Mt=Et-B;if(Mt>0){let tt=wt-M,ht=(B-tt)*J%q;ht<0&&(ht+=q);let _e=Mt*J;Ht(p,d,B,Et,W,Q,jt,ht,_e,1)}}}else if(lt<1){let M=U,q=(W?.height||pt.h||64)|0,J=q/Math.max(1,M),xt=lt;if(xt>1e-6){let vt=M*xt,z=Xt,wt=z-vt,Z=Math.max(0,Math.ceil(wt)),B=Math.min(m,Math.floor(z)),Et=B-Z;if(Et>0){let Mt=z-M,tt=(Z-Mt)*J%q;tt<0&&(tt+=q);let ht=Et*J;Ht(p,d,Z,B,W,Q,jt,tt,ht,H)}}}{let M=yt-U*(lt>0?lt:1),q=Math.max(0,Math.ceil(M)),J=Math.min(m,Xt);u(d,q,J,R)}let ke=lt;if((et[d]|0)>0){let M=et[d]|0,q=T,J=I,xt=O,vt=k,z=b,wt=0;for(;M>0&&wt++<i.sightDist-R&&(xt<vt?(xt+=y,q+=P,z=0):(vt+=D,J+=E,z=1),!(q<0||J<0||q>=n||J>=r));){let Z=o[J][q]|0;if(Z<=0)continue;let B=z===0?xt-y:vt-D;if(i.sightDist>0&&B>i.sightDist)break;let Et=Math.max(S0,B),Mt=m/Et|0,tt=j0[Z];if(tt<=ke)continue;let ht=r0+B0/B;if(!(ht-Mt*tt<M))continue;let ve=i.x+B*x,Ie=i.y+B*g,zo=z===0?Ie-(Ie|0):ve-(ve|0),Wt=ct[Z],Re=qt[Z]||qt[4],M0=Wt?Wt.width|0:Re.w|0,Dt=zo*M0|0;(z===0&&P>0||z===1&&E<0)&&(Dt=M0-Dt-1),Dt<0&&(Dt=0),Dt>=M0&&(Dt=M0-1);let Y0=(Wt?Wt.height:Re.h||64)|0,N0=1/(1+B*.25)*(z?.5:1),zt=Mt,Kt=Y0/Math.max(1,zt),C0=ht-zt,Pe=ht,Y=C0,mt=Math.min(M,Pe),It=mt-Y;if(It>0){let Rt=(Y-C0)*Kt,Pt=It*Kt;Ht(p,d,Y,mt,Wt,Dt,N0,Rt,Pt,Z),Y<M&&(M=Y,M<(et[d]|0)&&(et[d]=M)),u(d,Y,mt,B)}let X0=Math.floor(tt)-1;for(let Rt=0;Rt<X0&&M>0;Rt++){let Pt=C0-zt*(Rt+1),Le=Pe-zt*(Rt+1);if(Y=Pt,mt=Math.min(M,Le)+1,It=mt-Y,It<=0)continue;let W0=(Y-Pt)*Kt,s0=It*Kt;Ht(p,d,Y,mt,Wt,Dt,N0,W0,s0,Z),Y<M&&(M=Y,M<(et[d]|0)&&(et[d]=M)),u(d,Y,mt,B)}let Oe=tt-(1+X0);if(Oe>1e-6&&M>0){let Rt=zt*Oe,Pt=C0-zt*Math.max(0,X0);if(Y=Pt-Rt,mt=Math.min(M,Pt),It=mt-Y,It>0){let W0=Pt-zt,s0=(Y-W0)*Kt%Y0;s0<0&&(s0+=Y0);let Go=It*Kt;Ht(p,d,Y,mt,Wt,Dt,N0,s0,Go,Z),Y<M&&(M=Y,M<(et[d]|0)&&(et[d]=M)),u(d,Y,mt,B)}}ke=tt}}dt[d]=R}}var v={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function Tt(t,e){return await Jo(t,e,1)}async function Jo(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((r,s)=>{let a=new Image;a.onload=()=>{let l=new OffscreenCanvas(a.width*e,a.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(a,0,0,l.width,l.height),l.baseline=o,l.scale=e,r(l)},a.onerror=()=>s(new Error(`Failed to load sprite: ${n}`)),a.src=n})}async function yo(){v.food=await Tt("noodles.png",3),v.bow=await Tt("bow.png",3),v.pitchfork=await Tt("pitchfork.png",3),v.keycard1=await Tt("keycard1.png",3),v.barrel=await Tt("emp.png",3),v.aiDrone1=await Tt("aiDrone1.png",3),v.aiDrone2=await Tt("aiDrone2.png",3),v.aiDrone3=await Tt("aiDrone3.png",3),v.ball=await Tt("Palantrash1.png",3),v.sparkle=await Tt("sparkle.png",3)}var N=[];function Qo(t){return m/t}function tn(t,e,o){let{dirY:n,dirX:r,planeY:s,planeX:a,invDet:l}=o,c=l*(n*t-r*e),u=l*(-s*t+a*e);return{transX:c,transY:u}}function en(t,e){return Math.round((_>>1)*(1+t/e))}function d0(t,e){let o=t.x-i.x,n=t.y-i.y,{transX:r,transY:s}=tn(o,n,e);if(s<=.01)return null;let a=en(r,s),l=t&&typeof t.scale=="number"?t.scale:t&&v[t.img]&&typeof v[t.img].scale=="number"?v[t.img].scale:1,c=Qo(s)*l,u=typeof t._hR=="number"?t._hR:Math.round(c),d=.1,A=u;(c>u+d||c<u-d)&&(A=Math.round(c)),t._hR=A;let x=A,g=v[t.img],w=g&&g.width&&g.height?g.width/g.height:1,h=Math.max(1,Math.round(x*w)),T=i.calculatePlayerHeight(),I=m*.5,y=0,D,P;if(t.ground){let b=t.floorBiasFrac??.04,H=j[(t.y|0)*f.MAP_W+(t.x|0)],X=f.zones[H],F=2-(X.floorDepth||0),rt=I+m*(F-T)/(2*s)-b*x,R=rt-x;if(D=Math.round(R),P=Math.round(rt),X&&X.isLiquid){let st=X.floorDepth??0;if(st<0){let i0=st<0?-st:0,Nt=Ct(i0/1.2,0,1),w0=Ct(Nt,0,1);y=Math.min(x-1,Math.round(x*w0))}}}else{let b=Math.round(I-x*.5);D=b,P=b+x}let E={startY:D,endY:P},O=Math.round(a-(h>>1)),k=O+h;return{drawStartX:O,drawEndX:k,drawStartY:E.startY,drawEndY:E.endY,depth:s,size:x,width:k-O,occludedBottom:y}}var xo={0:"#0c1220",1:"#ECDE60",2:"#707a88",3:"#00e676",4:"#996633",5:"#FFE300",6:" #3561ff",7:"#00FFFF"},ae={[C.entity]:"#ffeb9c",[C.barrel]:"#CD1C18",[C.key]:"#6aa2ff",[C.food]:"#7fffd4",default:"#ffffff"};var ut=6,Vt=20,bt=2,wo=Math.floor(Vt/2);gt.width=bt+Vt*ut+bt;gt.height=bt+Vt*ut+bt;function Eo(t){$.clearRect(0,0,gt.width,gt.height);let e=Math.max(0,Math.min((i.x|0)-wo,f.MAP_W-Vt)),o=Math.max(0,Math.min((i.y|0)-wo,f.MAP_H-Vt));for(let l=0;l<Vt;l++)for(let c=0;c<Vt;c++){let u=o+l,d=e+c,A=f.MAP[u]?.[d]??0,x=xo[A]||"#000000";$.fillStyle=x,$.fillRect(bt+c*ut,bt+l*ut,ut-1,ut-1)}for(let l of t){if(!l.alive)continue;let c=bt+(l.x-e)*ut,u=bt+(l.y-o)*ut;$.fillStyle=ae[l.type]||ae.default,$.fillRect(c-2,u-2,4,4)}let n=bt+(i.x-e)*ut,r=bt+(i.y-o)*ut;$.fillStyle="#e7f3ff",$.beginPath(),$.arc(n,r,2.5,0,He),$.fill();let s=Math.cos(i.a),a=Math.sin(i.a);$.strokeStyle="#78f3d3",$.beginPath(),$.moveTo(n,r),$.lineTo(n+s*1.5*ut,r+a*1.5*ut),$.stroke()}var L=null,$t=null,nt=null,le=null,Mo=null;function fe(){L||(L=new(window.AudioContext||window.webkitAudioContext))}function ot({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:r=0}){if(!L)return;let s=L.createOscillator(),a=L.createGain();s.type=o,s.frequency.value=t,a.gain.value=n,s.connect(a).connect(L.destination);let l=L.currentTime;r&&(s.frequency.setValueAtTime(t,l),s.frequency.linearRampToValueAtTime(t+r,l+e)),a.gain.setValueAtTime(n,l),a.gain.exponentialRampToValueAtTime(.001,l+e),s.start(l),s.stop(l+e)}function ce({dur:t=.2,vol:e=.2,lp:o=1200}){if(!L)return;let n=L.createBuffer(1,L.sampleRate*t,L.sampleRate),r=n.getChannelData(0);for(let u=0;u<r.length;u++)r[u]=Math.random()*2-1;let s=L.createBufferSource(),a=L.createGain(),l=L.createBiquadFilter();s.buffer=n,a.gain.value=e,l.type="lowpass",l.frequency.value=o,s.connect(l).connect(a).connect(L.destination);let c=L.currentTime;s.start(c),s.stop(c+t)}var K={shot:()=>{let t=ft(50),e=-ft(50);ot({freq:220+t+e,dur:.05+ft(3)/100,type:"square",vol:.25,slide:120}),ce({dur:.03+ft(3)/100,vol:.15,lp:800})},pickup:()=>{ot({freq:880,dur:.06,type:"triangle",vol:.2}),ot({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{ce({dur:1,vol:.3,lp:800}),ot({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{ot({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;ot({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),ot({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),ot({freq:90,dur:.08,type:"sine",vol:.18}),ce({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{ot({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{ot({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{ot({freq:600,dur:.5,type:"sawtooth",vol:.2}),ot({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),ot({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function on(t,{volume:e=.15}={}){if(L)try{if(!le||t!==Mo){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();le=await L.decodeAudioData(n),Mo=t}Co(),nt=L.createBufferSource(),nt.buffer=le,nt.loop=!0,$t=L.createGain(),$t.gain.value=e,nt.connect($t).connect(L.destination),nt.start()}catch(o){try{Co();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),nt={stop:()=>n.pause(),disconnect:()=>{}},$t=null}catch(n){}}}function Co(){try{nt&&nt.stop(0)}catch(t){}if(nt&&nt.disconnect)try{nt.disconnect()}catch(t){}if($t)try{$t.disconnect()}catch(t){}nt=null,$t=null}var Ao=!1;async function de(){if(!L||nt||Ao)return;Ao=!0,await on("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function Ut(t,e){if(t<0||e<0||t>=f.MAP_W||e>=f.MAP_H)return!0;let o=f.MAP[e|0][t|0];return o===0||o===5?!1:o===7?!i.hasBlueKey:!(o===6||o===9)}function Bt(t,e,o){return!!(Ut(t,e)||Ut(t-o,e)||Ut(t+o,e)||Ut(t,e-o)||Ut(t,e+o))}var o0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},nn={[o0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:dn,ignoreBounds:!1},[o0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:un,ignoreBounds:!0}},u0=[];function So(t,e,o,n,r={}){let s=nn[t];if(!s)return console.warn(`Unknown effect type: ${t}`),null;let a={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:r.lifetime??s.lifetime,opacity:r.startOpacity??s.startOpacity,startOpacity:r.startOpacity??s.startOpacity,endOpacity:r.endOpacity??s.endOpacity,...s,...r};return u0.push(a),a}function To(t,e,o,n={}){return So(o0.EXPLOSION,t,e,o,n)}function ue({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){So(o0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function bo(t){for(let e=u0.length-1;e>=0;e--){let o=u0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);rn(o,n),o.age>=o.lifetime&&u0.splice(e,1)}}function rn(t,e){switch(t.type){case o0.EXPLOSION:sn(t,e);break;case o0.SCREEN_FLASH:an(t,e);break}}function sn(t,e){t.opacity=F0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=F0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function an(t,e){let o=1-(1-e)*(1-e);t.opacity=F0(t.startOpacity,t.endOpacity,o)}function ln(){return u0}function Do(t,e,o,n,r){let s=ln();if(s.length!==0){t.save();for(let a of s)cn(t,a,e,o,n,r);t.restore()}}function cn(t,e,o,n,r,s){let a=fn(e.x,e.y,o,n,r,s,e.ignoreBounds);!a&&!e.ignoreBounds||e.renderFunction(t,e,a)}function fn(t,e,o,n,r,s,a=!1){let l=t-s.x,c=e-s.y,{dirY:u,dirX:d,planeY:A,planeX:x,invDet:g}=o,w=g*(u*l-d*c),h=g*(-A*l+x*c);return h<=.1&&!a?null:a?{x:n/2,y:r/2,radius:r,depth:h}:{x:n/2*(1+w/h),y:r/2+64,radius:r/h*.5,depth:h}}function dn(t,e,o){let n=o.radius*e.radius,r=performance.now()*.001,s=Math.sin(r*8)*12,a=Math.sin(r*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+s*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+s}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*a,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+s*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+s*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function un(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var h0={[C.entity]:{type:C.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[C.ball]:{type:C.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[C.sparkle]:{type:C.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[C.barrel]:{type:C.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[C.food]:{type:C.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[C.key]:{type:C.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},pe=null,p0=null;function Fo(t,e){pe=t,p0=e}var m0={[C.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,pe&&N.push(pe(C.sparkle,{x:t.x,y:t.y})));let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1*e,a=o/r,l=n/r,c=t.x+a*s,u=t.y+l*s;Bt(c,t.y,.4)||(t.x=c),Bt(t.x,u,.4)||(t.y=u)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,Ft(),S("Ball attacks!"),K.hurt(),t.hurtCD=.8,ue({color:"	#740707",duration:.5}),me()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(S(Ot(["Ball Hit!"])),t.health-=1,K.killedEntity()):(t.alive=!1,S(Ot(["Ball Busted!"])),K.killedEntity()):S("No arrows.")},onTouch(t){v0(C.entity,1e4)&&S("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,K.killedEntity(),S("The ball is blown to bits.")}},[C.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[C.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1.5*e,a=o/r,l=n/r,c=t.x+a*s,u=t.y+l*s;Bt(c,t.y,.4)||(t.x=c),Bt(t.x,u,.4)||(t.y=u)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,Ft(),S("Entity attacks!"),K.hurt(),t.hurtCD=.8,ue({color:"	#740707",duration:.5}),me()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,S(Ot(["Entity murdered!","Entity destroyed!","Entity purged!"])),K.killedEntity()):S("No arrows.")},onTouch(t){v0(C.entity,1e4)&&S("You hear something like water nearby...")},onExplode(t){t.alive=!1,K.killedEntity(),S("The entity is blown to gibs.")}},[C.barrel]:{onHit(t,e){e?(t.alive=!1,p0&&p0(t.x,t.y,2.5),S("Kaboom!"),K.explode()):S("No arrows.")},onTouch(t){v0(C.barrel,1e4)&&S("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,p0&&p0(t.x,t.y,2.5)}},[C.food]:{onTouch(t){t.alive=!1;let e=i.health>=i.maxHealth;e&&(i.maxHealth+=1),i.health=Ct(i.health+10,0,i.maxHealth),S(e?"Yummy!":"Health restored."),Ft(),K.pickup()},onExplode(t){}},[C.key]:{onTouch(t){t.alive=!1,i.hasBlueKey=!0,K.door(),S("Keycard found! Find the exit!"),he()},onExplode(t){t.alive=!1,i.hasBlueKey=!0,K.door(),S("The forcefield protecting the exit has suddenly lifted!"),he()}}};Object.freeze(h0);for(let t in h0)Object.freeze(h0[t]);Object.freeze(m0);for(let t in m0)Object.freeze(m0[t]);var pn=h0,hn=m0,mn=0;function Yt(t,e={x:0,y:0},o=void 0){let n=pn[t],r=hn[t],s=Object.assign(Object.create(r),n);return s.id=mn++,s.x=e.x,s.y=e.y,s.dist=0,s.alive=!0,s.hurtCD=0,o&&Object.assign(s,o),s}function gn(t,e,o){To(t,e,o);for(let n of N){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}Fo(Yt,gn);var ge=0,it=new Set,yn=0,ye=!1;function vo(t){window.addEventListener("keydown",e=>{if(it.add(e.code),fe(),de(),e.code==="Space"&&(e.preventDefault(),ko()),e.code==="KeyM"&&(e.preventDefault(),gt.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(i.mouseSensitivity){case .33:S("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .22:S("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break;case .11:S("Mouse sensitivity set to low."),i.mouseSensitivity=.05;break;case .05:S("Mouse sensitivity already lowest."),i.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(i.mouseSensitivity){case .33:S("Mouse sensitivity already set to highest."),i.mouseSensitivity=.33;break;case .22:S("Mouse sensitivity set to highest."),i.mouseSensitivity=.33;break;case .11:S("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .05:S("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>it.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&ko(),yn=e.clientX,fe(),de()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*i.mouseSensitivity);i.a+=n}}),ze.onclick=()=>Cn(),Ge.onclick=()=>gt.classList.toggle("visible")}function Io(t){let e=it.has("ShiftLeft")||it.has("ShiftRight"),o=i.rotSpeed*t,n=i.accel*t,r=Math.cos(i.a),s=Math.sin(i.a),a=-s,l=r;i.weaponAnim>.75&&(i.weaponAnim=-1),i.weaponAnim>=0&&(i.weaponAnim+=t);let c=3;i.velX-=i.velX*c*t,i.velY-=i.velY*c*t,Math.abs(i.velX)<.002&&(i.velX=0),Math.abs(i.velY)<.002&&(i.velY=0),i.isMoving=!1;let u=0,d=0;it.has("ArrowLeft")&&(i.a-=o),it.has("ArrowRight")&&(i.a+=o),(it.has("ArrowUp")||it.has("KeyW"))&&(u+=r*n,d+=s*n,i.isMoving=!0),(it.has("ArrowDown")||it.has("KeyS"))&&(u-=r*n,d-=s*n,i.isMoving=!0),it.has("KeyA")&&(u-=a*n,d-=l*n,i.isMoving=!0),it.has("KeyD")&&(u+=a*n,d+=l*n,i.isMoving=!0),i.velX+=u,i.velY+=d;let A=Math.hypot(i.velX,i.velY);A>20&&(i.velX*=20/A,i.velY*=20/A);let x=i.x+i.velX*t,g=i.y+i.velY*t;if(Bt(x,i.y,U0)?i.velX=0:i.x=x,Bt(i.x,g,U0)?i.velY=0:i.y=g,i.health>=0){let w=j[(i.y|0)*f.MAP_W+(i.x|0)],h=f.zones[w]?.floorDepth||0;(i._currentZoneId!==w||i._currentFloorDepth!==h)&&(i._currentZoneId=w,i._currentFloorDepth=h,f0())}}function ko(){if(i.weaponAnim>=0)return;i.weaponAnim=0,Ft(),K.shot();let t=T0(),e=xn(t);!e||d0(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function Ro(){for(let t of N)!t.alive||Math.hypot(t.x-i.x,t.y-i.y)>=.6||t.onTouch&&t.onTouch(t)}function Po(){if(ye)return;let t=i.x|0,e=i.y|0;f.MAP[e][t]===5&&(K.portal(),S(`Floor ${Gt} cleared.`),Z0(Gt+1),ye=!0,i.velX=0,i.velY=0,setTimeout(()=>{Mn(!0),ye=!1},100))}function xn(t){let o=document.getElementById("view").width>>1|0,n=dt[o]||1e9,r=null,s=1e9;for(let a of N){if(!a.alive)continue;let l=d0(a,t);l&&(i.sightDist>0&&l.depth>i.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<s&&(r=a,s=l.depth))}return r}function g0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(f.MAP_W-2)|0)+1,n=(Math.random()*(f.MAP_H-2)|0)+1;if(f.MAP[n][o]!==0)continue;let r=o+.5-i.x,s=n+.5-i.y;if(!(Math.hypot(r,s)<t))return{x:o,y:n}}return{x:9,y:9}}var we=new Map;function Oo(){we.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=f;for(let r=0;r<n.length;r++){let s=n[r],a=Math.min(s.x,s.x+s.w),l=Math.max(s.x,s.x+s.w)-1,c=Math.min(s.y,s.y+s.h),u=Math.max(s.y,s.y+s.h)-1,d=Ct(a,0,t-1),A=Ct(l,0,t-1),x=Ct(c,0,e-1),g=Ct(u,0,e-1),w=[];for(let h=x;h<=g;h++)for(let T=d;T<=A;T++)Ut(T,h)||w.push({x:T,y:h});we.set(r,w)}}function wn(t){let e=we.get(t);return!e||e.length===0?null:Ot(e)}function he(){let t=f.MAP_W,e=f.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)f.MAP[o][n]===7&&(f.MAP[o][n]=0)}function Lo(){let t=St.x,e=St.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(f.MAP[o][n]=7)}function Ho(){if(N.length=0,ft(100)<50)for(let o=0;o<ft(2)*(f.MAP_H/20|0);o++){let n=g0(1);N.push(Yt(C.barrel,{x:n.x+.5,y:n.y+.5}))}let t=g0(4);N.push(Yt(C.key,{x:t.x+.5,y:t.y+.5})),t=g0(4),N.push(Yt(C.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(Gt-1)*2)*(f.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=g0(3.5);N.push(Yt(C.entity,{x:n.x+.5,y:n.y+.5}))}t=g0(4),N.push(Yt(C.ball,{x:t.x+.5,y:t.y+.5})),f.zones.forEach((o,n)=>{let r=n;o.spawnRules?.forEach(a=>{let l=Math.max(0,a.amount|0);for(let c=0;c<l;c++){let u=wn(r);if(!u)break;N.push(Yt(a.entityType,{x:u.x+.5,y:u.y+.5}))}})})}function Ft(){Be.style.width=`${i.health/i.maxHealth*100}%`,Ye.style.width=`${i.ammo/60*100}%`,Ne.textContent=Math.max(0,i.health),Xe.textContent=i.ammo}var xe=0,Ee=0,Me=!1,_o=!1;function S(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let s=n.innerHTML,a=s.match(/^(.*?)(?:\s+x(\d+))?$/),l=a?a[1]:s,c=a&&a[2]?parseInt(a[2]):1;if(l===t){let u=a&&a[2]?c+1:2;n.innerHTML=`${t} x${u}`;return}}let r=document.createElement("div");r.innerHTML=t,o.prepend(r),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Bo(t){xe>0&&(xe-=t,xe<=0&&(We.textContent=i.hasBlueKey?"Find the exit.":"Find the key card."))}function me(){Me||i.health<=0&&(Me=!0,i.speed=0,i.rotSpeed=0,Ee=2,S("YOU DIED! Soul disconnecting from the node..."))}function Yo(t){Me&&(Ee-=t,Ee<=0&&En())}function En(){if(_o)return;_o=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),it.clear()}}function Ce(t=!1){t&&n0(),i.x=Lt.x,i.y=Lt.y,i.a=0,i.hasBlueKey=!1,f.MAP[St.y][St.x]=5,Lo(),Ho(),Ft(),S(`Floor ${Gt}: Find the keycard.`)}function Mn(t=!1){t&&(ge>=l0.length-1?n0():(ge+=1,n0(ge))),i.x=Lt.x,i.y=Lt.y,i.a=0,i.hasBlueKey=!1,f.MAP[St.y][St.x]=5,Lo(),Ho(),Ft(),S(`Floor ${Gt}: Find the keycard.`)}function Cn(){Z0(1),n0(0),Ce()}function No(t){for(let e of N)e.alive&&e.ai&&e.ai(e,t)}var P0=performance.now(),R0=new Map;function v0(t,e=0){if(e===0)return!(P0<R0.get(t));let o=P0,n=R0.get(t)??0;return o<n?!1:(R0.set(t,o+e),!0)}function Hr(t){R0.set(t,performance.now())}var Ae=m>>1;vo(Jt);var I0=0;function An(t){let e=`FPS: ${Math.round(t)}`;p.save(),p.font="12px monospace",p.textAlign="right",p.textBaseline="top";let o=_-8,n=6,r=p.measureText(e).width+8,s=16;p.fillStyle="rgba(10, 15, 25, 0.6)",p.fillRect(o-r,n-2,r,s),p.strokeStyle="rgba(60, 80, 130, 0.9)",p.strokeRect(o-r+.5,n-2+.5,r-1,s-1),p.fillStyle="#dfe6ff",p.fillText(e,o,n),p.restore()}function n0(t=-1){let e;if(t!==-1){let o=l0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=Ot(l0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}St.x=e.exitPos.x,St.y=e.exitPos.y,Lt.x=e.startPos.x,Lt.y=e.startPos.y,i.sightDist=e.sightDist||Ze,f.cielingColorFront=e.cielingColorFront||"#6495ED",f.floorColorFront=e.floorColorFront||"#054213",f.cielingColorBack=e.cielingColorBack||"#6495ED",f.floorColorBack=e.floorColorBack||"#03210A",f.MAP=e.mapLayout,f.MAP_W=f.MAP[0].length,f.MAP_H=f.MAP.length,f.zones=e.zones,Oo(),ao(),co(),f0(),i.x=i.x=e.startPos.x,i.y=e.startPos.y}async function Sn(){await yo(),await Qe(),n0(0),Ce(),i.maxHealth=20+ft(6),i.health=i.maxHealth,i.ammo=5+ft(5),Ft(),requestAnimationFrame(Xo)}function Tn(t){let e=T0();if(f.zones.length<=2)lo(p);else{for(let o=0;o<_;o++)uo(t,e,o,0);mo(p)}if(f.zones.length<=2){let o=i.x|0,n=i.y|0,r=j[n*f.MAP_W+o],s=_0[r];if(!s){let a=f.zones[r].fogColor;s=p.createLinearGradient(0,m,0,Ae),s.addColorStop(0,f.floorColorFront||"#054213"),s.addColorStop(.85,f.floorColorBack||"#03210A"),s.addColorStop(.95,a||At),_0[r]=s}p.fillStyle=s,p.fillRect(0,Ae,_,Ae)}else{for(let o=0;o<_;o++)fo(t,e,o,0);ho(p)}po(p),go(t,e,f.MAP,f.MAP_W,f.MAP_H),bn(),N.sort((o,n)=>n.dist-o.dist),Dn(e),_n(t),Do(p,e,_,m,i)}function bn(){for(let t of N){let e=t.x-i.x,o=t.y-i.y;t.dist=e*e+o*o}}function Dn(t){p.save();for(let e of N){if(!e.alive||Math.hypot(e.x-i.x,e.y-i.y)>i.sightDist)continue;let n=d0(e,t);if(!n||i.sightDist>0&&n.depth>i.sightDist)continue;let r=3,s=0;for(let l=0;l<r;l++){let c=n.drawStartX+l*(n.drawEndX-n.drawStartX)/(r-1);n.depth<=dt[Math.floor(c)]&&s++}if(s===0)continue;let a=Fn(n);kn(e,n,a),p.filter="none"}p.restore()}function Fn(t){let e=1/(1+t.depth*.3);if(i.sightDist>0&&t.depth>i.sightDist*a0){let r=i.sightDist*a0,s=Math.min(1,Math.max(0,(t.depth-r)/Math.max(1e-6,i.sightDist-r)));e*=1-s*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,s)=>Math.abs(s-e)<Math.abs(r-e)?s:r,o[0])}}function kn(t,e,o){o.quantizedShade<.999&&(p.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),r=e.drawStartY,s=e.drawEndY-e.drawStartY,a=e.occludedBottom|0;if(a>=s){p.filter="none";return}let l=s-a,c=v[t.img];if(!c){p.filter="none";return}let u=a/s,d=Math.round(c.height*u),A=c.height-d,x=h=>(h-e.drawStartX)*v[t.img].width/n|0,g=-1,w=0;for(let h=e.drawStartX;h<=e.drawEndX;h++){let I=h>=0&&h<_&&h<e.drawEndX&&e.depth<=dt[h];if(I&&g===-1&&(g=h,w=x(h)),(!I||h===e.drawEndX)&&g!==-1){let y=h,D=y-g,P=x(y);P<=w&&(P=w+1);let E=Math.min(v[t.img].width-w,P-w);D>0&&E>0&&s>0&&p.drawImage(v[t.img],w,0,E,A,g,r,D,l),g=-1}}}function _n(t){if(!v.pitchfork)return;let e=Math.round(_*.42),o=Math.round(e*(v.pitchfork.height/v.pitchfork.width)),n=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*5):0,r=Math.max(8,_*.02|0),s=_*.5-e/2-r/2+n,a=(i.weaponAnim+1)**10,l=a>7?7:a,c=i.weaponAnim>=0?100-l*20:0,u=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*10):0,d=m-o-r+70+u+c;p.drawImage(v.pitchfork,s,d,e,o)}function Xo(t){let e=Math.min(.05,(t-P0)/1e3);P0=t;let o=e>0?1/e:0;I0=I0?I0*.9+o*.1:o,Io(e),No(e),bo(e),Ro(),Tn(t/1e3),gt.classList.contains("visible")&&Eo(N),Po(),Bo(e),Yo(e),An(I0),G0.drawImage(z0,0,0),requestAnimationFrame(Xo)}await Sn().catch(console.error);export{n0 as ChangeMapLevel,Hr as resetCooldown,v0 as tryCooldown};
