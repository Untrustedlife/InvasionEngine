import{a as yt,b as nt,c as je,d as jt,e as fe,f as lt,g as pe,h as Je,i as It,j as Mt,k as ct,l as de,m as Qe,n as t0,o as e0,p as v}from"../chunks/chunk-EKETJP6P.js";var vt=document.getElementById("view");vt.width=480;vt.height=270;var _=480,m=270,Jt=new OffscreenCanvas(_,m),d=Jt.getContext("2d",{colorSpace:"srgb"});d.imageSmoothingEnabled=!1;var Qt=vt.getContext("2d",{colorSpace:"srgb"});Qt.imageSmoothingEnabled=!1;vt.style.filter="brightness(1.15) contrast(1.06)";var it=document.getElementById("mini"),q=it.getContext("2d");q.imageSmoothingEnabled=!1;var o0=document.getElementById("hpBar"),n0=document.getElementById("ammoBar"),i0=document.getElementById("hpText"),r0=document.getElementById("ammoText"),s0=document.getElementById("msg"),a0=document.getElementById("btnReset"),l0=document.getElementById("btnToggleMap"),Bt=typeof createImageBitmap<"u"&&typeof ImageBitmap<"u";var so=90*Math.PI/180,me=so*.5;var d0=15;var Pt=.6,ft="#101b2e";var u0=1,m0=.6;var i={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,sightDist:15,mouseSensitivity:.22,height:1.2,calculatePlayerHeight:()=>{if(2-i.height<.01)return .01;let t=i.getCurrentFloorDepth?i.getCurrentFloorDepth():0;return(2-i.height-t)*1},getCurrentZoneId:()=>i._currentZoneId||0,getCurrentFloorDepth:()=>i._currentFloorDepth||0,_currentZoneId:0,_currentFloorDepth:0},he=.2,Ct=1,h0=1,ao=99;function ge(t){Ct=Math.max(h0,Math.min(ao,t|0||h0))}function ee(){let t=Math.cos(i.a),e=Math.sin(i.a),o=-e*Math.tan(me),n=t*Math.tan(me),s=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:s}}var g0=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{x:0,y:0,w:1,h:1,color:"#054213",cielingColorFront:"#6495ed",outside:!0,spawnRules:[]},{x:0,y:2,w:20,h:2,color:"#0011ff",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",spawnRules:[],floorDepth:-.5,isLiquid:!0,outside:!0},{x:15,y:7,w:1,h:3,color:"#6f2801",cielingColorFront:"#8b8000",cielingColorBack:"#000000",ceilingHeight:"6",floorColorBack:"#000000",fogColor:"#000000",floorDepth:.33,spawnRules:[{entityType:"food",amount:2}]},{x:3,y:5,w:14,h:12,color:"#8b8000",cielingColorFront:"#8b8000",cielingColorBack:"#00000000",ceilingHeight:6,floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5}]},{x:1,y:0,w:18,h:19,color:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",outside:!0,spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];var pt={x:10,y:8},xt={x:3.5,y:3.5};var f={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},Ht=g0,y0=new Map;function E0(t){let e=f.zones,o=e&&e[t]?.color||ft,n=y0.get(o);return n||(n=fe(o),y0.set(o,n)),n}var x0=new Map;function w0(t){let e=f.zones,o=e&&e[t]?.cielingColorFront||ft,n=x0.get(o);return n||(n=fe(o),x0.set(o,n)),n}function A0(t,e,o){for(let n=0;n<o.length;n++){let s=o[n],r=Math.min(s.x,s.x+s.w),a=Math.max(s.x,s.x+s.w)-1,l=Math.min(s.y,s.y+s.h),c=Math.max(s.y,s.y+s.h)-1;if(t>=r&&t<=a&&e>=l&&e<=c)return n}return 0}var Ce=new Float32Array(_*m).fill(Number.POSITIVE_INFINITY),Lt=[];function rt(t,e){return t<0||t>=_||e<0||e>=m?Number.POSITIVE_INFINITY:Ce[e*_+t]}function lo(t,e,o){t<0||t>=_||e<0||e>=m||(Ce[e*_+t]=o)}function co(){Ce.fill(Number.POSITIVE_INFINITY)}var N=m>>1,Yt=new Int16Array(_).fill(N),ye=new Int16Array(_).fill(N),Ft=new Float32Array(m),ie=new Float32Array(m),Tt={},bt={};function Nt(){for(let r in bt)delete bt[r];for(let r in Tt)delete Tt[r];let t=N,e=i.calculatePlayerHeight(),n=2-0,s=m*(n-e)*.5;for(let r=0;r<m;r++){let a=r-t;Ft[r]=a!==0?s/a:1e-6;let c=2-2,p=m*(c+e)*.5;ie[r]=a!==0?-p/a:-1e-6}for(let r=0;r<f.zones.length;r++){let a=f.zones[r];if(a.ceilingHeight!==void 0){bt[r]=new Float32Array(m);for(let l=0;l<m;l++){let c=l-t,h=a.ceilingHeight-2,y=m*(h+e)*.5;bt[r][l]=c!==0?-y/c:-1e-6}}if(a.floorDepth!==void 0){let c=2-a.floorDepth,p=m*(c-e)*.5;Tt[r]=new Float32Array(m);for(let h=0;h<m;h++){let y=h-t;Tt[r][h]=y!==0?p/y:1e-6}}}}Nt();function fo(t,e,o,n,s,r,a,l,c,p){let h=n-o;if(h<=0||!s||o>=m||n<=0)return;let y=s,x=l||0,A=x<0?0:x>y?y:x,E=c||y,g=y-A,I=E<0?0:E>g?g:E;if(I<=0)return;let B=o,u=n,C=0;if(B<0){let S=-B;C+=S/h*I,B=0}u>m&&(u=m);let F=u-B;if(F<=0)return;let b=je(de,a);t.drawImage(Qe[p][de[b]],r,A+C,1,F/h*I,e,B,1,F)}var xe=[],Ee=[],we=[],Ae=[],re=[],G=[];function S0(){xe.length=0,Ee.length=0,we.length=0,Ae.length=0,re.length=0,Se.clear(),Me.clear()}function M0(t){let e=i.x|0,o=i.y|0,n=G[o*f.MAP_W+e],s=xe[n];if(!s){s=t.createLinearGradient(0,0,0,N);let r=f.zones[n].cielingColorFront,a=f.zones[n].cielingColorBack,l=f.zones[n].fogColor;s.addColorStop(0,r||f.cielingColorFront||"#6495ED"),f.cielingColorBack&&s.addColorStop(.5,a||f.cielingColorBack||"#6495ED"),s.addColorStop(.9,l||ft),xe[n]=s}t.fillStyle=s,t.fillRect(0,0,_,N)}var Se=new Map;function oe(t){let e=Se.get(t);if(!e){let[o,n,s]=E0(t);e=`rgb(${o|0},${n|0},${s|0})`,Se.set(t,e)}return e}var Me=new Map;function ne(t){let e=Me.get(t);if(!e){let[o,n,s]=w0(t);e=`rgb(${o|0},${n|0},${s|0})`,Me.set(t,e)}return e}function C0(){G.length=0;let t=f.zones,e=f.MAP_W,o=f.MAP_H;for(let n=0;n<o;n++)for(let s=0;s<e;s++)G[n*e+s]=A0(s,n,t)}function T0(t,e,o,n=0){let{dirX:s,dirY:r,planeX:a,planeY:l}=e;n=N;let c=n<N?N:n;if(c>=m)return;let p=2*(o+.5)/_-1,h=s+a*p,y=r+l*p;if(i.sightDist>0){for(;c<m&&!((Ft[c]??1/0)<=i.sightDist);)c++;if(c>=m)return}let x="#000000",A=f.MAP_W,E=f.MAP_H,g=1/(s*h+r*y),I=h*g,B=y*g,u=0;function C(H,k=0){let T=Ft[H]??Ft[Ft.length-1]??1/0,L=i.x+I*T,M=i.y+B*T,w=L|0,O=M|0;return w>=0&&O>=0&&w<A&&O<E?G[O*A+w]:0}let F=H=>Math.max(8,Math.min(64,8+(H-N>>>3)));u=C(c,u);let b=c,S=null,D=!1;for(;c<m;){if(rt(o,c|0)<1/0){if(!D&&c>b){let K=oe(u);K!==S&&(d.fillStyle=K,S=K),d.fillRect(o,b,1,c-b)}D=!0,b=c+1,c++;continue}D=!1;let k=Math.min(F(c),m-1-c);if(k<=0)break;let T=c+k;if(C(T,u)===u){let K=c+T>>1;if(C(K,u)===u){let St=oe(u);St!==S&&(d.fillStyle=St,S=St);let gt=T+1-b;gt>0&&d.fillRect(o,b,1,gt),c=T+1,b=c;continue}}let M=c,w=T;for(;w-M>1;){let K=M+w>>1;C(K,u)===u?M=K:w=K}let O=oe(u);O!==S&&(d.fillStyle=O,S=O);let V=w-b;V>0&&d.fillRect(o,b,1,V);let Y=C(w,u),U=f.zones[u]?.floorDepth??0,$=f.zones[Y]?.floorDepth??0,ot=f.zones[u]||{},at=f.zones[Y]||{},tt=ot.isLiquid,W=at.isLiquid,Zt=Yt[o]??N,At=Tt?.[u]?.[w]??Ft[w]??1/0,Ze=rt(o,Yt[o])??1/0,no=w===Zt,Ue=At>=Ze-2;if((tt||W)&&U!==$&&(Ue=!1),!!x&&U!==$&&!no&&!Ue&&!(b===Zt)){let K=ot.floorDepth??0,St=at.floorDepth??0,gt=0;if(tt||W)gt=K>St?5:0;else{let io=K-St,$e=Tt?.[u]?.[w],Ke=Tt?.[Y]?.[w],Kt=At;(Number.isFinite($e)||Number.isFinite(Ke))&&(Kt=Math.min($e??1/0,Ke??1/0,At??1/0),Number.isFinite(Kt)||(Kt=At));let ro=m*io*.5/Kt;gt=Math.max(1,ro|0),gt=K>St?gt:0}let Ut=w,$t=Ut+gt;if(C(w,u)!==C($t-1,Y))S=null,u=Y;else{$t>Ut&&(d.fillStyle!==x&&(d.fillStyle=x),d.fillRect(o,Ut,1,$t-Ut)),S=null,u=Y,c=$t,b=c;continue}}u=Y,c=w,b=c}if(b<m){let H=oe(u);H!==S&&(d.fillStyle=H),d.fillRect(o,b,1,m-b)}}function b0(t,e,o,n=0){let{dirX:s,dirY:r,planeX:a,planeY:l}=e,c=N,p=0;if(c<=0)return;let h=2*(o+.5)/_-1,y=s+a*h,x=r+l*h,A=1/(s*y+r*x),E=0,g=bt?.[E]?.[p]??ie[p],I=i.x+y*g*A,B=i.y+x*g*A,u=p,C=null,F=!1;for(let S=p;S<c;S++){if(i.sightDist>0&&g>i.sightDist){let M=ne(E);M!==C&&(d.fillStyle=M),d.fillRect(o,u,1,S-u);return}if(g>=rt(o,S|0)){if(!F){let O=ne(E);O!==C&&(d.fillStyle=O,C=O),d.fillRect(o,u,1,S-u)}let M=bt?.[E]?.[S+1]??ie[S+1]??g,w=M-g;I+=y*w*A,B+=x*w*A,g=M,F=!0,u=S;continue}F=!1;let D=I|0,H=B|0,k=D>=0&&H>=0&&D<f.MAP_W&&H<f.MAP_H?G[H*f.MAP_W+D]:E;if(k!==E){let M=ne(E);M!==C&&(d.fillStyle=M,C=M),d.fillRect(o,u,1,S-u),E=k,u=S}let T=bt?.[E]?.[S+1]??ie[S+1]??g,L=T-g;I+=y*L*A,B+=x*L*A,g=T}let b=ne(E);b!==C&&(d.fillStyle=b),d.fillRect(o,u,1,c-u)}function D0(t){let e=Ae[0];e||(e=t.createLinearGradient(0,0,0,m),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),Ae[0]=e),t.fillStyle=e,t.fillRect(0,0,_,m)}function _0(t){let e=N-1,o=m-e,n=i.x|0,s=i.y|0,r=G[s*f.MAP_W+n],a=Ee[r];if(!a){let l=f.zones[r].floorColorBack;a=t.createLinearGradient(0,e,0,m),a.addColorStop(.05,f.zones[r].fogColor||ft),a.addColorStop(.15,l||f.floorColorBack||"#03210A"),a.addColorStop(1,"rgba(0,0,0,0)"),Ee[r]=a}t.fillStyle=a,t.fillRect(0,e,_,o)}function k0(t){let o=N+1,n=i.x|0,s=i.y|0,r=G[s*f.MAP_W+n],a=we[r];if(!a){let l=f.zones[r].fogColor||ft,c=f.zones[r].cielingColorBack||f.cielingColorBack||"#6495ED";a=t.createLinearGradient(0,0,0,0+o),a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(.85,c),a.addColorStop(.95,l),we[r]=a}t.fillStyle=a,t.fillRect(0,0,_,o)}function po(t,e,o,n){if(i.sightDist<=0)return;let s=i.sightDist*Pt,r=i.sightDist;if(n<=s)return;let a=e|0,l=o|0;if(a<0&&(a=0),l>m&&(l=m),l<=a)return;let c=Math.min(1,Math.max(0,(n-s)/Math.max(1e-6,r-s))),p=i.x|0,h=i.y|0,y=G.length>0?G[h*f.MAP_W+p]|0:0;d.save(),d.globalAlpha=c*.85,d.fillStyle=f.zones[y].fogColor||ft,d.fillRect(t,a,1,l-a),d.restore()}function I0(t,e){co();let{dirX:o,dirY:n,planeX:s,planeY:r}=e,a=i.sightDist>0,l=i.calculatePlayerHeight(),c=m*(2-l)*.5;for(let p=0;p<_;p++){Lt.length=0;let h=2*(p+.5)/_-1,y=o+s*h,x=n+r*h;if(y<1e-8&&y>-1e-8&&x<1e-8&&x>-1e-8){Yt[p]=N,ye[p]=N;continue}let A=1/(y||1e-9),E=1/(x||1e-9),g=i.x|0,I=i.y|0,B=A<0?-A:A,u=E<0?-E:E,C,F,b,S;y<0?(C=-1,b=(i.x-g)*B):(C=1,b=(g+1-i.x)*B),x<0?(F=-1,S=(i.y-I)*u):(F=1,S=(I+1-i.y)*u);let D=0,H=1,k=!1,T=0;for(;T<i.sightDist*1.5;){for(k=!1;!k&&T++<i.sightDist*1.5;){if(b<S?(b+=B,g+=C,D=0):(S+=u,I+=F,D=1),a&&Math.min(b,S)>i.sightDist){k=!1,H=0;break}if(g<0||I<0||g>=f.MAP_W||I>=f.MAP_H){k=!0,H=1;break}let At=f.MAP[I][g];if(At>0){k=!0,H=At;break}}let L=H;if(L===0){Yt[p]=N,ye[p]=N;continue}let M;D===0?M=b-B:M=S-u;let w=i.x+M*y,O=i.y+M*x;M=Math.max(.01,M);let V=G[I*f.MAP_W+g]|0,Y=f.zones[V]?.floorDepth??0;f.zones[V].isLiquid||(c=m*(2-Y-l)*.5);let U=g-(D===0?C:0),$=I-(D===1?F:0),ot=0;U>=0&&$>=0&&U<f.MAP_W&&$<f.MAP_H&&(ot=G[$*f.MAP_W+U]|0);let at=ot>=0?ot:V|0,tt,W;D===0?(W=O-(O|0),C<0?(tt=It.EAST,W=1-W):tt=It.WEST):(W=w-(w|0),F>0?(tt=It.NORTH,W=1-W):tt=It.SOUTH);let Zt=W*Mt|0;uo(p,at,c,M,D,t,tt,Zt,C,F,L)}ho()}}function uo(t,e,o,n,s,r,a,l,c,p,h){let y=G[i.y*f.MAP_W+i.x]|0,x=f.zones[y],A=f.zones[e];n=Math.max(.01,n);let E=m/n|0,g=N+o/n|0,I=A.ceilingHeight||2,B=1/(1+n*.25)*(s?.5:1);ct[h].animated&&(B*=.8+.2*Math.sin(r*6+t*.05));let u=Mt/E,C=ct[h].height||1;C=I/2<C&&!x.outside?I/2:C;let F=C,b=0,S=g,D=[];for(;F>0;){let H=F>=1?1:F,k=E*H,T=S-k,L=S-E,M=(T-L)*u;(M<0||M>Mt)&&(M=(M%Mt+Mt)%Mt);let w=(S-T)*u;ct[h]?.textures?.ALL&&(a=It.ALL);let O=ct[h]?.textures?.[a]?.[b]||"brick",V=t0[O],Y={screenColumnX:t,sliceTop:T,sliceBottom:S,colLength:V.cols.length,textureColumnX:l,shadeAmount:B,srcY:M,srcH:w,segTexId:O,bottomY:g,wallLineHeight:E,perpendicularDistance:n,tall:C};D.push(Y),S=T,F-=H,b++}Lt.push(D)}function mo(t){for(let e=0;e<Lt.length;e++){let o=Lt[e];if(t!==void 0&&t<=o[o.length-1].sliceTop){o.length=0;continue}let n=0;for(let s=0;s<o.length;s++){let r=o[s];(t===void 0||t>=r.sliceTop)&&(o[n++]=r)}if(o.length=n,o.length>0){let s=o[0].bottomY-o[0].wallLineHeight*(o[0].tall>0?o[0].tall:1),r=o[o.length-1].sliceTop;t=t===void 0?Math.min(s,r):Math.min(t,s,r)}}return t}function ho(){let t;t=mo(t);for(let e=Lt.length-1;e>=0;e--){let o=Lt[e];if(o.length===0)continue;for(let a=0;a<o.length;a++){let{screenColumnX:l,sliceTop:c,sliceBottom:p,colLength:h,textureColumnX:y,shadeAmount:x,srcY:A,srcH:E,segTexId:g,perpendicularDistance:I}=o[a];fo(d,l,c,p,h,y,x,A,E,g);let B=c|0,u=p|0;for(let C=B;C<=u;C++)C<0||C>=m||lo(l,C,I)}let s=o[0].bottomY-o[0].wallLineHeight*(o[0].tall>0?o[0].tall:1),r=o[0].bottomY;Yt[o[0].screenColumnX]=r,ye[o[0].screenColumnX]=s,po(o[0].screenColumnX,s,r,o[0].perpendicularDistance)}}var go={},P={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function yo(t){if(!Bt||!t)return t;try{return t.transferToImageBitmap?t.transferToImageBitmap():await createImageBitmap(t)}catch(e){return console.warn("Sprite ImageBitmap conversion failed, using canvas:",e),t}}async function dt(t,e){return await xo(t,e,1)}async function xo(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((s,r)=>{let a=new Image;a.onload=()=>{let l=new OffscreenCanvas(a.width*e,a.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(a,0,0,l.width,l.height),l.baseline=o,l.scale=e,s(l)},a.onerror=()=>r(new Error(`Failed to load sprite: ${n}`)),a.src=n})}async function v0(){P.food=await dt("noodles.png",3),P.bow=await dt("bow.png",3),P.pitchfork=await dt("pitchfork.png",3),P.keycard1=await dt("keycard1.png",3),P.barrel=await dt("emp.png",3),P.aiDrone1=await dt("aiDrone1.png",3),P.aiDrone2=await dt("aiDrone2.png",3),P.aiDrone3=await dt("aiDrone3.png",3),P.ball=await dt("Palantrash1.png",3),P.sparkle=await dt("sparkle.png",3);let t=[{key:"food",canvas:P.food},{key:"bow",canvas:P.bow},{key:"pitchfork",canvas:P.pitchfork},{key:"keycard1",canvas:P.keycard1},{key:"barrel",canvas:P.barrel},{key:"aiDrone1",canvas:P.aiDrone1},{key:"aiDrone2",canvas:P.aiDrone2},{key:"aiDrone3",canvas:P.aiDrone3},{key:"ball",canvas:P.ball},{key:"sparkle",canvas:P.sparkle}].map(async({key:e,canvas:o})=>{let n=await yo(o);return P[e]=n,go[e]=n,{key:e,optimizedSprite:n}});await Promise.all(t)}var z=[];function Eo(t){return m/t}function wo(t,e,o){let{dirY:n,dirX:s,planeY:r,planeX:a,invDet:l}=o,c=l*(n*t-s*e),p=l*(-r*t+a*e);return{transX:c,transY:p}}function Ao(t,e){return Math.round((_>>1)*(1+t/e))}function Xt(t,e){let o=t.x-i.x,n=t.y-i.y,{transX:s,transY:r}=wo(o,n,e);if(r<=0)return null;let a=Ao(s,r),l=t&&typeof t.scale=="number"?t.scale:t&&P[t.img]&&typeof P[t.img].scale=="number"?P[t.img].scale:1,c=Eo(r)*l,p=typeof t._hR=="number"?t._hR:Math.round(c),h=.1,y=p;(c>p+h||c<p-h)&&(y=Math.round(c)),t._hR=y;let x=y,A=P[t.img],E=A&&A.width&&A.height?A.width/A.height:1,g=Math.max(1,Math.round(x*E)),I=i.calculatePlayerHeight(),B=m*.5,u=0,C=0,F,b;if(t.ground){let k=G[(t.y|0)*f.MAP_W+(t.x|0)],T=f.zones[k],L=i.getCurrentFloorDepth()||0,M=T.floorDepth||0,w;if(M<=L){let Y=2-(T.floorDepth||0);w=B+m*(Y-I)*.5/r}else{let U=2+.5*(L-M);w=B+m*(U-I)*.5/r}let O=Math.floor(w+1e-6);if(F=O-x,b=O,T&&T.isLiquid){let Y=T.floorDepth??0;if(Y<0){let U=Y<0?-Y:0,at=lt(U/1.2,0,1),tt=lt(at,0,1);u=Math.min(x-1,Math.round(x*tt))}}if(T&&T.ceilingHeight){let Y=T.ceilingHeight||2,$=I+x*.5*r/m*2-Y;if($>0){let ot=Math.round($*m/(r*1)),at=x-1-u;C=Math.min(at,ot)}}}else{let k=Math.round(B-x*.5);F=k,b=k+x}let S={startY:F,endY:b},D=Math.round(a-(g>>1)),H=D+g;return{drawStartX:D,drawEndX:H,drawStartY:S.startY,drawEndY:S.endY,depth:r,size:x,width:H-D,occludedBottom:u,occludedTop:C}}var Te={[v.entity]:"#ffeb9c",[v.barrel]:"#CD1C18",[v.key]:"#6aa2ff",[v.food]:"#7fffd4",default:"#ffffff"};var et=6,Dt=20,ut=2,P0=Math.floor(Dt/2);it.width=ut+Dt*et+ut;it.height=ut+Dt*et+ut;function F0(t){q.clearRect(0,0,it.width,it.height);let e=Math.max(0,Math.min((i.x|0)-P0,f.MAP_W-Dt)),o=Math.max(0,Math.min((i.y|0)-P0,f.MAP_H-Dt));for(let l=0;l<Dt;l++)for(let c=0;c<Dt;c++){let p=o+l,h=e+c,y=f.MAP[p]?.[h]??0,x=ct[y].miniMapColor||"#000000";q.fillStyle=x,q.fillRect(ut+c*et,ut+l*et,et-1,et-1)}for(let l of t){if(!l.alive)continue;let c=ut+(l.x-e)*et,p=ut+(l.y-o)*et;q.fillStyle=Te[l.type]||Te.default,q.fillRect(c-2,p-2,4,4)}let n=ut+(i.x-e)*et,s=ut+(i.y-o)*et;q.fillStyle="#e7f3ff",q.beginPath(),q.arc(n,s,2.5,0,Je),q.fill();let r=Math.cos(i.a),a=Math.sin(i.a);q.strokeStyle="#78f3d3",q.beginPath(),q.moveTo(n,s),q.lineTo(n+r*1.5*et,s+a*1.5*et),q.stroke()}var X=null,_t=null,J=null,be=null,L0=null;function _e(){X||(X=new(window.AudioContext||window.webkitAudioContext))}function j({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:s=0}){if(!X)return;let r=X.createOscillator(),a=X.createGain();r.type=o,r.frequency.value=t,a.gain.value=n,r.connect(a).connect(X.destination);let l=X.currentTime;s&&(r.frequency.setValueAtTime(t,l),r.frequency.linearRampToValueAtTime(t+s,l+e)),a.gain.setValueAtTime(n,l),a.gain.exponentialRampToValueAtTime(.001,l+e),r.start(l),r.stop(l+e)}function De({dur:t=.2,vol:e=.2,lp:o=1200}){if(!X)return;let n=X.createBuffer(1,X.sampleRate*t,X.sampleRate),s=n.getChannelData(0);for(let p=0;p<s.length;p++)s[p]=Math.random()*2-1;let r=X.createBufferSource(),a=X.createGain(),l=X.createBiquadFilter();r.buffer=n,a.gain.value=e,l.type="lowpass",l.frequency.value=o,r.connect(l).connect(a).connect(X.destination);let c=X.currentTime;r.start(c),r.stop(c+t)}var Z={shot:()=>{let t=nt(50),e=-nt(50);j({freq:220+t+e,dur:.05+nt(3)/100,type:"square",vol:.25,slide:120}),De({dur:.03+nt(3)/100,vol:.15,lp:800})},pickup:()=>{j({freq:880,dur:.06,type:"triangle",vol:.2}),j({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{De({dur:1,vol:.3,lp:800}),j({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{j({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;j({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),j({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),j({freq:90,dur:.08,type:"sine",vol:.18}),De({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{j({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{j({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{j({freq:600,dur:.5,type:"sawtooth",vol:.2}),j({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),j({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function So(t,{volume:e=.15}={}){if(X)try{if(!be||t!==L0){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();be=await X.decodeAudioData(n),L0=t}R0(),J=X.createBufferSource(),J.buffer=be,J.loop=!0,_t=X.createGain(),_t.gain.value=e,J.connect(_t).connect(X.destination),J.start()}catch(o){try{R0();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),J={stop:()=>n.pause(),disconnect:()=>{}},_t=null}catch(n){}}}function R0(){try{J&&J.stop(0)}catch(t){}if(J&&J.disconnect)try{J.disconnect()}catch(t){}if(_t)try{_t.disconnect()}catch(t){}J=null,_t=null}var O0=!1;async function ke(){if(!X||J||O0)return;O0=!0,await So("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function kt(t,e){if(t<0||e<0||t>=f.MAP_W||e>=f.MAP_H)return!0;let o=f.MAP[e|0][t|0];return o===7?!i.hasBlueKey:ct[o]?ct[o].collide:!0}function Et(t,e,o){return!!(kt(t,e)||kt(t-o,e)||kt(t+o,e)||kt(t,e-o)||kt(t,e+o))}var Rt={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},Mo={[Rt.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:Io,ignoreBounds:!1},[Rt.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:vo,ignoreBounds:!0}},Wt=[];function B0(t,e,o,n,s={}){let r=Mo[t];if(!r)return console.warn(`Unknown effect type: ${t}`),null;let a={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:s.lifetime??r.lifetime,opacity:s.startOpacity??r.startOpacity,startOpacity:s.startOpacity??r.startOpacity,endOpacity:s.endOpacity??r.endOpacity,...r,...s};return Wt.push(a),a}function H0(t,e,o,n={}){return B0(Rt.EXPLOSION,t,e,o,n)}function Ie({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){B0(Rt.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function Y0(t){for(let e=Wt.length-1;e>=0;e--){let o=Wt[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);Co(o,n),o.age>=o.lifetime&&Wt.splice(e,1)}}function Co(t,e){switch(t.type){case Rt.EXPLOSION:To(t,e);break;case Rt.SCREEN_FLASH:bo(t,e);break}}function To(t,e){t.opacity=jt(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=jt(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function bo(t,e){let o=1-(1-e)*(1-e);t.opacity=jt(t.startOpacity,t.endOpacity,o)}function Do(){return Wt}function N0(t,e,o,n,s){let r=Do();if(r.length!==0){t.save();for(let a of r)_o(t,a,e,o,n,s);t.restore()}}function _o(t,e,o,n,s,r){let a=ko(e.x,e.y,o,n,s,r,e.ignoreBounds);!a&&!e.ignoreBounds||e.renderFunction(t,e,a)}function ko(t,e,o,n,s,r,a=!1){let l=t-r.x,c=e-r.y,{dirY:p,dirX:h,planeY:y,planeX:x,invDet:A}=o,E=A*(p*l-h*c),g=A*(-y*l+x*c);return g<=.1&&!a?null:a?{x:n/2,y:s/2,radius:s,depth:g}:{x:n/2*(1+E/g),y:s/2+64,radius:s/g*.5,depth:g}}function Io(t,e,o){let n=o.radius*e.radius,s=performance.now()*.001,r=Math.sin(s*8)*12,a=Math.sin(s*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+r*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+r}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*a,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+r*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+r*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function vo(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var Gt={[v.entity]:{type:v.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[v.ball]:{type:v.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[v.sparkle]:{type:v.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[v.barrel]:{type:v.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[v.food]:{type:v.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[v.key]:{type:v.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},ve=null,zt=null;function X0(t,e){ve=t,zt=e}var Vt={[v.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,ve&&z.push(ve(v.sparkle,{x:t.x,y:t.y})));let o=i.x-t.x,n=i.y-t.y,s=Math.hypot(o,n);if(s>.3){let r=1*e,a=o/s,l=n/s,c=t.x+a*r,p=t.y+l*r;Et(c,t.y,.4)||(t.x=c),Et(t.x,p,.4)||(t.y=p)}s<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,mt(),R("Ball attacks!"),Z.hurt(),t.hurtCD=.8,Ie({color:"	#740707",duration:.5}),Fe()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(R(yt(["Ball Hit!"])),t.health-=1,Z.killedEntity()):(t.alive=!1,R(yt(["Ball Busted!"])),Z.killedEntity()):R("No arrows.")},onTouch(t){se(v.entity,1e4)&&R("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,Z.killedEntity(),R("The ball is blown to bits.")}},[v.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[v.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=i.x-t.x,n=i.y-t.y,s=Math.hypot(o,n);if(s>.3){let r=1.5*e,a=o/s,l=n/s,c=t.x+a*r,p=t.y+l*r;Et(c,t.y,.4)||(t.x=c),Et(t.x,p,.4)||(t.y=p)}s<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,mt(),R("Entity attacks!"),Z.hurt(),t.hurtCD=.8,Ie({color:"	#740707",duration:.5}),Fe()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,R(yt(["Entity murdered!","Entity destroyed!","Entity purged!"])),Z.killedEntity()):R("No arrows.")},onTouch(t){se(v.entity,1e4)&&R("You hear something like water nearby...")},onExplode(t){t.alive=!1,Z.killedEntity(),R("The entity is blown to gibs.")}},[v.barrel]:{onHit(t,e){e?(t.alive=!1,zt&&zt(t.x,t.y,2.5),R("Kaboom!"),Z.explode()):R("No arrows.")},onTouch(t){se(v.barrel,1e4)&&R("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,zt&&zt(t.x,t.y,2.5)}},[v.food]:{onTouch(t){t.alive=!1;let e=i.health>=i.maxHealth;e&&(i.maxHealth+=1),i.health=lt(i.health+10,0,i.maxHealth),R(e?"Yummy!":"Health restored."),mt(),Z.pickup()},onExplode(t){}},[v.key]:{onTouch(t){t.alive=!1,i.hasBlueKey=!0,Z.door(),R("Keycard found! Find the exit!"),Pe()},onExplode(t){t.alive=!1,i.hasBlueKey=!0,Z.door(),R("The forcefield protecting the exit has suddenly lifted!"),Pe()}}};Object.freeze(Gt);for(let t in Gt)Object.freeze(Gt[t]);Object.freeze(Vt);for(let t in Vt)Object.freeze(Vt[t]);var Po=Gt,Fo=Vt,Lo=0;function wt(t,e={x:0,y:0},o=void 0){let n=Po[t],s=Fo[t],r=Object.assign(Object.create(s),n);return r.id=Lo++,r.x=e.x,r.y=e.y,r.dist=0,r.alive=!0,r.hurtCD=0,o&&Object.assign(r,o),r}function Ro(t,e,o){H0(t,e,o);for(let n of z){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}X0(wt,Ro);var Le=0,Q=new Set,Oo=0,Re=!1;function G0(t){window.addEventListener("keydown",e=>{if(Q.add(e.code),_e(),ke(),e.code==="Space"&&(e.preventDefault(),W0()),e.code==="KeyM"&&(e.preventDefault(),it.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(i.mouseSensitivity){case .33:R("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .22:R("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break;case .11:R("Mouse sensitivity set to low."),i.mouseSensitivity=.05;break;case .05:R("Mouse sensitivity already lowest."),i.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(i.mouseSensitivity){case .33:R("Mouse sensitivity already set to highest."),i.mouseSensitivity=.33;break;case .22:R("Mouse sensitivity set to highest."),i.mouseSensitivity=.33;break;case .11:R("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .05:R("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>Q.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&W0(),Oo=e.clientX,_e(),ke()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*i.mouseSensitivity);i.a+=n}}),a0.onclick=()=>Xo(),l0.onclick=()=>it.classList.toggle("visible")}function V0(t){let e=Q.has("ShiftLeft")||Q.has("ShiftRight"),o=i.rotSpeed*t,n=i.accel*t,s=Math.cos(i.a),r=Math.sin(i.a),a=-r,l=s;i.weaponAnim>.75&&(i.weaponAnim=-1),i.weaponAnim>=0&&(i.weaponAnim+=t);let c=3;i.velX-=i.velX*c*t,i.velY-=i.velY*c*t,Math.abs(i.velX)<.002&&(i.velX=0),Math.abs(i.velY)<.002&&(i.velY=0),i.isMoving=!1;let p=0,h=0;Q.has("ArrowLeft")&&(i.a-=o),Q.has("ArrowRight")&&(i.a+=o),(Q.has("ArrowUp")||Q.has("KeyW"))&&(p+=s*n,h+=r*n,i.isMoving=!0),(Q.has("ArrowDown")||Q.has("KeyS"))&&(p-=s*n,h-=r*n,i.isMoving=!0),Q.has("KeyA")&&(p-=a*n,h-=l*n,i.isMoving=!0),Q.has("KeyD")&&(p+=a*n,h+=l*n,i.isMoving=!0),i.velX+=p,i.velY+=h;let y=Math.hypot(i.velX,i.velY);y>20&&(i.velX*=20/y,i.velY*=20/y);let x=i.x+i.velX*t,A=i.y+i.velY*t;if(Et(x,i.y,he)?i.velX=0:i.x=x,Et(i.x,A,he)?i.velY=0:i.y=A,i.health>=0){let E=G[(i.y|0)*f.MAP_W+(i.x|0)],g=f.zones[E]?.floorDepth||0;(i._currentZoneId!==E||i._currentFloorDepth!==g)&&(i._currentZoneId=E,i._currentFloorDepth=g,Nt())}}function W0(){if(i.weaponAnim>=0)return;i.weaponAnim=0,mt(),Z.shot();let t=ee(),e=Bo(t);!e||Xt(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function q0(){for(let t of z){if(!t.alive)continue;Math.hypot(t.x-i.x,t.y-i.y)<.6&&t.onTouch&&t.onTouch(t)}}function Z0(){if(Re)return;let t=i.x|0,e=i.y|0;f.MAP[e][t]===5&&(Z.portal(),R(`Floor ${Ct} cleared.`),ge(Ct+1),Re=!0,i.velX=0,i.velY=0,setTimeout(()=>{No(!0),Re=!1},100))}function Bo(t){let o=document.getElementById("view").width>>1|0,n=rt(o,N)||1e9,s=null,r=1e9;for(let a of z){if(!a.alive)continue;let l=Xt(a,t);l&&(i.sightDist>0&&l.depth>i.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<r&&(s=a,r=l.depth))}return s}function qt(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(f.MAP_W-2)|0)+1,n=(Math.random()*(f.MAP_H-2)|0)+1;if(f.MAP[n][o]!==0)continue;let s=o+.5-i.x,r=n+.5-i.y;if(!(Math.hypot(s,r)<t))return{x:o,y:n}}return{x:9,y:9}}var Be=new Map;function U0(){Be.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=f;for(let s=0;s<n.length;s++){let r=n[s],a=Math.min(r.x,r.x+r.w),l=Math.max(r.x,r.x+r.w)-1,c=Math.min(r.y,r.y+r.h),p=Math.max(r.y,r.y+r.h)-1,h=lt(a,0,t-1),y=lt(l,0,t-1),x=lt(c,0,e-1),A=lt(p,0,e-1),E=[];for(let g=x;g<=A;g++)for(let I=h;I<=y;I++)kt(I,g)||E.push({x:I,y:g});Be.set(s,E)}}function Ho(t){let e=Be.get(t);return!e||e.length===0?null:yt(e)}function Pe(){let t=f.MAP_W,e=f.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)f.MAP[o][n]===7&&(f.MAP[o][n]=0)}function $0(){let t=pt.x,e=pt.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(f.MAP[o][n]=7)}function K0(){if(z.length=0,nt(100)<50)for(let o=0;o<nt(2)*(f.MAP_H/20|0);o++){let n=qt(1);z.push(wt(v.barrel,{x:n.x+.5,y:n.y+.5}))}let t=qt(4);z.push(wt(v.key,{x:t.x+.5,y:t.y+.5})),t=qt(4),z.push(wt(v.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(Ct-1)*2)*(f.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=qt(3.5);z.push(wt(v.entity,{x:n.x+.5,y:n.y+.5}))}t=qt(4),z.push(wt(v.ball,{x:t.x+.5,y:t.y+.5})),f.zones.forEach((o,n)=>{let s=n;o.spawnRules?.forEach(a=>{let l=Math.max(0,a.amount|0);for(let c=0;c<l;c++){let p=Ho(s);if(!p)break;z.push(wt(a.entityType,{x:p.x+.5,y:p.y+.5}))}})})}function mt(){o0.style.width=`${i.health/i.maxHealth*100}%`,n0.style.width=`${i.ammo/60*100}%`,i0.textContent=Math.max(0,i.health),r0.textContent=i.ammo}var Oe=0,He=0,Ye=!1,z0=!1;function R(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let r=n.innerHTML,a=r.match(/^(.*?)(?:\s+x(\d+))?$/),l=a?a[1]:r,c=a&&a[2]?parseInt(a[2]):1;if(l===t){let p=a&&a[2]?c+1:2;n.innerHTML=`${t} x${p}`;return}}let s=document.createElement("div");s.innerHTML=t,o.prepend(s),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function j0(t){Oe>0&&(Oe-=t,Oe<=0&&(s0.textContent=i.hasBlueKey?"Find the exit.":"Find the key card."))}function Fe(){Ye||i.health<=0&&(Ye=!0,i.speed=0,i.rotSpeed=0,He=2,R("YOU DIED! Soul disconnecting from the node..."))}function J0(t){Ye&&(He-=t,He<=0&&Yo())}function Yo(){if(z0)return;z0=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",s=>{s.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),Q.clear()}}function Ne(t=!1){t&&Ot(),i.x=xt.x,i.y=xt.y,i.a=0,i.hasBlueKey=!1,f.MAP[pt.y][pt.x]=5,$0(),K0(),mt(),R(`Floor ${Ct}: Find the keycard.`)}function No(t=!1){t&&(Le>=Ht.length-1?Ot():(Le+=1,Ot(Le))),i.x=xt.x,i.y=xt.y,i.a=0,i.hasBlueKey=!1,f.MAP[pt.y][pt.x]=5,$0(),K0(),mt(),R(`Floor ${Ct}: Find the keycard.`)}function Xo(){ge(1),Ot(0),Ne()}function Q0(t){for(let e of z)e.alive&&e.ai&&e.ai(e,t)}G0(vt);var Ve=null,qe=null,Xe=0,We=0,ce=performance.now(),le=new Map;function se(t,e=0){if(e===0)return!(ce<le.get(t));let o=ce,n=le.get(t)??0;return o<n?!1:(le.set(t,o+e),!0)}function cr(t){le.set(t,performance.now())}async function Wo(){let t=_|0,e=m|0,o=async p=>{if(!Bt)return p;try{return p.transferToImageBitmap?p.transferToImageBitmap():await createImageBitmap(p)}catch(h){return console.warn("Vignette ImageBitmap conversion failed:",h),p}},n=new OffscreenCanvas(t,e),s=n.getContext("2d");s.imageSmoothingEnabled=!1;let r=s.createLinearGradient(0,0,t*.5,0);r.addColorStop(.35,"rgba(0,0,0,1)"),r.addColorStop(1,"rgba(0,0,0,0)"),s.fillStyle=r,s.fillRect(0,0,t*.5,e);let a=new OffscreenCanvas(t,e),l=a.getContext("2d");l.imageSmoothingEnabled=!1;let c=l.createLinearGradient(t,0,t*.5,0);c.addColorStop(.35,"rgba(0,0,0,1)"),c.addColorStop(1,"rgba(0,0,0,0)"),l.fillStyle=c,l.fillRect(t*.5,0,t*.5,e),Ve=await o(n),qe=await o(a)}Wo();var ae=0;function zo(t){let e=`FPS: ${Math.round(t)}`;d.save(),d.font="12px monospace",d.textAlign="right",d.textBaseline="top";let o=_-8,n=6,s=d.measureText(e).width+8,r=16;d.fillStyle="rgba(10, 15, 25, 0.6)",d.fillRect(o-s,n-2,s,r),d.strokeStyle="rgba(60, 80, 130, 0.9)",d.strokeRect(o-s+.5,n-2+.5,s-1,r-1),d.fillStyle="#dfe6ff",d.fillText(e,o,n),d.restore()}function Ot(t=-1){let e;if(t!==-1){let o=Ht[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=yt(Ht);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}pt.x=e.exitPos.x,pt.y=e.exitPos.y,xt.x=e.startPos.x,xt.y=e.startPos.y,i.sightDist=e.FAR_PLANE||d0,f.cielingColorFront=e.cielingColorFront||"#6495ED",f.floorColorFront=e.floorColorFront||"#054213",f.cielingColorBack=e.cielingColorBack||"#6495ED",f.floorColorBack=e.floorColorBack||"#03210A",f.dontSpawnKey=e.dontSpawnKey||!1,f.dontPersist=e.dontPersist||!1,f.MAP=e.mapLayout,f.MAP_W=f.MAP[0].length,f.MAP_H=f.MAP.length,f.zones=e.zones,f.name=e.name,U0(),S0(),C0(),i.x=i.x=e.startPos.x,i.y=e.startPos.y,Nt()}async function Go(){await v0(),await e0(),Ot(0),Ne(),i.maxHealth=nt(5)+nt(5),i.health=i.maxHealth,i.ammo=0,mt(),requestAnimationFrame(oo)}function Vo(t){let e=ee();if(f.zones.length<=2)M0(d);else{for(let o=0;o<_;o++)b0(t,e,o,0);k0(d)}if(f.zones.length<=2){let o=i.x|0,n=i.y|0,s=G[n*f.MAP_W+o],r=re[s];if(!r){let a=f.zones[s].fogColor;r=d.createLinearGradient(0,m,0,N),r.addColorStop(0,f.floorColorFront||"#054213"),r.addColorStop(.85,f.floorColorBack||"#03210A"),r.addColorStop(.95,a||ft),re[s]=r}d.fillStyle=r,d.fillRect(0,N,_,N)}else{for(let o=0;o<_;o++)T0(t,e,o,0);_0(d)}D0(d),I0(t,e,f.MAP,f.MAP_W,f.MAP_H),qo(),z.sort((o,n)=>n.dist-o.dist),Zo(e),Qo(t),tn(),N0(d,e,_,m,i)}function qo(){for(let t of z){let e=t.x-i.x,o=t.y-i.y;t.dist=e*e+o*o}}function Zo(t){d.save();for(let e of z){if(!e.alive||Math.hypot(e.x-i.x,e.y-i.y)>i.sightDist)continue;let n=Xt(e,t);if(!n||i.sightDist>0&&n.depth>i.sightDist||n.drawEndX<0||n.drawStartX>=_)continue;let s=[n.drawStartX,n.drawStartX+n.drawEndX>>1,n.drawEndX-1],r=[n.drawStartY,n.drawStartY+n.drawEndY>>1,n.drawEndY-1],a=!1;for(let c of s){for(let p of r)if(n.depth<rt(c|0,p|0)){a=!0;break}if(a)break}if(!a)continue;let l=Ko(n);$o(e,n,l),d.filter="none"}d.restore()}var ze=1e-4,st=null,ht=null,to=0;function Uo(t){(to!==t||!st||!ht)&&(st=new Int16Array(t),ht=new Int16Array(t),to=t),st.fill(-1),ht.fill(-1)}function $o(t,e,o){let n=Jo(e,o);n&&(d.filter=n);let s=P[t.img],r=e.drawStartY|0,a=e.drawEndY|0,l=a-r;if(!s||l<=0){d.filter="none";return}let c=e.width??e.drawEndX-e.drawStartX,p=e.occludedTop??0,h=e.occludedBottom??0,y=r+p|0,x=a-h|0,A=y>0?y:0,E=m<x?m:x;if(E-A<=0){d.filter="none";return}let g=e.drawStartX>0?e.drawStartX|0:0,I=e.drawEndX<_?e.drawEndX|0:_;if(g>=I){d.filter="none";return}Uo(_);let B=k=>(k-(e.drawStartX|0))*s.width/c|0,u=E-A|0,C=Math.min(10,u),F=-1,b=-1;for(let k=g;k<I;k++){let T=!1,L=E-1|0,M=A|0;for(let w=0;w<C;w++){let O=C===1?.5:w/(C-1),V=A+O*(u-1)|0,Y=rt(k,V);e.depth+ze<Y&&(T=!0,V<L&&(L=V),V>M&&(M=V))}if(T){for(let w=L-1;w>=A;w--){let O=rt(k,w);if(e.depth+ze<O)L=w;else break}for(let w=M+1;w<E;w++){let O=rt(k,w);if(e.depth+ze<O)M=w;else break}st[k]=L,ht[k]=M,F===-1&&(F=k),b=k}}if(F===-1){d.filter="none";return}let S=[],D=F;for(;D<=b;){for(;D<=b&&st[D]<0;)D++;if(D>b)break;let k=D,T=st[D],L=ht[D];for(;D<=b&&st[D]>=0;)st[D]<T&&(T=st[D]),ht[D]>L&&(L=ht[D]),D++;let M=D-1;S.push({start:k,end:M,minTop:T,maxBot:L})}let H=Math.max(1,a-r);for(let k=0;k<S.length;k++){let{start:T,end:L,minTop:M,maxBot:w}=S[k],O=pe(B(T),0,s.width),V=pe(B(L+1),0,s.width),Y=Math.max(0,V-O),U=L-T+1;if(Y<=0||U<=0)continue;let $=Math.round(s.height*((M-r)/H)),ot=Math.round(s.height*((w-r+1)/H)),at=Math.max(1,ot-$),tt=w-M+1;d.save(),d.beginPath(),d.moveTo(T,st[T]);for(let W=T+1;W<=L;W++)d.lineTo(W,st[W]);d.lineTo(L,ht[L]+1);for(let W=L-1;W>=T;W--)d.lineTo(W,ht[W]+1);d.closePath(),d.clip(),d.drawImage(s,O,$,Y,at,T,M,U,tt),d.restore()}d.filter="none"}function Ko(t){let e=1/(1+t.depth*.3);if(i.sightDist>0&&t.depth>i.sightDist*Pt){let s=i.sightDist*Pt,r=Math.min(1,Math.max(0,(t.depth-s)/Math.max(1e-6,i.sightDist-s)));e*=1-r*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((s,r)=>Math.abs(r-e)<Math.abs(s-e)?r:s,o[0])}}function jo(t){if(i.sightDist<=0)return 0;let e=i.sightDist*Pt,o=i.sightDist;return t<=e?0:t>=o?1:(t-e)/(o-e)}function Jo(t,e){let o=[];e.quantizedShade<.999&&o.push(`brightness(${e.quantizedShade})`);let n=jo(t.depth);return o.push(`opacity(${1-n})`),o.length>0?o.join(" "):null}function Qo(t){if(!P.pitchfork)return;let e=Math.round(_*.42),o=Math.round(e*(P.pitchfork.height/P.pitchfork.width)),n=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*5):0,s=Math.max(8,_*.02|0),r=_*.5-e/2-s/2+n,a=(i.weaponAnim+1)**10,l=a>7?7:a,c=i.weaponAnim>=0?100-l*20:0,p=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*10):0,h=m-o-s+70+p+c;d.drawImage(P.pitchfork,r,h,e,o)}function tn(){if(!Ve||!qe)return;let t=en(),e={center:Ge(t.center),left:Ge(t.left),right:Ge(t.right)},o=on(e);Xe=Xe*.85+o.left*.15,We=We*.85+o.right*.15,eo(Ve,Xe),eo(qe,We)}function en(){let e=Math.max(6,_*.28|0),o=Math.max(8,_*.3|0),n=_-o>>1|0,s=n+o,r=0,a=Math.min(_,e),l=Math.max(0,_-e),c=_,p=(h,y)=>{let x=Number.POSITIVE_INFINITY;for(let A=h;A<y;A++){let E=rt(A,N);E<x&&(x=E)}return x};return{center:p(n,s),left:p(r,a),right:p(l,c)}}function Ge(t){let e=Math.max(m0,1e-6),o=Math.max(e+1e-6,u0);if(!isFinite(t))return 0;let n=(t-e)/(o-e);return Math.max(0,Math.min(1,1-n))}function on(t){let{left:e,right:o}=t,n=0,s=0,r=Math.min(e,o),a=Math.max(e,o),l=.05;return r>.5?(n=r,s=r):e>o+l?(n=a,s=0):o>e+l?(s=a,n=0):(n=a,s=a),{left:n,right:s}}function eo(t,e){t&&e>.001&&(d.save(),d.globalAlpha=Math.min(1,e),d.drawImage(t,0,0),d.restore())}function oo(t){let e=Math.min(.05,(t-ce)/1e3);ce=t;let o=e>0?1/e:0;ae=ae?ae*.9+o*.1:o,i.health>0&&V0(e),Q0(e),Y0(e),q0(),Vo(t/1e3),it.classList.contains("visible")&&F0(z),Z0(),j0(e),J0(e),zo(ae),Bt?Qt.drawImage(Jt.transferToImageBitmap(),0,0):Qt.drawImage(Jt,0,0),requestAnimationFrame(oo)}Go().catch(console.error);export{Ot as ChangeMapLevel,cr as resetCooldown,se as tryCooldown};
