import{a as Mt,b as qe,c as _0,d as K,e as te,f as Ue,g as ee,h as Ve,i as A}from"../chunks/chunk-KGWCYQQM.js";var o0=document.getElementById("view");o0.width=480;o0.height=270;var P=480,m=270,R0=new OffscreenCanvas(P,m),d=R0.getContext("2d",{colorSpace:"srgb"});d.imageSmoothingEnabled=!1;var P0=o0.getContext("2d",{colorSpace:"srgb"});P0.imageSmoothingEnabled=!1;o0.style.filter="brightness(1.15) contrast(1.06)";var gt=document.getElementById("mini"),Z=gt.getContext("2d");Z.imageSmoothingEnabled=!1;var Ze=document.getElementById("hpBar"),$e=document.getElementById("ammoBar"),je=document.getElementById("hpText"),Ke=document.getElementById("ammoText"),Je=document.getElementById("msg"),Qe=document.getElementById("btnReset"),to=document.getElementById("btnToggleMap"),O0=typeof createImageBitmap<"u"&&typeof ImageBitmap<"u";var Qo=90*Math.PI/180,ne=Qo*.5,ro=.01,ie=.01,so=15;var n0=.6,Ct="#101b2e";var i={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,mouseSensitivity:.22,height:1.2,calculatePlayerHeight:()=>{if(2-i.height<.01)return .01;let t=i.getCurrentFloorDepth?i.getCurrentFloorDepth():0;return(2-i.height-t)*1},getCurrentZoneId:()=>i._currentZoneId||0,getCurrentFloorDepth:()=>i._currentFloorDepth||0,_currentZoneId:0,_currentFloorDepth:0},re=.2,qt=1,ao=1,tn=99;function se(t){qt=Math.max(ao,Math.min(tn,t|0||ao))}function H0(){let t=Math.cos(i.a),e=Math.sin(i.a),o=-e*Math.tan(ne),n=t*Math.tan(ne),r=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:r}}var lo=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,8,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,8,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{x:0,y:0,w:1,h:1,color:"#054213",cielingColorFront:"#6495ed",outside:!0,spawnRules:[]},{x:0,y:2,w:20,h:2,color:"#0011ff",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",spawnRules:[],floorDepth:-.5,isLiquid:!0,outside:!0},{x:15,y:7,w:1,h:3,color:"#6f2801",cielingColorFront:"#8b8000",cielingColorBack:"#000000",ceilingHeight:"6",floorColorBack:"#000000",fogColor:"#000000",floorDepth:.33,spawnRules:[{entityType:"food",amount:2}]},{x:3,y:5,w:14,h:12,color:"#8b8000",cielingColorFront:"#8b8000",cielingColorBack:"#00000000",ceilingHeight:6,floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5}]},{x:1,y:0,w:18,h:19,color:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",outside:!0,spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];function Lt(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=ct(t.length)-1;return t[e]}function ct(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function B0(t,e,o){return t+(e-t)*o}function co(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,r=o-1;for(;n<=r;){let s=n+r>>1,a=t[s];if(a===e)return s;a<e?n=s+1:r=s-1}return e-t[r]<=t[n]-e?r:n}function ae(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var St={x:10,y:8},Ht={x:3.5,y:3.5};var f={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},y0=lo,fo=new Map;function uo(t){let e=f.zones,o=e&&e[t]?.color||Ct,n=fo.get(o);return n||(n=ae(o),fo.set(o,n)),n}var po=new Map;function ho(t){let e=f.zones,o=e&&e[t]?.cielingColorFront||Ct,n=po.get(o);return n||(n=ae(o),po.set(o,n)),n}function mo(t,e,o){for(let n=0;n<o.length;n++){let r=o[n],s=Math.min(r.x,r.x+r.w),a=Math.max(r.x,r.x+r.w)-1,l=Math.min(r.y,r.y+r.h),c=Math.max(r.y,r.y+r.h)-1;if(t>=s&&t<=a&&e>=l&&e<=c)return n}return 0}var ft=new Float32Array(P),G=m>>1,x0=new Int16Array(P).fill(G),ot=new Int16Array(P).fill(G),i0=new Float32Array(m),fe=new Float32Array(m),Ut={},r0={},le=G;function E0(){for(let r in r0)delete r0[r];for(let r in Ut)delete Ut[r];let t=i.calculatePlayerHeight(),o=2-0,n=m*(o-t)*.5;for(let r=0;r<m;r++){let s=r-le;i0[r]=s!==0?n/s:1e-6;let l=2-2,c=m*(l+t)*.5;fe[r]=s!==0?-c/s:-1e-6}for(let r=0;r<f.zones.length;r++){let s=f.zones[r];if(s.ceilingHeight!==void 0){r0[r]=new Float32Array(m);for(let a=0;a<m;a++){let l=a-le,u=s.ceilingHeight-2,E=m*(u+t)*.5;r0[r][a]=l!==0?-E/l:-1e-6}}if(s.floorDepth!==void 0){let l=2-s.floorDepth,c=m*(l-t)*.5;Ut[r]=new Float32Array(m);for(let u=0;u<m;u++){let E=u-le;Ut[r][u]=E!==0?c/E:1e-6}}}}E0();var pe=[],ue=[],de=[],N0=[],q=[],he=[];function go(){pe.length=0,ue.length=0,de.length=0,N0.length=0,he.length=0,me.clear(),ge.clear()}function Bt(t,e,o,n,r,s,a,l,c,u){if(!r)return;let E=n-o;if(E<=0)return;let p=l||0,M=p<0?0:p>r.height?r.height:p,w=c||r.height,y=r.height-M,g=w<0?0:w>y?y:w,T=co(te,a);t.drawImage(Ue[u][te[T]],s,M,1,g,e,o,1,E)}function yo(t){let e=i.x|0,o=i.y|0,n=q[o*f.MAP_W+e],r=pe[n];if(!r){r=t.createLinearGradient(0,0,0,G);let s=f.zones[n].cielingColorFront,a=f.zones[n].cielingColorBack,l=f.zones[n].fogColor;r.addColorStop(0,s||f.cielingColorFront||"#6495ED"),f.cielingColorBack&&r.addColorStop(.5,a||f.cielingColorBack||"#6495ED"),r.addColorStop(.9,l||Ct),pe[n]=r}t.fillStyle=r,t.fillRect(0,0,P,G)}var me=new Map;function ce(t){let e=me.get(t);if(!e){let[o,n,r]=uo(t);e=`rgb(${o|0},${n|0},${r|0})`,me.set(t,e)}return e}var ge=new Map;function Y0(t){let e=ge.get(t);if(!e){let[o,n,r]=ho(t);e=`rgb(${o|0},${n|0},${r|0})`,ge.set(t,e)}return e}function xo(){q.length=0;let t=f.zones,e=f.MAP_W,o=f.MAP_H;for(let n=0;n<o;n++)for(let r=0;r<e;r++)q[n*e+r]=mo(r,n,t)}function Eo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e;n=x0[o]??G;let c=n<G?G:n;if(c>=m)return;let u=2*(o+.5)/P-1,E=r+a*u,p=s+l*u;if(i.sightDist>0){let I=ft[o]??1/0;for(;c<m;){let _=i0[c]??1/0;if(_<=i.sightDist&&_<=I)break;c++}if(c>=m)return}let M="#000000",w=f.MAP_W,y=f.MAP_H,g=1/(r*E+s*p),T=E*g,v=p*g,h=0;function k(I,_=0){let R=i0[I]??i0[i0.length-1]??1/0,O=i.x+T*R,b=i.y+v*R,tt=O|0,ut=b|0;return tt>=0&&ut>=0&&tt<w&&ut<y?q[ut*w+tt]:0}let B=I=>Math.max(8,Math.min(64,8+(I-G>>>3)));h=k(c,h);let x=c,F=null;for(;c<m;){let I=Math.min(B(c),m-1-c);if(I<=0)break;let _=c+I;if(k(_,h)===h){let dt=c+_>>1;if(k(dt,h)===h){let bt=ce(h);bt!==F&&(d.fillStyle=bt,F=bt);let st=_+1-x;st>0&&d.fillRect(o,x,1,st),c=_+1,x=c;continue}}let O=c,b=_;for(;b-O>1;){let dt=O+b>>1;k(dt,h)===h?O=dt:b=dt}let tt=ce(h);tt!==F&&(d.fillStyle=tt,F=tt);let ut=b-x;ut>0&&d.fillRect(o,x,1,ut);let $=k(b,h),L=f.zones[h]?.floorDepth??0,vt=f.zones[$]?.floorDepth??0,l0=x0[o]??G,Xt=Ut?.[h]?.[b]??i0[b]??1/0,b0=ft[o]??1/0,D0=b===l0,Pe=Xt>=b0-.11;if(!!M&&L!==vt&&!D0&&!Pe&&!(x===l0)){let dt=f.zones[h]||{},bt=f.zones[$]||{},st=dt.floorDepth??0,_t=bt.floorDepth??0,et=!!dt.isLiquid,jt=!!bt.isLiquid,U=0;if(et||jt)U=st>_t?7:2;else{let U0=st-_t,c0=Ut?.[h]?.[b],f0=Ut?.[$]?.[b],Dt=Xt;(Number.isFinite(c0)||Number.isFinite(f0))&&(Dt=Math.min(c0??1/0,f0??1/0,Xt??1/0),Number.isFinite(Dt)||(Dt=Xt));let Jt=m*U0*.5/Dt;U=Math.max(1,Jt|0),U=st>_t?U:0}let Kt=b,at=Kt+U;if(k(b,h)!==k(at-1,$))F=null,h=$;else{at>Kt&&(d.fillStyle!==M&&(d.fillStyle=M),d.fillRect(o,Kt,1,at-Kt)),F=null,h=$,c=at,x=c;continue}}h=$,c=b,x=c}if(x<m){let I=ce(h);I!==F&&(d.fillStyle=I),d.fillRect(o,x,1,m-x)}}function wo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e,c=ot[o]??G,u=0;if(c<=0)return;let E=2*(o+.5)/P-1,p=r+a*E,M=s+l*E,w=1/(r*p+s*M),y=0,g=r0?.[y]?.[u]??fe[u],T=i.x+p*g*w,v=i.y+M*g*w,h=u,k=null;for(let x=u;x<c;x++){if(i.sightDist>0&&Math.abs(g)>i.sightDist){let b=Y0(y);b!==k&&(d.fillStyle=b),d.fillRect(o,h,1,x-h);return}if(g>ft[o]){let b=Y0(y);b!==k&&(d.fillStyle=b),d.fillRect(o,h,1,x-h);return}let F=T|0,I=v|0,_=F>=0&&I>=0&&F<f.MAP_W&&I<f.MAP_H?q[I*f.MAP_W+F]:y;if(_!==y){let b=Y0(y);b!==k&&(d.fillStyle=b,k=b),d.fillRect(o,h,1,x-h),y=_,h=x}let R=r0?.[y]?.[x+1]??fe[x+1]??g,O=R-g;T+=p*O*w,v+=M*O*w,g=R}let B=Y0(y);B!==k&&(d.fillStyle=B),d.fillRect(o,h,1,c-h)}function Mo(t){let e=de[0];e||(e=t.createLinearGradient(0,0,0,m),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),de[0]=e),t.fillStyle=e,t.fillRect(0,0,P,m)}function Co(t){let e=G-1,o=m-e,n=i.x|0,r=i.y|0,s=q[r*f.MAP_W+n],a=ue[s];if(!a){let l=f.zones[s].floorColorBack;a=t.createLinearGradient(0,e,0,m),a.addColorStop(.05,f.zones[s].fogColor||Ct),a.addColorStop(.15,l||f.floorColorBack||"#03210A"),a.addColorStop(1,"rgba(0,0,0,0)"),ue[s]=a}t.fillStyle=a,t.fillRect(0,e,P,o)}function So(t){let o=G+1,n=i.x|0,r=i.y|0,s=q[r*f.MAP_W+n],a=he[s];if(!a){let l=f.zones[s].fogColor||Ct,c=f.zones[s].cielingColorBack||f.cielingColorBack||"#6495ED";a=t.createLinearGradient(0,0,0,0+o),a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(.85,c),a.addColorStop(.95,l),he[s]=a}t.fillStyle=a,t.fillRect(0,0,P,o)}function Ao(t,e,o,n,r){let{dirX:s,dirY:a,planeX:l,planeY:c}=e,u=i.sightDist>0;function E(p,M,w,y){if(i.sightDist<=0)return;let g=i.sightDist*n0,T=i.sightDist;if(y<=g)return;let v=M|0,h=w|0;if(v<0&&(v=0),h>m&&(h=m),h<=v)return;let k=Math.min(1,Math.max(0,(y-g)/Math.max(1e-6,T-g))),B=i.x|0,x=i.y|0,F=q.length>0?q[x*f.MAP_W+B]|0:0;d.save(),d.globalAlpha=k*.85,d.fillStyle=f.zones[F].fogColor||Ct,d.fillRect(p,v,1,h-v),d.restore()}for(let p=0;p<P;p++){let M=2*(p+.5)/P-1,w=s+l*M,y=a+c*M;if(w<1e-8&&w>-1e-8&&y<1e-8&&y>-1e-8){ft[p]=Number.POSITIVE_INFINITY,x0[p]=G,ot[p]=G;continue}let g=1/(w||1e-9),T=1/(y||1e-9),v=i.x|0,h=i.y|0,k=g<0?-g:g,B=T<0?-T:T,x,F,I,_;w<0?(x=-1,I=(i.x-v)*k):(x=1,I=(v+1-i.x)*k),y<0?(F=-1,_=(i.y-h)*B):(F=1,_=(h+1-i.y)*B);let R=0,O=1,b=!1,tt=0,ut=0;for(;!b&&tt++<256;){if(I<_?(I+=k,v+=x,R=0):(_+=B,h+=F,R=1),u){let W=Math.min(I,_);if(W>i.sightDist){b=!1,O=0,ut=W;break}}if(v<0||h<0||v>=n||h>=r){b=!0,O=1;break}let C=o[h][v];if(C>0){b=!0,O=C;break}}let $=O;if(O=K?.[$].textures[0][0]||"hedge",$===0){ft[p]=Number.POSITIVE_INFINITY,x0[p]=G,ot[p]=G;continue}let L;R===0?L=I-k:L=_-B,L=Math.max(ro,L);let vt=0,l0=R===0?x:0,Xt=R===1?F:0,q0=Math.abs(l0*s+Xt*a)>=.9&&Math.abs(M)<=.9&&L<vt?vt:L,dt=i.x+q0*w,bt=i.y+q0*y,st;R===0?st=bt-(bt|0):st=dt-(dt|0),st=Math.min(.999999,Math.max(0,st+1e-6));let _t=ee[O],et=_0[O],jt=et?et.width|0:_t.w|0,U=st*jt|0;(R===0&&x>0||R===1&&F<0)&&(U=jt-U-1),U<0&&(U=0),U>=jt&&(U=jt-1);let Kt=Math.max(ie,L),at=m/Kt|0,U0=i.calculatePlayerHeight(),c0=G,f0=m*(2-U0)*.5,Dt=c0+f0/L,Jt=Dt|0,k0=Dt-at|0,zt=k0,Qt=Jt;zt<0&&(zt=0),Qt>m&&(Qt=m);let V0=v-(R===0?x:0),Z0=h-(R===1?F:0),p0=0;V0>=0&&Z0>=0&&V0<n&&Z0<r&&(p0=q[Z0*n+V0]|0);let Q=K[$].height||1,$0=p0>=0?p0:q[h*n+v]|0,u0=f.zones[$0],d0=u0.ceilingHeight||2;Q=d0/2<Q&&!u0.outside?d0/2:Q;let Oe=Qt-zt;x0[p]=Qt,ot[p]=zt;let jo=Dt-at*(Q>0?Q:1);if(ot[p]=jo,Oe<=0){ft[p]=L;continue}let Le=(et?et.height:_t.h||_0[O]?.height||64)|0,He=(zt-k0)*(Le/Math.max(1,at)),Be=Oe*(Le/Math.max(1,at)),t0=1/(1+L*.25)*(R?.5:1);if(K[$].animated&&(t0*=.8+.2*Math.sin(t*6+p*.05)),Q===1)Bt(d,p,zt,Qt,et,U,t0,He,Be,O);else if(Q>1){Bt(d,p,zt,Qt,et,U,t0,He,Be,O);let C=at,W=(et?.height||_t.h||64)|0,j=W/Math.max(1,C),ht=Math.floor(Q)-1;for(let z=0;z<ht;z++){let yt=k0-C*(z+1),lt=Jt-C*(z+1),Y=Math.max(0,Math.ceil(yt)),xt=Math.min(m,Math.floor(lt)),Et=xt-Y;if(Et<=0)continue;let V=(Y-yt)*j,wt=Et*j;Bt(d,p,Y,xt,et,U,t0,V,wt,K[$].textures[0][z+1])}let Rt=Q-(1+ht);if(Rt>1e-6){let z=C*Rt,yt=k0-C*ht,lt=yt-z,Y=Math.max(0,Math.ceil(lt)),xt=Math.min(m,Math.floor(yt)),Et=xt-Y;if(Et>0){let V=yt-C,wt=(Y-V)*j%W;wt<0&&(wt+=W);let m0=Et*j;Bt(d,p,Y,xt,et,U,t0,wt,m0,K[$].textures[0][1+ht])}}}else if(Q<1){let C=at,W=(et?.height||_t.h||64)|0,j=W/Math.max(1,C),ht=Q;if(ht>1e-6){let Rt=C*ht,z=Jt,yt=z-Rt,lt=Math.max(0,Math.ceil(yt)),Y=Math.min(m,Math.floor(z)),xt=Y-lt;if(xt>0){let Et=z-C,V=(lt-Et)*j%W;V<0&&(V+=W);let wt=xt*j;Bt(d,p,lt,Y,et,U,t0,V,wt,O)}}}{let C=Dt-at*(Q>0?Q:1),W=Math.max(0,Math.ceil(C)),j=Math.min(m,Jt);E(p,W,j,L)}let h0=Q;if((ot[p]|0)>0){let C=ot[p]|0,W=v,j=h,ht=I,Rt=_,z=R,yt=0;for(;C>0&&yt++<i.sightDist-L&&(ht<Rt?(ht+=k,W+=x,z=0):(Rt+=B,j+=F,z=1),!(W<0||j<0||W>=n||j>=r));){let lt=o[j][W]|0;if(lt<=0)continue;let Y=z===0?ht-k:Rt-B;if(u&&Y>i.sightDist)break;let xt=Math.max(ie,Y),Et=m/xt|0,V=K[lt].height;$0=p0>=0?p0:q[j*n+W]|0,u0=f.zones[$0],d0=u0.ceilingHeight||2,V=d0/2<V&&!u0.outside?d0/2:V;let wt=lt;if(V<=h0)continue;let m0=c0+f0/Y;if(!(m0-Et*V<C))continue;let j0=K?.[lt]?.textures[0][h0|0],Ye=i.x+Y*w,Ne=i.y+Y*y,Ko=z===0?Ne-(Ne|0):Ye-(Ye|0),Wt=_0[j0],Xe=ee[j0],F0=Wt?Wt.width|0:Xe.w|0,kt=Ko*F0|0;(z===0&&x>0||z===1&&F<0)&&(kt=F0-kt-1),kt<0&&(kt=0),kt>=F0&&(kt=F0-1);let K0=(Wt?Wt.height:Xe.h||64)|0,J0=1/(1+Y*.25)*(z?.5:1),Gt=Et,e0=K0/Math.max(1,Gt),I0=m0-Gt,ze=m0,N=I0,mt=Math.min(C,ze),Pt=mt-N;if(Pt>0){let Ft=(N-I0)*e0,Ot=Pt*e0;Bt(d,p,N,mt,Wt,kt,J0,Ft,Ot,j0),N<C&&(C=N,C<(ot[p]|0)&&(ot[p]=C)),E(p,N,mt,Y)}let v0=Math.floor(V)-1;for(let Ft=0;Ft<v0&&C>0;Ft++){let Ot=I0-Gt*(Ft+1),Ge=ze-Gt*(Ft+1);if(N=Ot,mt=Math.min(C,Ge)+1,Pt=mt-N,Pt<=0)continue;let Q0=(N-Ot)*e0,g0=Pt*e0;Bt(d,p,N,mt,Wt,kt,J0,Q0,g0,K?.[wt]?.textures[0][(h0|0)+Ft]),N<C&&(C=N,C<(ot[p]|0)&&(ot[p]=C)),E(p,N,mt,Y)}let We=V-(1+v0);if(We>1e-6&&C>0){let Ft=Gt*We,Ot=I0-Gt*Math.max(0,v0);if(N=Ot-Ft,mt=Math.min(C,Ot),Pt=mt-N,Pt>0){let Q0=Ot-Gt,g0=(N-Q0)*e0%K0;g0<0&&(g0+=K0);let Jo=Pt*e0;Bt(d,p,N,mt,Wt,kt,J0,g0,Jo,K?.[wt]?.textures[0][(h0|0)+v0]),N<C&&(C=N,C<(ot[p]|0)&&(ot[p]=C)),E(p,N,mt,Y)}}h0=V}}ft[p]=L}}var en={},S={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function on(t){if(!O0||!t)return t;try{return t.transferToImageBitmap?t.transferToImageBitmap():await createImageBitmap(t)}catch(e){return console.warn("Sprite ImageBitmap conversion failed, using canvas:",e),t}}async function At(t,e){return await nn(t,e,1)}async function nn(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((r,s)=>{let a=new Image;a.onload=()=>{let l=new OffscreenCanvas(a.width*e,a.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(a,0,0,l.width,l.height),l.baseline=o,l.scale=e,r(l)},a.onerror=()=>s(new Error(`Failed to load sprite: ${n}`)),a.src=n})}async function To(){S.food=await At("noodles.png",3),S.bow=await At("bow.png",3),S.pitchfork=await At("pitchfork.png",3),S.keycard1=await At("keycard1.png",3),S.barrel=await At("emp.png",3),S.aiDrone1=await At("aiDrone1.png",3),S.aiDrone2=await At("aiDrone2.png",3),S.aiDrone3=await At("aiDrone3.png",3),S.ball=await At("Palantrash1.png",3),S.sparkle=await At("sparkle.png",3);let t=[{key:"food",canvas:S.food},{key:"bow",canvas:S.bow},{key:"pitchfork",canvas:S.pitchfork},{key:"keycard1",canvas:S.keycard1},{key:"barrel",canvas:S.barrel},{key:"aiDrone1",canvas:S.aiDrone1},{key:"aiDrone2",canvas:S.aiDrone2},{key:"aiDrone3",canvas:S.aiDrone3},{key:"ball",canvas:S.ball},{key:"sparkle",canvas:S.sparkle}].map(async({key:e,canvas:o})=>{let n=await on(o);return S[e]=n,en[e]=n,{key:e,optimizedSprite:n}});await Promise.all(t)}var X=[];function rn(t){return m/t}function sn(t,e,o){let{dirY:n,dirX:r,planeY:s,planeX:a,invDet:l}=o,c=l*(n*t-r*e),u=l*(-s*t+a*e);return{transX:c,transY:u}}function an(t,e){return Math.round((P>>1)*(1+t/e))}function w0(t,e){let o=t.x-i.x,n=t.y-i.y,{transX:r,transY:s}=sn(o,n,e);if(s<=.01)return null;let a=an(r,s),l=t&&typeof t.scale=="number"?t.scale:t&&S[t.img]&&typeof S[t.img].scale=="number"?S[t.img].scale:1,c=rn(s)*l,u=typeof t._hR=="number"?t._hR:Math.round(c),E=.1,p=u;(c>u+E||c<u-E)&&(p=Math.round(c)),t._hR=p;let M=p,w=S[t.img],y=w&&w.width&&w.height?w.width/w.height:1,g=Math.max(1,Math.round(M*y)),T=i.calculatePlayerHeight(),v=m*.5,h=0,k,B;if(t.ground){let _=q[(t.y|0)*f.MAP_W+(t.x|0)],R=f.zones[_],O=i.getCurrentFloorDepth()||0,b=R.floorDepth||0,tt;if(b<=O){let L=2-(R.floorDepth||0);tt=v+m*(L-T)*.5/s}else{let vt=2+.5*(O-b);tt=v+m*(vt-T)*.5/s}let ut=Math.floor(tt+1e-6);if(k=ut-M,B=ut,R&&R.isLiquid){let L=R.floorDepth??0;if(L<0){let vt=L<0?-L:0,b0=Mt(vt/1.2,0,1),D0=Mt(b0,0,1);h=Math.min(M-1,Math.round(M*D0))}}}else{let _=Math.round(v-M*.5);k=_,B=_+M}let x={startY:k,endY:B},F=Math.round(a-(g>>1)),I=F+g;return{drawStartX:F,drawEndX:I,drawStartY:x.startY,drawEndY:x.endY,depth:s,size:M,width:I-F,occludedBottom:h}}var ye={[A.entity]:"#ffeb9c",[A.barrel]:"#CD1C18",[A.key]:"#6aa2ff",[A.food]:"#7fffd4",default:"#ffffff"};var pt=6,Vt=20,Tt=2,bo=Math.floor(Vt/2);gt.width=Tt+Vt*pt+Tt;gt.height=Tt+Vt*pt+Tt;function Do(t){Z.clearRect(0,0,gt.width,gt.height);let e=Math.max(0,Math.min((i.x|0)-bo,f.MAP_W-Vt)),o=Math.max(0,Math.min((i.y|0)-bo,f.MAP_H-Vt));for(let l=0;l<Vt;l++)for(let c=0;c<Vt;c++){let u=o+l,E=e+c,p=f.MAP[u]?.[E]??0,M=K[p].miniMapColor||"#000000";Z.fillStyle=M,Z.fillRect(Tt+c*pt,Tt+l*pt,pt-1,pt-1)}for(let l of t){if(!l.alive)continue;let c=Tt+(l.x-e)*pt,u=Tt+(l.y-o)*pt;Z.fillStyle=ye[l.type]||ye.default,Z.fillRect(c-2,u-2,4,4)}let n=Tt+(i.x-e)*pt,r=Tt+(i.y-o)*pt;Z.fillStyle="#e7f3ff",Z.beginPath(),Z.arc(n,r,2.5,0,qe),Z.fill();let s=Math.cos(i.a),a=Math.sin(i.a);Z.strokeStyle="#78f3d3",Z.beginPath(),Z.moveTo(n,r),Z.lineTo(n+s*1.5*pt,r+a*1.5*pt),Z.stroke()}var H=null,Zt=null,it=null,xe=null,ko=null;function we(){H||(H=new(window.AudioContext||window.webkitAudioContext))}function nt({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:r=0}){if(!H)return;let s=H.createOscillator(),a=H.createGain();s.type=o,s.frequency.value=t,a.gain.value=n,s.connect(a).connect(H.destination);let l=H.currentTime;r&&(s.frequency.setValueAtTime(t,l),s.frequency.linearRampToValueAtTime(t+r,l+e)),a.gain.setValueAtTime(n,l),a.gain.exponentialRampToValueAtTime(.001,l+e),s.start(l),s.stop(l+e)}function Ee({dur:t=.2,vol:e=.2,lp:o=1200}){if(!H)return;let n=H.createBuffer(1,H.sampleRate*t,H.sampleRate),r=n.getChannelData(0);for(let u=0;u<r.length;u++)r[u]=Math.random()*2-1;let s=H.createBufferSource(),a=H.createGain(),l=H.createBiquadFilter();s.buffer=n,a.gain.value=e,l.type="lowpass",l.frequency.value=o,s.connect(l).connect(a).connect(H.destination);let c=H.currentTime;s.start(c),s.stop(c+t)}var J={shot:()=>{let t=ct(50),e=-ct(50);nt({freq:220+t+e,dur:.05+ct(3)/100,type:"square",vol:.25,slide:120}),Ee({dur:.03+ct(3)/100,vol:.15,lp:800})},pickup:()=>{nt({freq:880,dur:.06,type:"triangle",vol:.2}),nt({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{Ee({dur:1,vol:.3,lp:800}),nt({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{nt({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;nt({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),nt({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),nt({freq:90,dur:.08,type:"sine",vol:.18}),Ee({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{nt({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{nt({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{nt({freq:600,dur:.5,type:"sawtooth",vol:.2}),nt({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),nt({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function ln(t,{volume:e=.15}={}){if(H)try{if(!xe||t!==ko){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();xe=await H.decodeAudioData(n),ko=t}Fo(),it=H.createBufferSource(),it.buffer=xe,it.loop=!0,Zt=H.createGain(),Zt.gain.value=e,it.connect(Zt).connect(H.destination),it.start()}catch(o){try{Fo();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),it={stop:()=>n.pause(),disconnect:()=>{}},Zt=null}catch(n){}}}function Fo(){try{it&&it.stop(0)}catch(t){}if(it&&it.disconnect)try{it.disconnect()}catch(t){}if(Zt)try{Zt.disconnect()}catch(t){}it=null,Zt=null}var Io=!1;async function Me(){if(!H||it||Io)return;Io=!0,await ln("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function $t(t,e){if(t<0||e<0||t>=f.MAP_W||e>=f.MAP_H)return!0;let o=f.MAP[e|0][t|0];return o===7?!i.hasBlueKey:K[o]?K[o].collide:!0}function Yt(t,e,o){return!!($t(t,e)||$t(t-o,e)||$t(t+o,e)||$t(t,e-o)||$t(t,e+o))}var s0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},cn={[s0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:gn,ignoreBounds:!1},[s0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:yn,ignoreBounds:!0}},M0=[];function vo(t,e,o,n,r={}){let s=cn[t];if(!s)return console.warn(`Unknown effect type: ${t}`),null;let a={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:r.lifetime??s.lifetime,opacity:r.startOpacity??s.startOpacity,startOpacity:r.startOpacity??s.startOpacity,endOpacity:r.endOpacity??s.endOpacity,...s,...r};return M0.push(a),a}function _o(t,e,o,n={}){return vo(s0.EXPLOSION,t,e,o,n)}function Ce({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){vo(s0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function Ro(t){for(let e=M0.length-1;e>=0;e--){let o=M0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);fn(o,n),o.age>=o.lifetime&&M0.splice(e,1)}}function fn(t,e){switch(t.type){case s0.EXPLOSION:pn(t,e);break;case s0.SCREEN_FLASH:un(t,e);break}}function pn(t,e){t.opacity=B0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=B0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function un(t,e){let o=1-(1-e)*(1-e);t.opacity=B0(t.startOpacity,t.endOpacity,o)}function dn(){return M0}function Po(t,e,o,n,r){let s=dn();if(s.length!==0){t.save();for(let a of s)hn(t,a,e,o,n,r);t.restore()}}function hn(t,e,o,n,r,s){let a=mn(e.x,e.y,o,n,r,s,e.ignoreBounds);!a&&!e.ignoreBounds||e.renderFunction(t,e,a)}function mn(t,e,o,n,r,s,a=!1){let l=t-s.x,c=e-s.y,{dirY:u,dirX:E,planeY:p,planeX:M,invDet:w}=o,y=w*(u*l-E*c),g=w*(-p*l+M*c);return g<=.1&&!a?null:a?{x:n/2,y:r/2,radius:r,depth:g}:{x:n/2*(1+y/g),y:r/2+64,radius:r/g*.5,depth:g}}function gn(t,e,o){let n=o.radius*e.radius,r=performance.now()*.001,s=Math.sin(r*8)*12,a=Math.sin(r*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+s*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+s}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*a,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+s*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+s*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function yn(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var S0={[A.entity]:{type:A.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[A.ball]:{type:A.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[A.sparkle]:{type:A.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[A.barrel]:{type:A.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[A.food]:{type:A.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[A.key]:{type:A.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},Se=null,C0=null;function Oo(t,e){Se=t,C0=e}var A0={[A.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,Se&&X.push(Se(A.sparkle,{x:t.x,y:t.y})));let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1*e,a=o/r,l=n/r,c=t.x+a*s,u=t.y+l*s;Yt(c,t.y,.4)||(t.x=c),Yt(t.x,u,.4)||(t.y=u)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,It(),D("Ball attacks!"),J.hurt(),t.hurtCD=.8,Ce({color:"	#740707",duration:.5}),Te()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(D(Lt(["Ball Hit!"])),t.health-=1,J.killedEntity()):(t.alive=!1,D(Lt(["Ball Busted!"])),J.killedEntity()):D("No arrows.")},onTouch(t){X0(A.entity,1e4)&&D("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,J.killedEntity(),D("The ball is blown to bits.")}},[A.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[A.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1.5*e,a=o/r,l=n/r,c=t.x+a*s,u=t.y+l*s;Yt(c,t.y,.4)||(t.x=c),Yt(t.x,u,.4)||(t.y=u)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,It(),D("Entity attacks!"),J.hurt(),t.hurtCD=.8,Ce({color:"	#740707",duration:.5}),Te()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,D(Lt(["Entity murdered!","Entity destroyed!","Entity purged!"])),J.killedEntity()):D("No arrows.")},onTouch(t){X0(A.entity,1e4)&&D("You hear something like water nearby...")},onExplode(t){t.alive=!1,J.killedEntity(),D("The entity is blown to gibs.")}},[A.barrel]:{onHit(t,e){e?(t.alive=!1,C0&&C0(t.x,t.y,2.5),D("Kaboom!"),J.explode()):D("No arrows.")},onTouch(t){X0(A.barrel,1e4)&&D("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,C0&&C0(t.x,t.y,2.5)}},[A.food]:{onTouch(t){t.alive=!1;let e=i.health>=i.maxHealth;e&&(i.maxHealth+=1),i.health=Mt(i.health+10,0,i.maxHealth),D(e?"Yummy!":"Health restored."),It(),J.pickup()},onExplode(t){}},[A.key]:{onTouch(t){t.alive=!1,i.hasBlueKey=!0,J.door(),D("Keycard found! Find the exit!"),Ae()},onExplode(t){t.alive=!1,i.hasBlueKey=!0,J.door(),D("The forcefield protecting the exit has suddenly lifted!"),Ae()}}};Object.freeze(S0);for(let t in S0)Object.freeze(S0[t]);Object.freeze(A0);for(let t in A0)Object.freeze(A0[t]);var xn=S0,En=A0,wn=0;function Nt(t,e={x:0,y:0},o=void 0){let n=xn[t],r=En[t],s=Object.assign(Object.create(r),n);return s.id=wn++,s.x=e.x,s.y=e.y,s.dist=0,s.alive=!0,s.hurtCD=0,o&&Object.assign(s,o),s}function Mn(t,e,o){_o(t,e,o);for(let n of X){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}Oo(Nt,Mn);var be=0,rt=new Set,Cn=0,De=!1;function Bo(t){window.addEventListener("keydown",e=>{if(rt.add(e.code),we(),Me(),e.code==="Space"&&(e.preventDefault(),Lo()),e.code==="KeyM"&&(e.preventDefault(),gt.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(i.mouseSensitivity){case .33:D("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .22:D("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break;case .11:D("Mouse sensitivity set to low."),i.mouseSensitivity=.05;break;case .05:D("Mouse sensitivity already lowest."),i.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(i.mouseSensitivity){case .33:D("Mouse sensitivity already set to highest."),i.mouseSensitivity=.33;break;case .22:D("Mouse sensitivity set to highest."),i.mouseSensitivity=.33;break;case .11:D("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .05:D("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>rt.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Lo(),Cn=e.clientX,we(),Me()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*i.mouseSensitivity);i.a+=n}}),Qe.onclick=()=>Dn(),to.onclick=()=>gt.classList.toggle("visible")}function Yo(t){let e=rt.has("ShiftLeft")||rt.has("ShiftRight"),o=i.rotSpeed*t,n=i.accel*t,r=Math.cos(i.a),s=Math.sin(i.a),a=-s,l=r;i.weaponAnim>.75&&(i.weaponAnim=-1),i.weaponAnim>=0&&(i.weaponAnim+=t);let c=3;i.velX-=i.velX*c*t,i.velY-=i.velY*c*t,Math.abs(i.velX)<.002&&(i.velX=0),Math.abs(i.velY)<.002&&(i.velY=0),i.isMoving=!1;let u=0,E=0;rt.has("ArrowLeft")&&(i.a-=o),rt.has("ArrowRight")&&(i.a+=o),(rt.has("ArrowUp")||rt.has("KeyW"))&&(u+=r*n,E+=s*n,i.isMoving=!0),(rt.has("ArrowDown")||rt.has("KeyS"))&&(u-=r*n,E-=s*n,i.isMoving=!0),rt.has("KeyA")&&(u-=a*n,E-=l*n,i.isMoving=!0),rt.has("KeyD")&&(u+=a*n,E+=l*n,i.isMoving=!0),i.velX+=u,i.velY+=E;let p=Math.hypot(i.velX,i.velY);p>20&&(i.velX*=20/p,i.velY*=20/p);let M=i.x+i.velX*t,w=i.y+i.velY*t;if(Yt(M,i.y,re)?i.velX=0:i.x=M,Yt(i.x,w,re)?i.velY=0:i.y=w,i.health>=0){let y=q[(i.y|0)*f.MAP_W+(i.x|0)],g=f.zones[y]?.floorDepth||0;(i._currentZoneId!==y||i._currentFloorDepth!==g)&&(i._currentZoneId=y,i._currentFloorDepth=g,E0())}}function Lo(){if(i.weaponAnim>=0)return;i.weaponAnim=0,It(),J.shot();let t=H0(),e=Sn(t);!e||w0(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function No(){for(let t of X)!t.alive||Math.hypot(t.x-i.x,t.y-i.y)>=.6||t.onTouch&&t.onTouch(t)}function Xo(){if(De)return;let t=i.x|0,e=i.y|0;f.MAP[e][t]===5&&(J.portal(),D(`Floor ${qt} cleared.`),se(qt+1),De=!0,i.velX=0,i.velY=0,setTimeout(()=>{bn(!0),De=!1},100))}function Sn(t){let o=document.getElementById("view").width>>1|0,n=ft[o]||1e9,r=null,s=1e9;for(let a of X){if(!a.alive)continue;let l=w0(a,t);l&&(i.sightDist>0&&l.depth>i.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<s&&(r=a,s=l.depth))}return r}function T0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(f.MAP_W-2)|0)+1,n=(Math.random()*(f.MAP_H-2)|0)+1;if(f.MAP[n][o]!==0)continue;let r=o+.5-i.x,s=n+.5-i.y;if(!(Math.hypot(r,s)<t))return{x:o,y:n}}return{x:9,y:9}}var Fe=new Map;function zo(){Fe.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=f;for(let r=0;r<n.length;r++){let s=n[r],a=Math.min(s.x,s.x+s.w),l=Math.max(s.x,s.x+s.w)-1,c=Math.min(s.y,s.y+s.h),u=Math.max(s.y,s.y+s.h)-1,E=Mt(a,0,t-1),p=Mt(l,0,t-1),M=Mt(c,0,e-1),w=Mt(u,0,e-1),y=[];for(let g=M;g<=w;g++)for(let T=E;T<=p;T++)$t(T,g)||y.push({x:T,y:g});Fe.set(r,y)}}function An(t){let e=Fe.get(t);return!e||e.length===0?null:Lt(e)}function Ae(){let t=f.MAP_W,e=f.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)f.MAP[o][n]===7&&(f.MAP[o][n]=0)}function Wo(){let t=St.x,e=St.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(f.MAP[o][n]=7)}function Go(){if(X.length=0,ct(100)<50)for(let o=0;o<ct(2)*(f.MAP_H/20|0);o++){let n=T0(1);X.push(Nt(A.barrel,{x:n.x+.5,y:n.y+.5}))}let t=T0(4);X.push(Nt(A.key,{x:t.x+.5,y:t.y+.5})),t=T0(4),X.push(Nt(A.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(qt-1)*2)*(f.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=T0(3.5);X.push(Nt(A.entity,{x:n.x+.5,y:n.y+.5}))}t=T0(4),X.push(Nt(A.ball,{x:t.x+.5,y:t.y+.5})),f.zones.forEach((o,n)=>{let r=n;o.spawnRules?.forEach(a=>{let l=Math.max(0,a.amount|0);for(let c=0;c<l;c++){let u=An(r);if(!u)break;X.push(Nt(a.entityType,{x:u.x+.5,y:u.y+.5}))}})})}function It(){Ze.style.width=`${i.health/i.maxHealth*100}%`,$e.style.width=`${i.ammo/60*100}%`,je.textContent=Math.max(0,i.health),Ke.textContent=i.ammo}var ke=0,Ie=0,ve=!1,Ho=!1;function D(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let s=n.innerHTML,a=s.match(/^(.*?)(?:\s+x(\d+))?$/),l=a?a[1]:s,c=a&&a[2]?parseInt(a[2]):1;if(l===t){let u=a&&a[2]?c+1:2;n.innerHTML=`${t} x${u}`;return}}let r=document.createElement("div");r.innerHTML=t,o.prepend(r),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function qo(t){ke>0&&(ke-=t,ke<=0&&(Je.textContent=i.hasBlueKey?"Find the exit.":"Find the key card."))}function Te(){ve||i.health<=0&&(ve=!0,i.speed=0,i.rotSpeed=0,Ie=2,D("YOU DIED! Soul disconnecting from the node..."))}function Uo(t){ve&&(Ie-=t,Ie<=0&&Tn())}function Tn(){if(Ho)return;Ho=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),rt.clear()}}function _e(t=!1){t&&a0(),i.x=Ht.x,i.y=Ht.y,i.a=0,i.hasBlueKey=!1,f.MAP[St.y][St.x]=5,Wo(),Go(),It(),D(`Floor ${qt}: Find the keycard.`)}function bn(t=!1){t&&(be>=y0.length-1?a0():(be+=1,a0(be))),i.x=Ht.x,i.y=Ht.y,i.a=0,i.hasBlueKey=!1,f.MAP[St.y][St.x]=5,Wo(),Go(),It(),D(`Floor ${qt}: Find the keycard.`)}function Dn(){se(1),a0(0),_e()}function Vo(t){for(let e of X)e.alive&&e.ai&&e.ai(e,t)}var G0=performance.now(),W0=new Map;function X0(t,e=0){if(e===0)return!(G0<W0.get(t));let o=G0,n=W0.get(t)??0;return o<n?!1:(W0.set(t,o+e),!0)}function Wr(t){W0.set(t,performance.now())}var Re=m>>1;Bo(o0);var z0=0;function kn(t){let e=`FPS: ${Math.round(t)}`;d.save(),d.font="12px monospace",d.textAlign="right",d.textBaseline="top";let o=P-8,n=6,r=d.measureText(e).width+8,s=16;d.fillStyle="rgba(10, 15, 25, 0.6)",d.fillRect(o-r,n-2,r,s),d.strokeStyle="rgba(60, 80, 130, 0.9)",d.strokeRect(o-r+.5,n-2+.5,r-1,s-1),d.fillStyle="#dfe6ff",d.fillText(e,o,n),d.restore()}function a0(t=-1){let e;if(t!==-1){let o=y0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=Lt(y0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}St.x=e.exitPos.x,St.y=e.exitPos.y,Ht.x=e.startPos.x,Ht.y=e.startPos.y,i.sightDist=e.sightDist||so,f.cielingColorFront=e.cielingColorFront||"#6495ED",f.floorColorFront=e.floorColorFront||"#054213",f.cielingColorBack=e.cielingColorBack||"#6495ED",f.floorColorBack=e.floorColorBack||"#03210A",f.MAP=e.mapLayout,f.MAP_W=f.MAP[0].length,f.MAP_H=f.MAP.length,f.zones=e.zones,zo(),go(),xo(),E0(),i.x=i.x=e.startPos.x,i.y=e.startPos.y}async function Fn(){await To(),await Ve(),a0(0),_e(),i.maxHealth=20+ct(6),i.health=i.maxHealth,i.ammo=5+ct(5),It(),requestAnimationFrame(Zo)}function In(t){let e=H0();if(f.zones.length<=2)yo(d);else{for(let o=0;o<P;o++)wo(t,e,o,0);So(d)}if(f.zones.length<=2){let o=i.x|0,n=i.y|0,r=q[n*f.MAP_W+o],s=N0[r];if(!s){let a=f.zones[r].fogColor;s=d.createLinearGradient(0,m,0,Re),s.addColorStop(0,f.floorColorFront||"#054213"),s.addColorStop(.85,f.floorColorBack||"#03210A"),s.addColorStop(.95,a||Ct),N0[r]=s}d.fillStyle=s,d.fillRect(0,Re,P,Re)}else{for(let o=0;o<P;o++)Eo(t,e,o,0);Co(d)}Mo(d),Ao(t,e,f.MAP,f.MAP_W,f.MAP_H),vn(),X.sort((o,n)=>n.dist-o.dist),_n(e),Hn(t),Po(d,e,P,m,i)}function vn(){for(let t of X){let e=t.x-i.x,o=t.y-i.y;t.dist=e*e+o*o}}function _n(t){d.save();for(let e of X){if(!e.alive||Math.hypot(e.x-i.x,e.y-i.y)>i.sightDist)continue;let n=w0(e,t);if(!n||i.sightDist>0&&n.depth>i.sightDist)continue;let r=3,s=0;for(let l=0;l<r;l++){let c=n.drawStartX+l*(n.drawEndX-n.drawStartX)/(r-1);n.depth<=ft[Math.floor(c)]&&s++}if(s===0)continue;let a=Rn(n);Ln(e,n,a),d.filter="none"}d.restore()}function Rn(t){let e=1/(1+t.depth*.3);if(i.sightDist>0&&t.depth>i.sightDist*n0){let r=i.sightDist*n0,s=Math.min(1,Math.max(0,(t.depth-r)/Math.max(1e-6,i.sightDist-r)));e*=1-s*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,s)=>Math.abs(s-e)<Math.abs(r-e)?s:r,o[0])}}function Pn(t){if(i.sightDist<=0)return 0;let e=i.sightDist*n0,o=i.sightDist;return t<=e?0:t>=o?1:(t-e)/(o-e)}function On(t,e){let o=[];e.quantizedShade<.999&&o.push(`brightness(${e.quantizedShade})`);let n=Pn(t.depth);return o.push(`opacity(${1-n})`),o.length>0?o.join(" "):null}function Ln(t,e,o){let n=On(e,o);n&&(d.filter=n);let r=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),s=e.drawStartY,a=e.drawEndY-e.drawStartY,l=e.occludedBottom|0;if(l>=a){d.filter="none";return}let c=a-l,u=S[t.img];if(!u){d.filter="none";return}let E=l/a,p=Math.round(u.height*E),M=u.height-p,w=T=>(T-e.drawStartX)*S[t.img].width/r|0,y=-1,g=0;for(let T=e.drawStartX;T<=e.drawEndX;T++){let h=T>=0&&T<P&&T<e.drawEndX&&e.depth<=ft[T];if(h&&y===-1&&(y=T,g=w(T)),(!h||T===e.drawEndX)&&y!==-1){let k=T,B=k-y,x=w(k);x<=g&&(x=g+1);let F=Math.min(S[t.img].width-g,x-g);B>0&&F>0&&a>0&&d.drawImage(S[t.img],g,0,F,M,y,s,B,c),y=-1}}}function Hn(t){if(!S.pitchfork)return;let e=Math.round(P*.42),o=Math.round(e*(S.pitchfork.height/S.pitchfork.width)),n=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*5):0,r=Math.max(8,P*.02|0),s=P*.5-e/2-r/2+n,a=(i.weaponAnim+1)**10,l=a>7?7:a,c=i.weaponAnim>=0?100-l*20:0,u=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*10):0,E=m-o-r+70+u+c;d.drawImage(S.pitchfork,s,E,e,o)}function Zo(t){let e=Math.min(.05,(t-G0)/1e3);G0=t;let o=e>0?1/e:0;z0=z0?z0*.9+o*.1:o,Yo(e),Vo(e),Ro(e),No(),In(t/1e3),gt.classList.contains("visible")&&Do(X),Xo(),qo(e),Uo(e),kn(z0),O0?P0.drawImage(R0.transferToImageBitmap(),0,0):P0.drawImage(R0,0,0),requestAnimationFrame(Zo)}await Fn().catch(console.error);export{a0 as ChangeMapLevel,Wr as resetCooldown,X0 as tryCooldown};
