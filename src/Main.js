import{a as Mt,b as Ge,c as I0,d as K,e as j0,f as qe,g as K0,h as Ue,i as A}from"../chunks/chunk-KGWCYQQM.js";var t0=document.getElementById("view");t0.width=480;t0.height=270;var v=480,g=270,J0=new OffscreenCanvas(v,g),u=J0.getContext("2d",{colorSpace:"srgb"});u.imageSmoothingEnabled=!1;var Q0=t0.getContext("2d",{colorSpace:"srgb"});Q0.imageSmoothingEnabled=!1;t0.style.filter="brightness(1.15) contrast(1.06)";var mt=document.getElementById("mini"),$=mt.getContext("2d");$.imageSmoothingEnabled=!1;var Ve=document.getElementById("hpBar"),Ze=document.getElementById("ammoBar"),$e=document.getElementById("hpText"),je=document.getElementById("ammoText"),Ke=document.getElementById("msg"),Je=document.getElementById("btnReset"),Qe=document.getElementById("btnToggleMap");var Jo=90*Math.PI/180,ee=Jo*.5,io=.01,oe=.01,ro=15;var g0=.6,Ct="#101b2e";var i={x:3.5,y:3.5,velX:0,velY:0,a:0,accel:10,rotSpeed:2.6,health:6,maxHealth:20,ammo:1,hasBlueKey:!1,isMoving:!1,weaponAnim:-1,tenacity:20,maxTenacity:20,height:.75,sightDist:15,mouseSensitivity:.22,height:1.2,calculatePlayerHeight:()=>{if(2-i.height<.01)return .01;let t=i.getCurrentFloorDepth?i.getCurrentFloorDepth():0;return(2-i.height-t)*1},getCurrentZoneId:()=>i._currentZoneId||0,getCurrentFloorDepth:()=>i._currentFloorDepth||0,_currentZoneId:0,_currentFloorDepth:0},ne=.2,Gt=1,so=1,Qo=99;function ie(t){Gt=Math.max(so,Math.min(Qo,t|0||so))}function R0(){let t=Math.cos(i.a),e=Math.sin(i.a),o=-e*Math.tan(ee),n=t*Math.tan(ee),r=1/(o*e-t*n);return{dirX:t,dirY:e,planeX:o,planeY:n,invDet:r}}var ao=[{name:"Village",mapLayout:[[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,8,8,8,8,8,9,8,8,9,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,8,0,0,3],[3,0,0,8,8,8,8,8,8,8,8,8,8,8,8,8,8,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],[3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]],exitPos:{x:14,y:14},startPos:{x:9.5,y:1.5},zones:[{x:0,y:0,w:1,h:1,color:"#054213",cielingColorFront:"#6495ed",spawnRules:[],outside:!0},{x:0,y:2,w:20,h:2,color:"#0011ff",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",spawnRules:[],floorDepth:-.5,isLiquid:!0,outside:!0},{x:3,y:5,w:14,h:12,color:"#8b8000",cielingColorFront:"#8b8000",cielingColorBack:"#00000000",ceilingHeight:6,floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"entity",amount:5},{entityType:"barrel",amount:5},{entityType:"food",amount:2}]},{x:1,y:0,w:18,h:19,color:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#00000000",floorColorBack:"#03210a",outside:!0,spawnRules:[]}]},{name:"TowerFloor1",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,0,0,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,3,3,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,1,0,0,1,0,0,0,0,1,0,0,1],[1,0,0,1,6,1,1,1,1,0,0,1,6,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,1,1,1,1,1,1,1,6,1,1,1,1,1,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1],[1,0,0,1,0,0,0,1,1,1,1,1,1,0,0,0,1,0,0,1],[1,0,0,1,1,1,1,1,0,0,0,0,1,1,1,1,1,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,1,1,1,1,1,1,1,1,4,4,1,1,1,1,1,1,1,1,1]],exitPos:{x:10,y:17},startPos:{x:5.5,y:4.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},{name:"Gallery",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,4,4,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,3,0,0,0,3,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,0,0,0,1],[1,1,0,0,0,7,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,1,7,1,1,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,6],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,3,0,0,0,0,0,3,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,3,0,0,0,0,0,3,0,0,0,1,0,0,2,0,0,1],[1,1,0,3,3,3,3,3,3,3,3,3,3,3,3,3,3,0,1,0,0,2,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,2,0,0,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,2,0,0,1],[4,0,2,2,2,2,2,2,2,2,2,0,6,0,6,0,6,0,6,0,0,2,0,0,1],[1,0,2,2,2,2,2,2,2,2,2,0,1,0,1,0,1,0,1,0,0,0,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,1,0,1,0,1,0,1,3,0,0,0,3,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],exitPos:{x:3,y:3},startPos:{x:1.5,y:21.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#ECDE60",floorColorBack:"#000000",sightDist:10,zones:[{color:"#888000",cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",x:0,y:0,w:0,h:0,spawnRules:[]},{color:"#888000",x:2,y:2,w:4,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[]},{color:"#888000",x:6,y:2,w:12,h:7,cielingColorFront:"#ecde69",cielingColorBack:"#00000000",floorColorBack:"#000000",fogColor:"#000000",spawnRules:[{entityType:"ball",amount:2},{entityType:"food",amount:1}]}]},{name:"LongHallways",mapLayout:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,0,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,0,3,3,3,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,4,0,0,0,0,0,0,0,0,0,0,0,4,0,1,0,0,0,0,0,3,3,3,3,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,3,3,3,0,0,0,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,3,3,3,3,0,4,0,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,1,6,1,1,1,6,1,1,1,6,1,1,1,6,1,1,0,0,3,3,3,3,3,0,0,0,3,3,3,3,3,0,0,1,1,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,6,0,1],[1,7,7,1,1,6,1,1,1,1,1,1,1,1,1,1,1,6,1,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,0,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,3,3,3,3,3,3,0,3,3,3,3,3,3,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,6,0,0,0,3,3,3,3,3,0,3,3,3,3,3,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,0,0,0,0,0,0,0,2,0,0,0,1,0,0,0,0,3,3,3,3,0,3,3,3,3,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,2,3,0,0,0,0,0,3,2,0,0,0,1,0,0,0,0,0,3,3,3,0,3,3,3,0,0,0,0,0,1,1,1],[1,7,7,1,2,2,0,2,2,2,2,6,2,2,2,2,0,2,2,1,0,0,0,0,0,0,3,3,0,3,3,0,0,0,0,0,0,1,1,1],[1,7,7,1,2,0,0,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,6,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,4,0,0,1,1,1],[1,7,7,1,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,0,6,0,3,3,3,3,3,3,3,3,3,3,3,0,4,0,0,1,1,1],[1,7,7,1,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,0,0,0,0,0,0,0,0,0,0,0,1,0,0,1,1,1],[1,7,7,1,0,0,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,2,0,0,0,0,0,0,0,0,0,0,0,2,1,0,0,1,1,1],[1,7,7,1,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,7,7,0,0,7,7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1],[1,7,7,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,6,6,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,7,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],sightDist:10,exitPos:{x:1,y:1},startPos:{x:9.5,y:3.5},cielingColorFront:"#ECDE60",floorColorFront:"#8B8000",cielingColorBack:"#000000",floorColorBack:"#000000",zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]}];function Lt(t){if(!Array.isArray(t)||t.length===0)throw new Error("Array must be non-empty.");let e=lt(t.length)-1;return t[e]}function lt(t){if(t<=0)throw new Error("The maximum value must be greater than 0.");return Math.floor(Math.random()*t)+1}function P0(t,e,o){return t+(e-t)*o}function lo(t,e){let o=t?t.length:0;if(o===0)return-1;if(e<=t[0])return 0;if(e>=t[o-1])return o-1;let n=0,r=o-1;for(;n<=r;){let s=n+r>>1,a=t[s];if(a===e)return s;a<e?n=s+1:r=s-1}return e-t[r]<=t[n]-e?r:n}function re(t){let e=t.charCodeAt(0)===35?t.slice(1):t,o=parseInt(e.length===3?e.split("").map(n=>n+n).join(""):e,16);return[o>>16&255,o>>8&255,o&255]}var At={x:10,y:8},Ht={x:3.5,y:3.5};var f={MAP:[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]],MAP_W:-1,MAP_H:-1,cielingColorFront:"",floorColorFront:"",cielingColorBack:"",floorColorBack:"",dontPersist:!1,sightDist:15,zones:[{color:"#101b2e",x:0,y:0,w:1,h:1}]},y0=ao,co=new Map;function uo(t){let e=f.zones,o=e&&e[t]?.color||Ct,n=co.get(o);return n||(n=re(o),co.set(o,n)),n}var fo=new Map;function po(t){let e=f.zones,o=e&&e[t]?.cielingColorFront||Ct,n=fo.get(o);return n||(n=re(o),fo.set(o,n)),n}function ho(t,e,o){for(let n=0;n<o.length;n++){let r=o[n],s=Math.min(r.x,r.x+r.w),a=Math.max(r.x,r.x+r.w)-1,l=Math.min(r.y,r.y+r.h),c=Math.max(r.y,r.y+r.h)-1;if(t>=s&&t<=a&&e>=l&&e<=c)return n}return 0}var ct=new Float32Array(v),W=g>>1,x0=new Int16Array(v).fill(W),et=new Int16Array(v).fill(W),e0=new Float32Array(g),le=new Float32Array(g),o0={},n0={},se=W;function E0(){for(let r in n0)delete n0[r];for(let r in o0)delete o0[r];let t=i.calculatePlayerHeight(),o=2-0,n=g*(o-t)*.5;for(let r=0;r<g;r++){let s=r-se;e0[r]=s!==0?n/s:1e-6;let l=2-2,c=g*(l+t)*.5;le[r]=s!==0?-c/s:-1e-6}for(let r=0;r<f.zones.length;r++){let s=f.zones[r];if(s.ceilingHeight!==void 0){n0[r]=new Float32Array(g);for(let a=0;a<g;a++){let l=a-se,p=s.ceilingHeight-2,E=g*(p+t)*.5;n0[r][a]=l!==0?-E/l:-1e-6}}if(s.floorDepth!==void 0){let l=2-s.floorDepth,c=g*(l-t)*.5;o0[r]=new Float32Array(g);for(let p=0;p<g;p++){let E=p-se;o0[r][p]=E!==0?c/E:1e-6}}}}E0();var ce=[],fe=[],de=[],L0=[],G=[],ue=[];function mo(){ce.length=0,fe.length=0,de.length=0,L0.length=0,ue.length=0,pe.clear(),he.clear()}function Bt(t,e,o,n,r,s,a,l,c,p){if(!r)return;let E=n-o;if(E<=0)return;let d=l||0,w=d<0?0:d>r.height?r.height:d,x=c||r.height,y=r.height-w,h=x<0?0:x>y?y:x,H=lo(j0,a);t.drawImage(qe[p][j0[H]],s,w,1,h,e,o,1,E)}function go(t){let e=i.x|0,o=i.y|0,n=G[o*f.MAP_W+e],r=ce[n];if(!r){r=t.createLinearGradient(0,0,0,W);let s=f.zones[n].cielingColorFront,a=f.zones[n].cielingColorBack,l=f.zones[n].fogColor;r.addColorStop(0,s||f.cielingColorFront||"#6495ED"),f.cielingColorBack&&r.addColorStop(.5,a||f.cielingColorBack||"#6495ED"),r.addColorStop(.9,l||Ct),ce[n]=r}t.fillStyle=r,t.fillRect(0,0,v,W)}var pe=new Map;function ae(t){let e=pe.get(t);if(!e){let[o,n,r]=uo(t);e=`rgb(${o|0},${n|0},${r|0})`,pe.set(t,e)}return e}var he=new Map;function O0(t){let e=he.get(t);if(!e){let[o,n,r]=po(t);e=`rgb(${o|0},${n|0},${r|0})`,he.set(t,e)}return e}function yo(){G.length=0;let t=f.zones,e=f.MAP_W,o=f.MAP_H;for(let n=0;n<o;n++)for(let r=0;r<e;r++)G[n*e+r]=ho(r,n,t)}function xo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e;n=x0[o]??W;let c=n<W?W:n;if(c>=g)return;let p=2*(o+.5)/v-1,E=r+a*p,d=s+l*p;if(i.sightDist>0){let F=ct[o]??1/0;for(;c<g;){let _=e0[c]??1/0;if(_<=i.sightDist&&_<=F)break;c++}if(c>=g)return}let w="#000000",x=f.MAP_W,y=f.MAP_H,h=1/(r*E+s*d),H=E*h,D=d*h,m=0;function b(F,_=0){let L=e0[F]??e0[e0.length-1]??1/0,I=i.x+H*L,S=i.y+D*L,rt=I|0,gt=S|0;return rt>=0&&gt>=0&&rt<x&&gt<y?G[gt*x+rt]:0}let O=F=>Math.max(8,Math.min(64,8+(F-W>>>3)));m=b(c,m);let M=c,k=null;for(;c<g;){let F=Math.min(O(c),g-1-c);if(F<=0)break;let _=c+F;if(b(_,m)===m){let dt=c+_>>1;if(b(dt,m)===m){let bt=ae(m);bt!==k&&(u.fillStyle=bt,k=bt);let st=_+1-M;st>0&&u.fillRect(o,M,1,st),c=_+1,M=c;continue}}let I=c,S=_;for(;S-I>1;){let dt=I+S>>1;b(dt,m)===m?I=dt:S=dt}let rt=ae(m);rt!==k&&(u.fillStyle=rt,k=rt);let gt=S-M;gt>0&&u.fillRect(o,M,1,gt);let V=b(S,m),q=f.zones[m]?.floorDepth??0,s0=f.zones[V]?.floorDepth??0,a0=x0[o]??W,It=e0[S]??1/0,b0=ct[o]??1/0,ve=S===a0,Re=It>=b0-.11;if(!!w&&q!==s0&&!ve&&!Re&&!(M===a0)){let dt=f.zones[m]||{},bt=f.zones[V]||{},st=dt.floorDepth??0,vt=bt.floorDepth??0,tt=!!dt.isLiquid,Zt=!!bt.isLiquid,U=0;if(tt||Zt)U=st>vt?5:1;else{let z0=Math.abs(st-vt),l0=o0?.[m]?.[S],c0=o0?.[V]?.[S],Dt=It;(Number.isFinite(l0)||Number.isFinite(c0))&&(Dt=Math.min(l0??1/0,c0??1/0,It??1/0),Number.isFinite(Dt)||(Dt=It));let jt=g*z0*.5/Math.max(.001,Dt);U=Math.max(1,jt|0),U=st>vt?U:2}let $t=S,ut=Math.min(g,$t+U);ut>$t&&(u.fillStyle!==w&&(u.fillStyle=w),u.fillRect(o,$t,1,ut-$t)),k=null,m=V,c=ut,M=c;continue}m=V,c=S,M=c}if(M<g){let F=ae(m);F!==k&&(u.fillStyle=F),u.fillRect(o,M,1,g-M)}}function Eo(t,e,o,n=0){let{dirX:r,dirY:s,planeX:a,planeY:l}=e,c=et[o]??W,p=0;if(c<=0)return;let E=2*(o+.5)/v-1,d=r+a*E,w=s+l*E,x=1/(r*d+s*w),y=0,h=n0?.[y]?.[p]??le[p],H=i.x+d*h*x,D=i.y+w*h*x,m=p,b=null;for(let M=p;M<c;M++){if(i.sightDist>0&&Math.abs(h)>i.sightDist){let S=O0(y);S!==b&&(u.fillStyle=S),u.fillRect(o,m,1,M-m);return}if(h>ct[o]){let S=O0(y);S!==b&&(u.fillStyle=S),u.fillRect(o,m,1,M-m);return}let k=H|0,F=D|0,_=k>=0&&F>=0&&k<f.MAP_W&&F<f.MAP_H?G[F*f.MAP_W+k]:y;if(_!==y){let S=O0(y);S!==b&&(u.fillStyle=S,b=S),u.fillRect(o,m,1,M-m),y=_,m=M}let L=n0?.[y]?.[M+1]??le[M+1]??h,I=L-h;H+=d*I*x,D+=w*I*x,h=L}let O=O0(y);O!==b&&(u.fillStyle=O),u.fillRect(o,m,1,c-m)}function wo(t){let e=de[0];e||(e=t.createLinearGradient(0,0,0,g),e.addColorStop(0,"rgba(16,27,46,0.08)"),e.addColorStop(.5,"rgba(16,27,46,0.16)"),e.addColorStop(1,"rgba(16,27,46,0.20)"),de[0]=e),t.fillStyle=e,t.fillRect(0,0,v,g)}function Mo(t){let e=W-1,o=g-e,n=i.x|0,r=i.y|0,s=G[r*f.MAP_W+n],a=fe[s];if(!a){let l=f.zones[s].floorColorBack;a=t.createLinearGradient(0,e,0,g),a.addColorStop(.05,f.zones[s].fogColor||Ct),a.addColorStop(.15,l||f.floorColorBack||"#03210A"),a.addColorStop(1,"rgba(0,0,0,0)"),fe[s]=a}t.fillStyle=a,t.fillRect(0,e,v,o)}function Co(t){let o=W+1,n=i.x|0,r=i.y|0,s=G[r*f.MAP_W+n],a=ue[s];if(!a){let l=f.zones[s].fogColor||Ct,c=f.zones[s].cielingColorBack||f.cielingColorBack||"#6495ED";a=t.createLinearGradient(0,0,0,0+o),a.addColorStop(0,"rgba(0,0,0,0)"),a.addColorStop(.85,c),a.addColorStop(.95,l),ue[s]=a}t.fillStyle=a,t.fillRect(0,0,v,o)}function Ao(t,e,o,n,r){let{dirX:s,dirY:a,planeX:l,planeY:c}=e,p=i.sightDist>0;function E(d,w,x,y){if(i.sightDist<=0)return;let h=i.sightDist*g0,H=i.sightDist;if(y<=h)return;let D=w|0,m=x|0;if(D<0&&(D=0),m>g&&(m=g),m<=D)return;let b=Math.min(1,Math.max(0,(y-h)/Math.max(1e-6,H-h))),O=i.x|0,M=i.y|0,k=G.length>0?G[M*f.MAP_W+O]|0:0;u.save(),u.globalAlpha=b*.85,u.fillStyle=f.zones[k].fogColor||Ct,u.fillRect(d,D,1,m-D),u.restore()}for(let d=0;d<v;d++){let w=2*(d+.5)/v-1,x=s+l*w,y=a+c*w;if(x<1e-8&&x>-1e-8&&y<1e-8&&y>-1e-8){ct[d]=Number.POSITIVE_INFINITY,x0[d]=W,et[d]=W;continue}let h=1/(x||1e-9),H=1/(y||1e-9),D=i.x|0,m=i.y|0,b=h<0?-h:h,O=H<0?-H:H,M,k,F,_;x<0?(M=-1,F=(i.x-D)*b):(M=1,F=(D+1-i.x)*b),y<0?(k=-1,_=(i.y-m)*O):(k=1,_=(m+1-i.y)*O);let L=0,I=1,S=!1,rt=0,gt=0;for(;!S&&rt++<256;){if(F<_?(F+=b,D+=M,L=0):(_+=O,m+=k,L=1),p){let z=Math.min(F,_);if(z>i.sightDist){S=!1,I=0,gt=z;break}}if(D<0||m<0||D>=n||m>=r){S=!0,I=1;break}let C=o[m][D];if(C>0){S=!0,I=C;break}}let V=I;if(I=K?.[V].textures[0][0]||"hedge",V===0){ct[d]=Number.POSITIVE_INFINITY,x0[d]=W,et[d]=W;continue}let q;L===0?q=F-b:q=_-O,q=Math.max(io,q);let s0=0,a0=L===0?M:0,It=L===1?k:0,X0=Math.abs(a0*s+It*a)>=.9&&Math.abs(w)<=.9&&q<s0?s0:q,dt=i.x+X0*x,bt=i.y+X0*y,st;L===0?st=bt-(bt|0):st=dt-(dt|0),st=Math.min(.999999,Math.max(0,st+1e-6));let vt=K0[I],tt=I0[I],Zt=tt?tt.width|0:vt.w|0,U=st*Zt|0;(L===0&&M>0||L===1&&k<0)&&(U=Zt-U-1),U<0&&(U=0),U>=Zt&&(U=Zt-1);let $t=Math.max(oe,q),ut=g/$t|0,z0=i.calculatePlayerHeight(),l0=W,c0=g*(2-z0)*.5,Dt=l0+c0/q,jt=Dt|0,D0=Dt-ut|0,Xt=D0,Kt=jt;Xt<0&&(Xt=0),Kt>g&&(Kt=g);let W0=D-(L===0?M:0),G0=m-(L===1?k:0),f0=0;W0>=0&&G0>=0&&W0<n&&G0<r&&(f0=G[G0*n+W0]|0);let Q=K[V].height||1,q0=f0>=0?f0:G[m*n+D]|0,d0=f.zones[q0],u0=d0.ceilingHeight||2;Q=u0/2<Q&&!d0.outside?u0/2:Q;let Pe=Kt-Xt;x0[d]=Kt,et[d]=Xt;let $o=Dt-ut*(Q>0?Q:1);if(et[d]=$o,Pe<=0){ct[d]=q;continue}let Oe=(tt?tt.height:vt.h||I0[I]?.height||64)|0,Le=(Xt-D0)*(Oe/Math.max(1,ut)),He=Pe*(Oe/Math.max(1,ut)),Jt=1/(1+q*.25)*(L?.5:1);if(K[V].animated&&(Jt*=.8+.2*Math.sin(t*6+d*.05)),Q===1)Bt(u,d,Xt,Kt,tt,U,Jt,Le,He,I);else if(Q>1){Bt(u,d,Xt,Kt,tt,U,Jt,Le,He,I);let C=ut,z=(tt?.height||vt.h||64)|0,j=z/Math.max(1,C),pt=Math.floor(Q)-1;for(let X=0;X<pt;X++){let yt=D0-C*(X+1),at=jt-C*(X+1),B=Math.max(0,Math.ceil(yt)),xt=Math.min(g,Math.floor(at)),Et=xt-B;if(Et<=0)continue;let Z=(B-yt)*j,wt=Et*j;Bt(u,d,B,xt,tt,U,Jt,Z,wt,K[V].textures[0][X+1])}let Rt=Q-(1+pt);if(Rt>1e-6){let X=C*Rt,yt=D0-C*pt,at=yt-X,B=Math.max(0,Math.ceil(at)),xt=Math.min(g,Math.floor(yt)),Et=xt-B;if(Et>0){let Z=yt-C,wt=(B-Z)*j%z;wt<0&&(wt+=z);let h0=Et*j;Bt(u,d,B,xt,tt,U,Jt,wt,h0,K[V].textures[0][1+pt])}}}else if(Q<1){let C=ut,z=(tt?.height||vt.h||64)|0,j=z/Math.max(1,C),pt=Q;if(pt>1e-6){let Rt=C*pt,X=jt,yt=X-Rt,at=Math.max(0,Math.ceil(yt)),B=Math.min(g,Math.floor(X)),xt=B-at;if(xt>0){let Et=X-C,Z=(at-Et)*j%z;Z<0&&(Z+=z);let wt=xt*j;Bt(u,d,at,B,tt,U,Jt,Z,wt,I)}}}{let C=Dt-ut*(Q>0?Q:1),z=Math.max(0,Math.ceil(C)),j=Math.min(g,jt);E(d,z,j,q)}let p0=Q;if((et[d]|0)>0){let C=et[d]|0,z=D,j=m,pt=F,Rt=_,X=L,yt=0;for(;C>0&&yt++<i.sightDist-q&&(pt<Rt?(pt+=b,z+=M,X=0):(Rt+=O,j+=k,X=1),!(z<0||j<0||z>=n||j>=r));){let at=o[j][z]|0;if(at<=0)continue;let B=X===0?pt-b:Rt-O;if(p&&B>i.sightDist)break;let xt=Math.max(oe,B),Et=g/xt|0,Z=K[at].height;q0=f0>=0?f0:G[j*n+z]|0,d0=f.zones[q0],u0=d0.ceilingHeight||2,Z=u0/2<Z&&!d0.outside?u0/2:Z;let wt=at;if(Z<=p0)continue;let h0=l0+c0/B;if(!(h0-Et*Z<C))continue;let U0=K?.[at]?.textures[0][p0|0],Be=i.x+B*x,Ye=i.y+B*y,jo=X===0?Ye-(Ye|0):Be-(Be|0),zt=I0[U0],Ne=K0[U0],F0=zt?zt.width|0:Ne.w|0,Ft=jo*F0|0;(X===0&&M>0||X===1&&k<0)&&(Ft=F0-Ft-1),Ft<0&&(Ft=0),Ft>=F0&&(Ft=F0-1);let V0=(zt?zt.height:Ne.h||64)|0,Z0=1/(1+B*.25)*(X?.5:1),Wt=Et,Qt=V0/Math.max(1,Wt),k0=h0-Wt,Xe=h0,Y=k0,ht=Math.min(C,Xe),Pt=ht-Y;if(Pt>0){let kt=(Y-k0)*Qt,Ot=Pt*Qt;Bt(u,d,Y,ht,zt,Ft,Z0,kt,Ot,U0),Y<C&&(C=Y,C<(et[d]|0)&&(et[d]=C)),E(d,Y,ht,B)}let _0=Math.floor(Z)-1;for(let kt=0;kt<_0&&C>0;kt++){let Ot=k0-Wt*(kt+1),We=Xe-Wt*(kt+1);if(Y=Ot,ht=Math.min(C,We)+1,Pt=ht-Y,Pt<=0)continue;let $0=(Y-Ot)*Qt,m0=Pt*Qt;Bt(u,d,Y,ht,zt,Ft,Z0,$0,m0,K?.[wt]?.textures[0][(p0|0)+kt]),Y<C&&(C=Y,C<(et[d]|0)&&(et[d]=C)),E(d,Y,ht,B)}let ze=Z-(1+_0);if(ze>1e-6&&C>0){let kt=Wt*ze,Ot=k0-Wt*Math.max(0,_0);if(Y=Ot-kt,ht=Math.min(C,Ot),Pt=ht-Y,Pt>0){let $0=Ot-Wt,m0=(Y-$0)*Qt%V0;m0<0&&(m0+=V0);let Ko=Pt*Qt;Bt(u,d,Y,ht,zt,Ft,Z0,m0,Ko,K?.[wt]?.textures[0][(p0|0)+_0]),Y<C&&(C=Y,C<(et[d]|0)&&(et[d]=C)),E(d,Y,ht,B)}}p0=Z}}ct[d]=q}}var R={aiDrone1:null,ball:null,sparkle:null,barrel:null,food:null,keycard1:null,aiDrone2:null,aiDrone3:null,pitchfork:null,bow:null};async function St(t,e){return await tn(t,e,1)}async function tn(t,e=1,o=1){let n=`../assets/gfx/${t}`;return new Promise((r,s)=>{let a=new Image;a.onload=()=>{let l=new OffscreenCanvas(a.width*e,a.height*e),c=l.getContext("2d");c.imageSmoothingEnabled=!1,c.drawImage(a,0,0,l.width,l.height),l.baseline=o,l.scale=e,r(l)},a.onerror=()=>s(new Error(`Failed to load sprite: ${n}`)),a.src=n})}async function So(){R.food=await St("noodles.png",3),R.bow=await St("bow.png",3),R.pitchfork=await St("pitchfork.png",3),R.keycard1=await St("keycard1.png",3),R.barrel=await St("emp.png",3),R.aiDrone1=await St("aiDrone1.png",3),R.aiDrone2=await St("aiDrone2.png",3),R.aiDrone3=await St("aiDrone3.png",3),R.ball=await St("Palantrash1.png",3),R.sparkle=await St("sparkle.png",3)}var N=[];function en(t){return g/t}function on(t,e,o){let{dirY:n,dirX:r,planeY:s,planeX:a,invDet:l}=o,c=l*(n*t-r*e),p=l*(-s*t+a*e);return{transX:c,transY:p}}function nn(t,e){return Math.round((v>>1)*(1+t/e))}function w0(t,e){let o=t.x-i.x,n=t.y-i.y,{transX:r,transY:s}=on(o,n,e);if(s<=.01)return null;let a=nn(r,s),l=t&&typeof t.scale=="number"?t.scale:t&&R[t.img]&&typeof R[t.img].scale=="number"?R[t.img].scale:1,c=en(s)*l,p=typeof t._hR=="number"?t._hR:Math.round(c),E=.1,d=p;(c>p+E||c<p-E)&&(d=Math.round(c)),t._hR=d;let w=d,x=R[t.img],y=x&&x.width&&x.height?x.width/x.height:1,h=Math.max(1,Math.round(w*y)),H=i.calculatePlayerHeight(),D=g*.5,m=0,b,O;if(t.ground){let _=t.floorBiasFrac??.04,L=G[(t.y|0)*f.MAP_W+(t.x|0)],I=f.zones[L],S=2-(I.floorDepth||0),rt=D+g*(S-H)/(2*s)-_*w,gt=rt-w;if(b=Math.round(gt),O=Math.round(rt),I&&I.isLiquid){let V=I.floorDepth??0;if(V<0){let q=V<0?-V:0,It=Mt(q/1.2,0,1),b0=Mt(It,0,1);m=Math.min(w-1,Math.round(w*b0))}}}else{let _=Math.round(D-w*.5);b=_,O=_+w}let M={startY:b,endY:O},k=Math.round(a-(h>>1)),F=k+h;return{drawStartX:k,drawEndX:F,drawStartY:M.startY,drawEndY:M.endY,depth:s,size:w,width:F-k,occludedBottom:m}}var me={[A.entity]:"#ffeb9c",[A.barrel]:"#CD1C18",[A.key]:"#6aa2ff",[A.food]:"#7fffd4",default:"#ffffff"};var ft=6,qt=20,Tt=2,To=Math.floor(qt/2);mt.width=Tt+qt*ft+Tt;mt.height=Tt+qt*ft+Tt;function bo(t){$.clearRect(0,0,mt.width,mt.height);let e=Math.max(0,Math.min((i.x|0)-To,f.MAP_W-qt)),o=Math.max(0,Math.min((i.y|0)-To,f.MAP_H-qt));for(let l=0;l<qt;l++)for(let c=0;c<qt;c++){let p=o+l,E=e+c,d=f.MAP[p]?.[E]??0,w=K[d].miniMapColor||"#000000";$.fillStyle=w,$.fillRect(Tt+c*ft,Tt+l*ft,ft-1,ft-1)}for(let l of t){if(!l.alive)continue;let c=Tt+(l.x-e)*ft,p=Tt+(l.y-o)*ft;$.fillStyle=me[l.type]||me.default,$.fillRect(c-2,p-2,4,4)}let n=Tt+(i.x-e)*ft,r=Tt+(i.y-o)*ft;$.fillStyle="#e7f3ff",$.beginPath(),$.arc(n,r,2.5,0,Ge),$.fill();let s=Math.cos(i.a),a=Math.sin(i.a);$.strokeStyle="#78f3d3",$.beginPath(),$.moveTo(n,r),$.lineTo(n+s*1.5*ft,r+a*1.5*ft),$.stroke()}var P=null,Ut=null,nt=null,ge=null,Do=null;function xe(){P||(P=new(window.AudioContext||window.webkitAudioContext))}function ot({freq:t=440,dur:e=.1,type:o="square",vol:n=.2,slide:r=0}){if(!P)return;let s=P.createOscillator(),a=P.createGain();s.type=o,s.frequency.value=t,a.gain.value=n,s.connect(a).connect(P.destination);let l=P.currentTime;r&&(s.frequency.setValueAtTime(t,l),s.frequency.linearRampToValueAtTime(t+r,l+e)),a.gain.setValueAtTime(n,l),a.gain.exponentialRampToValueAtTime(.001,l+e),s.start(l),s.stop(l+e)}function ye({dur:t=.2,vol:e=.2,lp:o=1200}){if(!P)return;let n=P.createBuffer(1,P.sampleRate*t,P.sampleRate),r=n.getChannelData(0);for(let p=0;p<r.length;p++)r[p]=Math.random()*2-1;let s=P.createBufferSource(),a=P.createGain(),l=P.createBiquadFilter();s.buffer=n,a.gain.value=e,l.type="lowpass",l.frequency.value=o,s.connect(l).connect(a).connect(P.destination);let c=P.currentTime;s.start(c),s.stop(c+t)}var J={shot:()=>{let t=lt(50),e=-lt(50);ot({freq:220+t+e,dur:.05+lt(3)/100,type:"square",vol:.25,slide:120}),ye({dur:.03+lt(3)/100,vol:.15,lp:800})},pickup:()=>{ot({freq:880,dur:.06,type:"triangle",vol:.2}),ot({freq:1180,dur:.08,type:"triangle",vol:.18})},explode:()=>{ye({dur:1,vol:.3,lp:800}),ot({freq:90,dur:.7,type:"sawtooth",vol:.12,slide:-60})},hurt:()=>{ot({freq:140,dur:.12,type:"sawtooth",vol:.2,slide:-50})},killedEntity:()=>{let t=Math.random()*16-8;ot({freq:320+t,dur:.26,type:"triangle",vol:.3,slide:-220}),ot({freq:480+t,dur:.22,type:"sawtooth",vol:.1,slide:-260}),ot({freq:90,dur:.08,type:"sine",vol:.18}),ye({dur:.05,vol:.1,lp:1e3}),setTimeout(()=>{ot({freq:170+t,dur:.07,type:"triangle",vol:.16,slide:70})},90)},door:()=>{ot({freq:420,dur:.12,type:"square",vol:.15})},portal:()=>{ot({freq:600,dur:.5,type:"sawtooth",vol:.2}),ot({freq:400,dur:.3,type:"sawtooth",vol:.2,slide:50}),ot({freq:600,dur:.5,type:"sawtooth",vol:.2})}};async function rn(t,{volume:e=.15}={}){if(P)try{if(!ge||t!==Do){let n=await(await fetch(t,{cache:"force-cache"})).arrayBuffer();ge=await P.decodeAudioData(n),Do=t}Fo(),nt=P.createBufferSource(),nt.buffer=ge,nt.loop=!0,Ut=P.createGain(),Ut.gain.value=e,nt.connect(Ut).connect(P.destination),nt.start()}catch(o){try{Fo();let n=new Audio(t);n.loop=!0,n.volume=Math.max(0,Math.min(1,e)),await n.play(),nt={stop:()=>n.pause(),disconnect:()=>{}},Ut=null}catch(n){}}}function Fo(){try{nt&&nt.stop(0)}catch(t){}if(nt&&nt.disconnect)try{nt.disconnect()}catch(t){}if(Ut)try{Ut.disconnect()}catch(t){}nt=null,Ut=null}var ko=!1;async function Ee(){if(!P||nt||ko)return;ko=!0,await rn("../assets/sfx/HexenST02SLowed.ogg",{volume:.12})}function Vt(t,e){if(t<0||e<0||t>=f.MAP_W||e>=f.MAP_H)return!0;let o=f.MAP[e|0][t|0];return o===7?!i.hasBlueKey:K[o]?K[o].collide:!0}function Yt(t,e,o){return!!(Vt(t,e)||Vt(t-o,e)||Vt(t+o,e)||Vt(t,e-o)||Vt(t,e+o))}var i0={EXPLOSION:"explosion",SCREEN_FLASH:"screen_flash"},sn={[i0.EXPLOSION]:{lifetime:.5,startRadius:.1,endRadius:1,expansionTime:.4,startOpacity:1,endOpacity:0,primaryColor:{h:30,s:90,l:60},secondaryColor:{h:15,s:85,l:50},glowColor:{h:45,s:100,l:75},fillColor:{h:25,s:80,l:40},ringLineWidth:3,glowLineWidth:2,innerLineWidth:1,renderFunction:pn,ignoreBounds:!1},[i0.SCREEN_FLASH]:{lifetime:.15,startOpacity:.85,endOpacity:0,color:"#ffffff",renderFunction:hn,ignoreBounds:!0}},M0=[];function _o(t,e,o,n,r={}){let s=sn[t];if(!s)return console.warn(`Unknown effect type: ${t}`),null;let a={ignoreBounds:!1,type:t,x:e,y:o,radius:n,maxRadius:n,age:0,lifetime:r.lifetime??s.lifetime,opacity:r.startOpacity??s.startOpacity,startOpacity:r.startOpacity??s.startOpacity,endOpacity:r.endOpacity??s.endOpacity,...s,...r};return M0.push(a),a}function Io(t,e,o,n={}){return _o(i0.EXPLOSION,t,e,o,n)}function we({color:t="#ffffff",duration:e=.15,alpha:o=.85}={}){_o(i0.SCREEN_FLASH,0,0,1,{lifetime:e,startOpacity:o,endOpacity:0,color:t,ignoreBounds:!0})}function vo(t){for(let e=M0.length-1;e>=0;e--){let o=M0[e];o.age+=t;let n=Math.min(o.age/o.lifetime,1);an(o,n),o.age>=o.lifetime&&M0.splice(e,1)}}function an(t,e){switch(t.type){case i0.EXPLOSION:ln(t,e);break;case i0.SCREEN_FLASH:cn(t,e);break}}function ln(t,e){t.opacity=P0(t.startOpacity,t.endOpacity,e);let o=Math.min(e/t.expansionTime,1),n=P0(t.startRadius,t.endRadius,o);t.radius=t.maxRadius*n}function cn(t,e){let o=1-(1-e)*(1-e);t.opacity=P0(t.startOpacity,t.endOpacity,o)}function fn(){return M0}function Ro(t,e,o,n,r){let s=fn();if(s.length!==0){t.save();for(let a of s)dn(t,a,e,o,n,r);t.restore()}}function dn(t,e,o,n,r,s){let a=un(e.x,e.y,o,n,r,s,e.ignoreBounds);!a&&!e.ignoreBounds||e.renderFunction(t,e,a)}function un(t,e,o,n,r,s,a=!1){let l=t-s.x,c=e-s.y,{dirY:p,dirX:E,planeY:d,planeX:w,invDet:x}=o,y=x*(p*l-E*c),h=x*(-d*l+w*c);return h<=.1&&!a?null:a?{x:n/2,y:r/2,radius:r,depth:h}:{x:n/2*(1+y/h),y:r/2+64,radius:r/h*.5,depth:h}}function pn(t,e,o){let n=o.radius*e.radius,r=performance.now()*.001,s=Math.sin(r*8)*12,a=Math.sin(r*12)*.15+1,l=o.y,c=o.x;t.globalAlpha=e.opacity*.3,t.fillStyle=`hsl(${e.fillColor.h+s*.5}, ${e.fillColor.s}%, ${e.fillColor.l}%)`,t.beginPath(),t.arc(c,l,n*.7,0,2*Math.PI),t.fill(),t.globalAlpha=e.opacity*.5,t.strokeStyle=`hsl(${e.glowColor.h+s}, ${e.glowColor.s}%, ${e.glowColor.l}%)`,t.lineWidth=e.glowLineWidth*1.5,t.beginPath(),t.arc(c,l,n*a,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.85,t.strokeStyle=`hsl(${e.primaryColor.h+s*.8}, ${e.primaryColor.s}%, ${e.primaryColor.l}%)`,t.lineWidth=e.ringLineWidth,t.beginPath(),t.arc(c,l,n*.9,0,2*Math.PI),t.stroke(),t.globalAlpha=e.opacity*.6,t.strokeStyle=`hsl(${e.secondaryColor.h+s*1.3}, ${e.secondaryColor.s}%, ${e.secondaryColor.l}%)`,t.lineWidth=e.innerLineWidth,t.beginPath(),t.arc(c,l,n*.5,0,2*Math.PI),t.stroke()}function hn(t,e){if(e.opacity<=0)return;let o=t.canvas.width,n=t.canvas.height;t.save(),t.globalAlpha=e.opacity,t.fillStyle=e.color||"#ffffff",t.fillRect(0,0,o,n),t.restore()}var A0={[A.entity]:{type:A.entity,ground:!0,scale:.66,floorBiasFrac:0,animationTime:0,animationFrame:0,img:"aiDrone1"},[A.ball]:{type:A.ball,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:.5,health:3,img:"ball"},[A.sparkle]:{type:A.sparkle,ground:!1,scale:.75,floorBiasFrac:0,cooldownTime:3,img:"sparkle"},[A.barrel]:{type:A.barrel,ground:!0,scale:.66,floorBiasFrac:0,img:"barrel"},[A.food]:{type:A.food,ground:!0,scale:.25,floorBiasFrac:0,img:"food"},[A.key]:{type:A.key,ground:!0,scale:.25,floorBiasFrac:0,img:"keycard1"}},Me=null,C0=null;function Po(t,e){Me=t,C0=e}var S0={[A.ball]:{ai(t,e){if(!t.alive)return;t.cooldownTime-=e,t.cooldownTime<=0&&(t.cooldownTime=.5,Me&&N.push(Me(A.sparkle,{x:t.x,y:t.y})));let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1*e,a=o/r,l=n/r,c=t.x+a*s,p=t.y+l*s;Yt(c,t.y,.4)||(t.x=c),Yt(t.x,p,.4)||(t.y=p)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,_t(),T("Ball attacks!"),J.hurt(),t.hurtCD=.8,we({color:"	#740707",duration:.5}),Ae()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?t.health>1?(T(Lt(["Ball Hit!"])),t.health-=1,J.killedEntity()):(t.alive=!1,T(Lt(["Ball Busted!"])),J.killedEntity()):T("No arrows.")},onTouch(t){H0(A.entity,1e4)&&T("You hear something like echoes nearby...")},onExplode(t){t.alive=!1,J.killedEntity(),T("The ball is blown to bits.")}},[A.sparkle]:{ai(t,e){t.alive&&(t.cooldownTime-=e,t.cooldownTime<=0&&(t.alive=!1))}},[A.entity]:{ai(t,e){if(!t.alive)return;switch(t.animationTime+=e,t.animationTime>.2&&(t.animationTime-=.2,t.animationFrame+=1,t.animationFrame%=4),t.animationFrame){case 0:t.img="aiDrone1";break;case 1:t.img="aiDrone2";break;case 2:t.img="aiDrone3";break;case 3:t.img="aiDrone2";break}let o=i.x-t.x,n=i.y-t.y,r=Math.hypot(o,n);if(r>.3){let s=1.5*e,a=o/r,l=n/r,c=t.x+a*s,p=t.y+l*s;Yt(c,t.y,.4)||(t.x=c),Yt(t.x,p,.4)||(t.y=p)}r<.6&&t.hurtCD<=0&&(i.health=Math.max(0,i.health-3.33)|0,_t(),T("Entity attacks!"),J.hurt(),t.hurtCD=.8,we({color:"	#740707",duration:.5}),Ae()),t.hurtCD>0&&(t.hurtCD-=e)},onHit(t,e){e?(t.alive=!1,T(Lt(["Entity murdered!","Entity destroyed!","Entity purged!"])),J.killedEntity()):T("No arrows.")},onTouch(t){H0(A.entity,1e4)&&T("You hear something like water nearby...")},onExplode(t){t.alive=!1,J.killedEntity(),T("The entity is blown to gibs.")}},[A.barrel]:{onHit(t,e){e?(t.alive=!1,C0&&C0(t.x,t.y,2.5),T("Kaboom!"),J.explode()):T("No arrows.")},onTouch(t){H0(A.barrel,1e4)&&T("Shooting this barrel may yield useful results...")},onExplode(t){t.alive=!1,C0&&C0(t.x,t.y,2.5)}},[A.food]:{onTouch(t){t.alive=!1;let e=i.health>=i.maxHealth;e&&(i.maxHealth+=1),i.health=Mt(i.health+10,0,i.maxHealth),T(e?"Yummy!":"Health restored."),_t(),J.pickup()},onExplode(t){}},[A.key]:{onTouch(t){t.alive=!1,i.hasBlueKey=!0,J.door(),T("Keycard found! Find the exit!"),Ce()},onExplode(t){t.alive=!1,i.hasBlueKey=!0,J.door(),T("The forcefield protecting the exit has suddenly lifted!"),Ce()}}};Object.freeze(A0);for(let t in A0)Object.freeze(A0[t]);Object.freeze(S0);for(let t in S0)Object.freeze(S0[t]);var mn=A0,gn=S0,yn=0;function Nt(t,e={x:0,y:0},o=void 0){let n=mn[t],r=gn[t],s=Object.assign(Object.create(r),n);return s.id=yn++,s.x=e.x,s.y=e.y,s.dist=0,s.alive=!0,s.hurtCD=0,o&&Object.assign(s,o),s}function xn(t,e,o){Io(t,e,o);for(let n of N){if(!n.alive)continue;Math.hypot(n.x-t,n.y-e)<o&&(n.onExplode?n.onExplode(n):n.alive=!1)}}Po(Nt,xn);var Se=0,it=new Set,En=0,Te=!1;function Ho(t){window.addEventListener("keydown",e=>{if(it.add(e.code),xe(),Ee(),e.code==="Space"&&(e.preventDefault(),Oo()),e.code==="KeyM"&&(e.preventDefault(),mt.classList.toggle("visible")),e.code==="Enter"&&(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement?document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock():t.requestPointerLock?t.requestPointerLock():t.mozRequestPointerLock?t.mozRequestPointerLock():t.webkitRequestPointerLock&&t.webkitRequestPointerLock()),e.code==="Escape"&&(document.exitPointerLock?document.exitPointerLock():document.mozExitPointerLock?document.mozExitPointerLock():document.webkitExitPointerLock&&document.webkitExitPointerLock()),e.code==="BracketLeft")switch(i.mouseSensitivity){case .33:T("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .22:T("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break;case .11:T("Mouse sensitivity set to low."),i.mouseSensitivity=.05;break;case .05:T("Mouse sensitivity already lowest."),i.mouseSensitivity=.05;break}if(e.code==="BracketRight")switch(i.mouseSensitivity){case .33:T("Mouse sensitivity already set to highest."),i.mouseSensitivity=.33;break;case .22:T("Mouse sensitivity set to highest."),i.mouseSensitivity=.33;break;case .11:T("Mouse sensitivity set to high."),i.mouseSensitivity=.22;break;case .05:T("Mouse sensitivity set to medium."),i.mouseSensitivity=.11;break}}),window.addEventListener("keyup",e=>it.delete(e.code)),t.addEventListener("mousedown",e=>{e.button===0&&Oo(),En=e.clientX,xe(),Ee()}),t.addEventListener("mousemove",e=>{if(!!document.pointerLockElement||!!document.mozPointerLockElement||!!document.webkitPointerLockElement){let n=e.movementX*Math.PI*(.015*i.mouseSensitivity);i.a+=n}}),Je.onclick=()=>Sn(),Qe.onclick=()=>mt.classList.toggle("visible")}function Bo(t){let e=it.has("ShiftLeft")||it.has("ShiftRight"),o=i.rotSpeed*t,n=i.accel*t,r=Math.cos(i.a),s=Math.sin(i.a),a=-s,l=r;i.weaponAnim>.75&&(i.weaponAnim=-1),i.weaponAnim>=0&&(i.weaponAnim+=t);let c=3;i.velX-=i.velX*c*t,i.velY-=i.velY*c*t,Math.abs(i.velX)<.002&&(i.velX=0),Math.abs(i.velY)<.002&&(i.velY=0),i.isMoving=!1;let p=0,E=0;it.has("ArrowLeft")&&(i.a-=o),it.has("ArrowRight")&&(i.a+=o),(it.has("ArrowUp")||it.has("KeyW"))&&(p+=r*n,E+=s*n,i.isMoving=!0),(it.has("ArrowDown")||it.has("KeyS"))&&(p-=r*n,E-=s*n,i.isMoving=!0),it.has("KeyA")&&(p-=a*n,E-=l*n,i.isMoving=!0),it.has("KeyD")&&(p+=a*n,E+=l*n,i.isMoving=!0),i.velX+=p,i.velY+=E;let d=Math.hypot(i.velX,i.velY);d>20&&(i.velX*=20/d,i.velY*=20/d);let w=i.x+i.velX*t,x=i.y+i.velY*t;if(Yt(w,i.y,ne)?i.velX=0:i.x=w,Yt(i.x,x,ne)?i.velY=0:i.y=x,i.health>=0){let y=G[(i.y|0)*f.MAP_W+(i.x|0)],h=f.zones[y]?.floorDepth||0;(i._currentZoneId!==y||i._currentFloorDepth!==h)&&(i._currentZoneId=y,i._currentFloorDepth=h,E0())}}function Oo(){if(i.weaponAnim>=0)return;i.weaponAnim=0,_t(),J.shot();let t=R0(),e=wn(t);!e||w0(e,t).depth>2.5||e.onHit&&e.onHit(e,!0)}function Yo(){for(let t of N)!t.alive||Math.hypot(t.x-i.x,t.y-i.y)>=.6||t.onTouch&&t.onTouch(t)}function No(){if(Te)return;let t=i.x|0,e=i.y|0;f.MAP[e][t]===5&&(J.portal(),T(`Floor ${Gt} cleared.`),ie(Gt+1),Te=!0,i.velX=0,i.velY=0,setTimeout(()=>{An(!0),Te=!1},100))}function wn(t){let o=document.getElementById("view").width>>1|0,n=ct[o]||1e9,r=null,s=1e9;for(let a of N){if(!a.alive)continue;let l=w0(a,t);l&&(i.sightDist>0&&l.depth>i.sightDist||o>=l.drawStartX&&o<l.drawEndX&&l.depth<n+.1&&l.depth<s&&(r=a,s=l.depth))}return r}function T0(t=2){let e=0;for(;e++<200;){let o=(Math.random()*(f.MAP_W-2)|0)+1,n=(Math.random()*(f.MAP_H-2)|0)+1;if(f.MAP[n][o]!==0)continue;let r=o+.5-i.x,s=n+.5-i.y;if(!(Math.hypot(r,s)<t))return{x:o,y:n}}return{x:9,y:9}}var De=new Map;function Xo(){De.clear();let{MAP_W:t,MAP_H:e,MAP:o,zones:n}=f;for(let r=0;r<n.length;r++){let s=n[r],a=Math.min(s.x,s.x+s.w),l=Math.max(s.x,s.x+s.w)-1,c=Math.min(s.y,s.y+s.h),p=Math.max(s.y,s.y+s.h)-1,E=Mt(a,0,t-1),d=Mt(l,0,t-1),w=Mt(c,0,e-1),x=Mt(p,0,e-1),y=[];for(let h=w;h<=x;h++)for(let H=E;H<=d;H++)Vt(H,h)||y.push({x:H,y:h});De.set(r,y)}}function Mn(t){let e=De.get(t);return!e||e.length===0?null:Lt(e)}function Ce(){let t=f.MAP_W,e=f.MAP_H;for(let o=0;o<e;o++)for(let n=0;n<t;n++)f.MAP[o][n]===7&&(f.MAP[o][n]=0)}function zo(){let t=At.x,e=At.y;for(let o=e-1;o<=e+1;o++)for(let n=t-1;n<=t+1;n++)n===t&&o===e||(f.MAP[o][n]=7)}function Wo(){if(N.length=0,lt(100)<50)for(let o=0;o<lt(2)*(f.MAP_H/20|0);o++){let n=T0(1);N.push(Nt(A.barrel,{x:n.x+.5,y:n.y+.5}))}let t=T0(4);N.push(Nt(A.key,{x:t.x+.5,y:t.y+.5})),t=T0(4),N.push(Nt(A.food,{x:t.x+.5,y:t.y+.5}));let e=Math.min((2+(Gt-1)*2)*(f.MAP_H/20|0),8);for(let o=0;o<e;o++){let n=T0(3.5);N.push(Nt(A.entity,{x:n.x+.5,y:n.y+.5}))}t=T0(4),N.push(Nt(A.ball,{x:t.x+.5,y:t.y+.5})),f.zones.forEach((o,n)=>{let r=n;o.spawnRules?.forEach(a=>{let l=Math.max(0,a.amount|0);for(let c=0;c<l;c++){let p=Mn(r);if(!p)break;N.push(Nt(a.entityType,{x:p.x+.5,y:p.y+.5}))}})})}function _t(){Ve.style.width=`${i.health/i.maxHealth*100}%`,Ze.style.width=`${i.ammo/60*100}%`,$e.textContent=Math.max(0,i.health),je.textContent=i.ammo}var be=0,Fe=0,ke=!1,Lo=!1;function T(t){let e=document.getElementById("gameLog"),o=e?.querySelector(".log-items");if(!o)return;let n=o.firstElementChild;if(n){let s=n.innerHTML,a=s.match(/^(.*?)(?:\s+x(\d+))?$/),l=a?a[1]:s,c=a&&a[2]?parseInt(a[2]):1;if(l===t){let p=a&&a[2]?c+1:2;n.innerHTML=`${t} x${p}`;return}}let r=document.createElement("div");r.innerHTML=t,o.prepend(r),e.classList.contains("collapsed")||requestAnimationFrame(()=>{o.scrollTop=0})}function Go(t){be>0&&(be-=t,be<=0&&(Ke.textContent=i.hasBlueKey?"Find the exit.":"Find the key card."))}function Ae(){ke||i.health<=0&&(ke=!0,i.speed=0,i.rotSpeed=0,Fe=2,T("YOU DIED! Soul disconnecting from the node..."))}function qo(t){ke&&(Fe-=t,Fe<=0&&Cn())}function Cn(){if(Lo)return;Lo=!0;let t=document.getElementById("game");if(t){let e=document.createElement("div");e.style.position="fixed",e.style.top="0",e.style.left="0",e.style.width="100vw",e.style.height="100vh",e.style.background="#ff0000",e.style.display="flex",e.style.alignItems="center",e.style.justifyContent="center",e.style.zIndex="999999",e.style.fontFamily='"Courier New", monospace',e.style.opacity="0",e.style.transition="opacity 2s ease-in",e.innerHTML=`
      <div style="
        background: #000;
        border: 3px solid #04650d;
        color: #20b2db;
        width: 600px;
        max-width: 90vw;
        box-shadow: 0 0 20px #04650d;
        font-family: 'Courier New', monospace;
      ">
        <div style="
          background:#000;
          color: #04650d;
          padding: 8px 15px;
          display: flex;
          justify-content: space-between;
          font-weight: bold;
          font-size: 12px;
        ">
          <span style ="color: #FFFFFF; border: 1px solid #04650d;">Death...</span>
        </div>
        <div style="padding: 20px; min-height: 200px;">
          <div style="margin-bottom: 30px;">
            <div style="text-align: center; color: #FFFFFF; font-size: 32px; margin: 8px 0;">YOU HAVE DIED</div>
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button id="returnBtn" style="
              background: #000;
              border: 2px solid #04650d;
              color: #04650d;
              padding: 12px 24px;
              font-family: 'Courier New', monospace;
              font-size: 14px;
              font-weight: bold;
              cursor: pointer;
              text-transform: uppercase;
              letter-spacing: 1px;
            ">RETURN TO TERMINAL</button>
          </div>
        </div>
      </div>
    `,document.body.appendChild(e);let o=e.querySelector("#returnBtn");if(o){let n=!1;o.addEventListener("click",r=>{r.preventDefault(),!n&&(n=!0,setTimeout(()=>{window.location.href="../index.html"},100))})}setTimeout(()=>{e.style.opacity="1"},50),t.classList.add("game-paused"),it.clear()}}function _e(t=!1){t&&r0(),i.x=Ht.x,i.y=Ht.y,i.a=0,i.hasBlueKey=!1,f.MAP[At.y][At.x]=5,zo(),Wo(),_t(),T(`Floor ${Gt}: Find the keycard.`)}function An(t=!1){t&&(Se>=y0.length-1?r0():(Se+=1,r0(Se))),i.x=Ht.x,i.y=Ht.y,i.a=0,i.hasBlueKey=!1,f.MAP[At.y][At.x]=5,zo(),Wo(),_t(),T(`Floor ${Gt}: Find the keycard.`)}function Sn(){ie(1),r0(0),_e()}function Uo(t){for(let e of N)e.alive&&e.ai&&e.ai(e,t)}var N0=performance.now(),Y0=new Map;function H0(t,e=0){if(e===0)return!(N0<Y0.get(t));let o=N0,n=Y0.get(t)??0;return o<n?!1:(Y0.set(t,o+e),!0)}function Hr(t){Y0.set(t,performance.now())}var Ie=g>>1;Ho(t0);var B0=0;function Tn(t){let e=`FPS: ${Math.round(t)}`;u.save(),u.font="12px monospace",u.textAlign="right",u.textBaseline="top";let o=v-8,n=6,r=u.measureText(e).width+8,s=16;u.fillStyle="rgba(10, 15, 25, 0.6)",u.fillRect(o-r,n-2,r,s),u.strokeStyle="rgba(60, 80, 130, 0.9)",u.strokeRect(o-r+.5,n-2+.5,r-1,s-1),u.fillStyle="#dfe6ff",u.fillText(e,o,n),u.restore()}function r0(t=-1){let e;if(t!==-1){let o=y0[t];o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}else{let o=Lt(y0);o&&(e=o.dontPersist?JSON.parse(JSON.stringify(o)):o)}At.x=e.exitPos.x,At.y=e.exitPos.y,Ht.x=e.startPos.x,Ht.y=e.startPos.y,i.sightDist=e.sightDist||ro,f.cielingColorFront=e.cielingColorFront||"#6495ED",f.floorColorFront=e.floorColorFront||"#054213",f.cielingColorBack=e.cielingColorBack||"#6495ED",f.floorColorBack=e.floorColorBack||"#03210A",f.MAP=e.mapLayout,f.MAP_W=f.MAP[0].length,f.MAP_H=f.MAP.length,f.zones=e.zones,Xo(),mo(),yo(),E0(),i.x=i.x=e.startPos.x,i.y=e.startPos.y}async function bn(){await So(),await Ue(),r0(0),_e(),i.maxHealth=20+lt(6),i.health=i.maxHealth,i.ammo=5+lt(5),_t(),requestAnimationFrame(Vo)}function Dn(t){let e=R0();if(f.zones.length<=2)go(u);else{for(let o=0;o<v;o++)Eo(t,e,o,0);Co(u)}if(f.zones.length<=2){let o=i.x|0,n=i.y|0,r=G[n*f.MAP_W+o],s=L0[r];if(!s){let a=f.zones[r].fogColor;s=u.createLinearGradient(0,g,0,Ie),s.addColorStop(0,f.floorColorFront||"#054213"),s.addColorStop(.85,f.floorColorBack||"#03210A"),s.addColorStop(.95,a||Ct),L0[r]=s}u.fillStyle=s,u.fillRect(0,Ie,v,Ie)}else{for(let o=0;o<v;o++)xo(t,e,o,0);Mo(u)}wo(u),Ao(t,e,f.MAP,f.MAP_W,f.MAP_H),Fn(),N.sort((o,n)=>n.dist-o.dist),kn(e),vn(t),Ro(u,e,v,g,i)}function Fn(){for(let t of N){let e=t.x-i.x,o=t.y-i.y;t.dist=e*e+o*o}}function kn(t){u.save();for(let e of N){if(!e.alive||Math.hypot(e.x-i.x,e.y-i.y)>i.sightDist)continue;let n=w0(e,t);if(!n||i.sightDist>0&&n.depth>i.sightDist)continue;let r=3,s=0;for(let l=0;l<r;l++){let c=n.drawStartX+l*(n.drawEndX-n.drawStartX)/(r-1);n.depth<=ct[Math.floor(c)]&&s++}if(s===0)continue;let a=_n(n);In(e,n,a),u.filter="none"}u.restore()}function _n(t){let e=1/(1+t.depth*.3);if(i.sightDist>0&&t.depth>i.sightDist*g0){let r=i.sightDist*g0,s=Math.min(1,Math.max(0,(t.depth-r)/Math.max(1e-6,i.sightDist-r)));e*=1-s*.6}let o=[1,.85,.7,.55,.4];return{quantizedShade:o.reduce((r,s)=>Math.abs(s-e)<Math.abs(r-e)?s:r,o[0])}}function In(t,e,o){o.quantizedShade<.999&&(u.filter=`brightness(${o.quantizedShade})`);let n=Math.max(1,(e.width??e.drawEndX-e.drawStartX)|0),r=e.drawStartY,s=e.drawEndY-e.drawStartY,a=e.occludedBottom|0;if(a>=s){u.filter="none";return}let l=s-a,c=R[t.img];if(!c){u.filter="none";return}let p=a/s,E=Math.round(c.height*p),d=c.height-E,w=h=>(h-e.drawStartX)*R[t.img].width/n|0,x=-1,y=0;for(let h=e.drawStartX;h<=e.drawEndX;h++){let D=h>=0&&h<v&&h<e.drawEndX&&e.depth<=ct[h];if(D&&x===-1&&(x=h,y=w(h)),(!D||h===e.drawEndX)&&x!==-1){let m=h,b=m-x,O=w(m);O<=y&&(O=y+1);let M=Math.min(R[t.img].width-y,O-y);b>0&&M>0&&s>0&&u.drawImage(R[t.img],y,0,M,d,x,r,b,l),x=-1}}}function vn(t){if(!R.pitchfork)return;let e=Math.round(v*.42),o=Math.round(e*(R.pitchfork.height/R.pitchfork.width)),n=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*5):0,r=Math.max(8,v*.02|0),s=v*.5-e/2-r/2+n,a=(i.weaponAnim+1)**10,l=a>7?7:a,c=i.weaponAnim>=0?100-l*20:0,p=i.isMoving&&i.weaponAnim<0?10*Math.sin(t*10):0,E=g-o-r+70+p+c;u.drawImage(R.pitchfork,s,E,e,o)}function Vo(t){let e=Math.min(.05,(t-N0)/1e3);N0=t;let o=e>0?1/e:0;B0=B0?B0*.9+o*.1:o,Bo(e),Uo(e),vo(e),Yo(),Dn(t/1e3),mt.classList.contains("visible")&&bo(N),No(),Go(e),qo(e),Tn(B0),Q0.drawImage(J0,0,0),requestAnimationFrame(Vo)}await bn().catch(console.error);export{r0 as ChangeMapLevel,Hr as resetCooldown,H0 as tryCooldown};
