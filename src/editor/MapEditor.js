import{f as R,k as D,p as $}from"../../chunks/chunk-EKETJP6P.js";var U=300,_=20,H=20,N=16,b=2;var w=255,m=[{id:-1,name:"infoPlayerStart",color:"#00FF00"},{id:-2,name:"infoPlayerExit",color:"#FF0000"}];Object.entries(D).forEach(([u,e])=>{m.push({id:Number(u),name:e.name,color:e.miniMapColor})});var y={PLAYER_START:-1,PLAYER_EXIT:-2},C=[-1,-2],O=[[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,2,6,2,0,0,0,0,0,0,0,2,6,2,0,0,1],[1,0,0,0,2,0,2,0,0,0,0,0,0,0,2,0,2,0,0,1],[1,0,0,0,2,2,2,0,0,0,0,0,0,0,2,2,2,0,0,1],[1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,5,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,0,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,0,0,0,3,0,0,0,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,3,3,1,3,3,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,0,0,0,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,3,0,2,2,2,0,3,0,3,0,0,0,1],[1,0,0,0,0,3,0,1,0,2,0,2,0,1,0,3,0,0,0,1],[1,0,0,0,0,0,0,0,0,2,6,2,0,0,0,0,0,0,0,1],[1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1],[1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]];function v(u,e,t){return Array.from({length:e},()=>Array.from({length:u},()=>t|0))}function G(u,e,t){let i=e/100,n=t/100,o=l=>(l+u/30)%12,s=i*Math.min(n,1-n),r=l=>n-s*Math.max(-1,Math.min(o(l)-3,Math.min(9-o(l),1))),d=l=>`0${Math.round(l*255).toString(16)}`.slice(-2);return`#${d(r(0))}${d(r(8))}${d(r(4))}`}function x(u){let e=u*47%360;return G(e,60,45)}function K(u){return{0:"empty",1:"brick",2:"panel",3:"hedge",4:"door",5:"exit",6:"blue_door",7:"[NODEOSERROR] Flesh"}[u]||`tile_${u}`}function W(u,e,t){let i=e.getBoundingClientRect(),n=Math.floor((u.clientX-i.left)/t),o=Math.floor((u.clientY-i.top)/t);return{x:n,y:o}}function M(u){let e=document.createElement("div");e.textContent=u,e.style.position="fixed",e.style.bottom="14px",e.style.left="50%",e.style.transform="translateX(-50%)",e.style.background="#0b162f",e.style.border="1px solid #294173",e.style.padding="8px 12px",e.style.borderRadius="10px",e.style.boxShadow="0 6px 20px #0007",e.style.zIndex="1000",document.body.appendChild(e),setTimeout(()=>e.remove(),900)}function p(u,e,t){return R(+u|0,e,t)}var I=class{constructor(e,t){this.canvas=e,this.canvasContext=e.getContext("2d",{alpha:!1}),this.canvasContext.imageSmoothingEnabled=!1,this.editor=t}draw(){this.syncCanvasSize(),this.drawAllMapCells(),this.editor.showGrid&&this.editor.cellSize>=b+4&&this.drawGrid()}drawAllMapCells(){for(let e=0;e<this.editor.height;e++)for(let t=0;t<this.editor.width;t++){let i=this.editor.map[e][t];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(t*this.editor.cellSize,e*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize)}}drawCell(e,t){let i=this.editor.map[t][e];this.canvasContext.fillStyle=this.colorFor(i),this.canvasContext.fillRect(e*this.editor.cellSize,t*this.editor.cellSize,this.editor.cellSize,this.editor.cellSize),this.editor.showGrid&&this.editor.cellSize>=b+4&&this.drawCellGrid(e,t)}drawGrid(){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.lineWidth=1,this.canvasContext.beginPath();for(let e=.5;e<=this.editor.width*this.editor.cellSize;e+=this.editor.cellSize)this.canvasContext.moveTo(e,0),this.canvasContext.lineTo(e,this.editor.height*this.editor.cellSize);for(let e=.5;e<=this.editor.height*this.editor.cellSize;e+=this.editor.cellSize)this.canvasContext.moveTo(0,e),this.canvasContext.lineTo(this.editor.width*this.editor.cellSize,e);this.canvasContext.stroke()}drawCellGrid(e,t){this.canvasContext.strokeStyle="#1e263f",this.canvasContext.strokeRect(e*this.editor.cellSize+.5,t*this.editor.cellSize+.5,this.editor.cellSize-1,this.editor.cellSize-1)}colorFor(e){let t=this.editor.tileManager.tiles.find(i=>i.id===e);return t?t.color:"#000000"}syncCanvasSize(){this.canvas.width=this.editor.width*this.editor.cellSize,this.canvas.height=this.editor.height*this.editor.cellSize,this.canvasContext.imageSmoothingEnabled=!1}cellFromEvent(e){return W(e,this.canvas,this.editor.cellSize)}};var S=class{constructor(){this.undoStack=[],this.redoStack=[],this.editor=null}setEditor(e){this.editor=e}pushUndo(e,t){if(!e||!e.length){if(t&&this.editor){let i={type:"full",width:this.editor.width,height:this.editor.height,map:t.map(n=>[...n])};this.undoStack.push(i)}}else this.undoStack.push({type:"stroke",changes:[...e]});this.undoStack.length>U&&this.undoStack.shift(),this.redoStack.length=0}undo(){if(!this.undoStack.length||!this.editor)return;let e=this.undoStack.pop();if(e.type==="stroke"){let t=e.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.redoStack.push({type:"stroke",changes:t});for(let i of e.changes)this.editor.map[i.y][i.x]=i.prev}else if(e.type==="full"){let t={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.redoStack.push(t),this.editor.width=e.width,this.editor.height=e.height,this.editor.map=e.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}redo(){if(!this.redoStack.length||!this.editor)return;let e=this.redoStack.pop();if(e.type==="stroke"){let t=e.changes.map(i=>({x:i.x,y:i.y,prev:i.next,next:i.prev}));this.undoStack.push({type:"stroke",changes:t});for(let i of e.changes)this.editor.map[i.y][i.x]=i.next}else if(e.type==="full"){let t={type:"full",width:this.editor.width,height:this.editor.height,map:this.editor.map.map(i=>[...i])};this.undoStack.push(t),this.editor.width=e.width,this.editor.height=e.height,this.editor.map=e.map.map(i=>[...i]),this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height)}this.editor.render()}clear(){this.undoStack.length=0,this.redoStack.length=0}};var z=class{constructor(e,t=m){this.editor=e,this.tiles=[...t],this.renderPalette()}generateIds(){let e=p(this.editor.elements.maxIdInput.value,0,w),t=[],i=m.filter(n=>C.includes(n.id));for(let n of i){let o=this.tiles.find(s=>s.id===n.id);t.push(o||{...n})}for(let n=0;n<=e;n++){let o=this.tiles.find(s=>s.id===n);t.push(o||{id:n,name:`tile_${n}`,color:x(n)})}this.tiles=t,this.renderPalette(),this.editor.render()}autoNameTiles(){this.tiles=this.tiles.map(e=>({...e,name:K(e.id)})),this.renderPalette()}seedFromUserSample(){this.tiles=[...m],this.editor.elements.maxIdInput.value="7",this.renderPalette(),this.editor.render()}renderPalette(){let e=this.editor.elements.palListEl;e.innerHTML="";let t=[...this.tiles].sort((i,n)=>i.id-n.id);for(let i of t){let n=this.createPaletteRow(i);e.appendChild(n)}this.updateActiveBadgeColor()}createPaletteRow(e){let t=document.createElement("div");t.className="palItem";let i=document.createElement("input");i.type="color",i.value=e.color,i.oninput=()=>{e.color=i.value,e.id===this.editor.activeId&&this.updateActiveBadgeColor(),this.editor.render()};let n=document.createElement("div");n.className="palMeta";let o=document.createElement("div");o.className="idBadge",o.textContent=String(e.id),o.title="Select this tile",o.onclick=()=>this.editor.setActiveId(e.id);let s=document.createElement("input");s.placeholder=`tile_${e.id}`,s.value=e.name||"",s.oninput=()=>{e.name=s.value.trim()||`tile_${e.id}`};let r=document.createElement("button");return r.textContent="\xD7",r.title="Remove (only if not last in range)",r.onclick=()=>this.deleteTile(e),(e.id===0||C.includes(e.id))&&(r.style.visibility="hidden"),n.appendChild(o),n.appendChild(s),t.appendChild(i),t.appendChild(n),t.appendChild(r),t}deleteTile(e){if(e.id===0||C.includes(e.id))return;let t=this.tiles[this.tiles.length-1];e.id===t.id?(this.tiles=this.tiles.filter(i=>i.id!==e.id),this.tiles.length>0&&(this.editor.elements.maxIdInput.value=String(t.id-1))):(e.name=`tile_${e.id}`,e.color=x(e.id)),this.renderPalette(),this.editor.render()}updateActiveBadgeColor(){let e=this.tiles.find(t=>t.id===this.editor.activeId);this.editor.elements.activeBadge.style.background=e?e.color:"transparent"}getTile(e){return this.tiles.find(t=>t.id===e)}getSortedTiles(){return[...this.tiles].sort((e,t)=>e.id-t.id)}updateTiles(e){Array.isArray(e)&&e.length&&(this.tiles=[...e].sort((t,i)=>t.id-i.id).map((t,i)=>({id:+t.id|0,name:String(t.name||`tile_${i}`),color:String(t.color||x(+t.id|0))})),this.editor.elements.maxIdInput.value=String(this.tiles[this.tiles.length-1].id),this.renderPalette())}};var B=class{constructor(e){this.editor=e}exportJS(){let e=this.editor.elements.mapNameInput?.value||"Untitled",t=null,i=null;for(let a=0;a<this.editor.height;a++)for(let h=0;h<this.editor.width;h++){let g=this.editor.map[a][h];g===y.PLAYER_START?t={x:h+.5,y:a+.5}:g===y.PLAYER_EXIT&&(i={x:h,y:a})}let n=this.editor.map.map(a=>a.map(h=>h===y.PLAYER_START||h===y.PLAYER_EXIT?0:h));t||(t={x:3.5,y:3.5}),i||(i={x:10,y:8});let s=(this.editor.zoneManager?this.editor.zoneManager.exportZones():[]).map(a=>({x:a.x??0,y:a.y??0,w:a.w??0,h:a.h??0,color:a.color??"#101b2e",name:a.name??void 0,cielingColorFront:a.cielingColorFront??void 0,cielingColorBack:a.cielingColorBack??void 0,ceilingHeight:a.ceilingHeight??void 0,floorColorBack:a.floorColorBack??void 0,fogColor:a.fogColor??void 0,spawnRules:Array.isArray(a.spawnRules)?a.spawnRules:[],floorDepth:a.floorDepth??void 0})),r={name:e,mapLayout:n,exitPos:i,startPos:t,...s.length?{zones:s}:{}},d={dontSpawnKey:!1,floorColorFront:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#6495ED",floorColorBack:"#03210A"},l=this.editor.globalMapProperties;l.dontSpawnKey!==d.dontSpawnKey&&(r.dontSpawnKey=l.dontSpawnKey),l.floorColorFront!==d.floorColorFront&&(r.floorColorFront=l.floorColorFront),l.cielingColorFront!==d.cielingColorFront&&(r.cielingColorFront=l.cielingColorFront),l.cielingColorBack!==d.cielingColorBack&&(r.cielingColorBack=l.cielingColorBack),l.floorColorBack!==d.floorColorBack&&(r.floorColorBack=l.floorColorBack);let c=`${JSON.stringify(r,null,2)};
`;this.editor.elements.io.value=c}async copyJS(){this.editor.elements.io.value||this.exportJS();try{await navigator.clipboard.writeText(this.editor.elements.io.value),M("Copied")}catch{alert("Copy failed")}}downloadJS(){this.editor.elements.io.value||this.exportJS();let e=new Blob([this.editor.elements.io.value],{type:"text/javascript"}),t=URL.createObjectURL(e),i=document.createElement("a");i.href=t,i.download="map.js",i.click(),URL.revokeObjectURL(t)}downloadJSON(){let e={width:this.editor.width,height:this.editor.height,tiles:this.editor.tileManager.getSortedTiles(),map:this.editor.map},t=new Blob([JSON.stringify(e,null,2)],{type:"application/json"}),i=URL.createObjectURL(t),n=document.createElement("a");n.href=i,n.download="map.json",n.click(),URL.revokeObjectURL(i)}loadFromText(){let e=this.editor.elements.io.value.trim();if(!e){alert("Paste a JSON object first.");return}try{let t=new Function(`return (${e})`)();if(t&&t.mapLayout&&Array.isArray(t.mapLayout)&&Array.isArray(t.mapLayout[0])){this.applyLoadedObject(t);return}}catch(t){console.warn("Object parse failed",t)}alert("Could not parse. Paste a valid JavaScript object with mapLayout.")}loadSampleMapOnly(){let e=O;this.applyLoaded(e,this.editor.tileManager.tiles)}applyLoadedObject(e){if(!e||!e.mapLayout||!Array.isArray(e.mapLayout)||!Array.isArray(e.mapLayout[0])){alert("Invalid map data - missing or invalid mapLayout");return}let t=e.mapLayout;this.editor.height=t.length,this.editor.width=t[0].length,this.editor.map=v(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let n=0;n<this.editor.width;n++)this.editor.map[i][n]=p(t[i][n],0,255);if(e.startPos&&typeof e.startPos.x=="number"&&typeof e.startPos.y=="number"){let i=e.startPos.x|0,n=e.startPos.y|0;i>=0&&i<this.editor.width&&n>=0&&n<this.editor.height&&(this.editor.map[n][i]=y.PLAYER_START)}if(e.exitPos&&typeof e.exitPos.x=="number"&&typeof e.exitPos.y=="number"){let i=e.exitPos.x,n=e.exitPos.y;i>=0&&i<this.editor.width&&n>=0&&n<this.editor.height&&(this.editor.map[n][i]=y.PLAYER_EXIT)}if(this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),e.name&&this.editor.elements.mapNameInput&&(this.editor.elements.mapNameInput.value=e.name),e.tiles&&Array.isArray(e.tiles)&&this.editor.tileManager.updateTiles(e.tiles),e.zones&&Array.isArray(e.zones)&&this.editor.zoneManager&&this.editor.zoneManager.importZones(e.zones),this.editor.globalMapProperties){let i={dontSpawnKey:!1,floorColorFront:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#6495ED",floorColorBack:"#03210A"};this.editor.globalMapProperties={dontSpawnKey:e.dontSpawnKey!==void 0?e.dontSpawnKey:i.dontSpawnKey,floorColorFront:e.floorColorFront||i.floorColorFront,cielingColorFront:e.cielingColorFront||i.cielingColorFront,cielingColorBack:e.cielingColorBack||i.cielingColorBack,floorColorBack:e.floorColorBack||i.floorColorBack},this.editor.elements.dontSpawnKey&&(this.editor.elements.dontSpawnKey.checked=this.editor.globalMapProperties.dontSpawnKey),this.editor.elements.floorColorFront&&(this.editor.elements.floorColorFront.value=this.editor.globalMapProperties.floorColorFront),this.editor.elements.cielingColorFront&&(this.editor.elements.cielingColorFront.value=this.editor.globalMapProperties.cielingColorFront),this.editor.elements.cielingColorBack&&(this.editor.elements.cielingColorBack.value=this.editor.globalMapProperties.cielingColorBack),this.editor.elements.floorColorBack&&(this.editor.elements.floorColorBack.value=this.editor.globalMapProperties.floorColorBack)}this.editor.render(),M("Loaded")}applyLoaded(e,t){if(!e||!Array.isArray(e)||!Array.isArray(e[0])){alert("Invalid map data");return}this.editor.height=e.length,this.editor.width=e[0].length,this.editor.map=v(this.editor.width,this.editor.height,0);for(let i=0;i<this.editor.height;i++)for(let n=0;n<this.editor.width;n++)this.editor.map[i][n]=p(e[i][n],0,255);this.editor.elements.wInput.value=String(this.editor.width),this.editor.elements.hInput.value=String(this.editor.height),t&&Array.isArray(t)&&this.editor.tileManager.updateTiles(t),this.editor.render(),M("Loaded")}};var E=class{constructor(e){this.editor=e,this.zones=[],this.selectedZoneId=null,this.isCreating=!1,this.creationStart=null,this.creationEnd=null,this.isDragging=!1,this.isResizing=!1,this.resizeHandle=null,this.dragOffset={x:0,y:0},this.defaultZone={color:"#271810",cielingColorFront:"#271810",cielingColorBack:"#271810",floorColorBack:"#101b2e",fogColor:"#101b2e",floorDepth:0,name:"",ceilingHeight:2}}createZone(e,t,i,n,o={}){let s={id:this.zones.length,x:Math.min(e,e+i),y:Math.min(t,t+n),w:Math.abs(i),h:Math.abs(n),...this.defaultZone,spawnRules:[],...o},r=this.zones.length>0?1:0;return this.zones.splice(r,0,s),this.reassignZoneIds(),this.selectedZoneId=r,s}addNewZone(e={}){let t=Math.floor(this.editor.width/4),i=Math.floor(this.editor.height/4),n=Math.floor(this.editor.width/8),o=Math.floor(this.editor.height/8);return this.createZone(t,i,n,o,e)}reassignZoneIds(){if(this.zones.forEach((e,t)=>{e.id=t}),this.selectedZoneId!==null){let e=this.zones.find((t,i)=>this.selectedZoneId===i||t===this.getSelectedZone());e&&(this.selectedZoneId=this.zones.indexOf(e))}}deleteZone(e){let t=this.zones.findIndex(i=>i.id===e);return t!==-1?(this.zones.splice(t,1),this.selectedZoneId===e&&(this.selectedZoneId=null),this.reassignZoneIds(),!0):!1}deleteSelectedZone(){return this.deleteZone(this.selectedZoneId)}getZone(e){return this.zones.find(t=>t.id===e)}getSelectedZone(){return this.selectedZoneId!==null?this.getZone(this.selectedZoneId):null}updateZone(e,t){let i=this.getZone(e);return i?(Object.assign(i,t),i.x=p(i.x,0,this.editor.width-1),i.y=p(i.y,0,this.editor.height-1),i.w=p(i.w,1,this.editor.width-i.x),i.h=p(i.h,1,this.editor.height-i.y),!0):!1}selectZone(e){return this.zones.find(t=>t.id===e)?(this.selectedZoneId=e,!0):!1}deselectZone(){this.selectedZoneId=null}getZoneAt(e,t){for(let i=0;i<this.zones.length;i++){let n=this.zones[i];if(e>=n.x&&e<n.x+n.w&&t>=n.y&&t<n.y+n.h)return n}return null}getResizeHandle(e,t){let i=this.getSelectedZone();if(!i)return null;let n=.3;if(Math.abs(e-i.x)<=n&&Math.abs(t-i.y)<=n)return"nw";if(Math.abs(e-(i.x+i.w))<=n&&Math.abs(t-i.y)<=n)return"ne";if(Math.abs(e-i.x)<=n&&Math.abs(t-(i.y+i.h))<=n)return"sw";if(Math.abs(e-(i.x+i.w))<=n&&Math.abs(t-(i.y+i.h))<=n)return"se";if(t>=i.y&&t<=i.y+i.h){if(Math.abs(e-i.x)<=n)return"w";if(Math.abs(e-(i.x+i.w))<=n)return"e"}if(e>=i.x&&e<=i.x+i.w){if(Math.abs(t-i.y)<=n)return"n";if(Math.abs(t-(i.y+i.h))<=n)return"s"}return null}startCreation(e,t){this.isCreating=!0,this.creationStart={x:e,y:t},this.creationEnd={x:e,y:t},this.deselectZone()}updateCreation(e,t){this.isCreating&&(this.creationEnd={x:e,y:t})}finishCreation(){if(this.isCreating&&this.creationStart&&this.creationEnd){let e=this.creationStart.x,t=this.creationStart.y,i=this.creationEnd.x-this.creationStart.x,n=this.creationEnd.y-this.creationStart.y;Math.abs(i)>=1&&Math.abs(n)>=1&&this.createZone(e,t,i,n),this.isCreating=!1,this.creationStart=null,this.creationEnd=null}}cancelCreation(){this.isCreating=!1,this.creationStart=null,this.creationEnd=null}startDrag(e,t){let i=this.getSelectedZone();i&&(this.isDragging=!0,this.dragOffset={x:e-i.x,y:t-i.y})}updateDrag(e,t){if(this.isDragging){let i=this.getSelectedZone();i&&this.updateZone(i.id,{x:e-this.dragOffset.x,y:t-this.dragOffset.y})}}endDrag(){this.isDragging=!1,this.dragOffset={x:0,y:0}}startResize(e){this.isResizing=!0,this.resizeHandle=e}updateResize(e,t){if(this.isResizing&&this.resizeHandle){let i=this.getSelectedZone();if(!i)return;let n={};switch(this.resizeHandle){case"nw":n={x:e,y:t,w:i.w+(i.x-e),h:i.h+(i.y-t)};break;case"ne":n={y:t,w:e-i.x,h:i.h+(i.y-t)};break;case"sw":n={x:e,w:i.w+(i.x-e),h:t-i.y};break;case"se":n={w:e-i.x,h:t-i.y};break;case"n":n={y:t,h:i.h+(i.y-t)};break;case"s":n={h:t-i.y};break;case"w":n={x:e,w:i.w+(i.x-e)};break;case"e":n={w:e-i.x};break}this.updateZone(i.id,n)}}endResize(){this.isResizing=!1,this.resizeHandle=null}exportZones(){let e=this.zones.map(t=>{let i={x:t.x,y:t.y,w:t.w,h:t.h,spawnRules:t.spawnRules};return i.color=t.color,t.cielingColorFront!==this.defaultZone.cielingColorFront&&t.cielingColorFront&&(i.cielingColorFront=t.cielingColorFront),t.cielingColorBack!==this.defaultZone.cielingColorBack&&t.cielingColorBack&&(i.cielingColorBack=t.cielingColorBack),t.floorColorBack!==this.defaultZone.floorColorBack&&t.floorColorBack&&(i.floorColorBack=t.floorColorBack),t.fogColor!==this.defaultZone.fogColor&&t.fogColor&&(i.fogColor=t.fogColor),t.floorDepth!==this.defaultZone.floorDepth&&t.floorDepth&&(i.floorDepth=t.floorDepth),t.name!==this.defaultZone.name&&t.name.trim()!==""&&(i.name=t.name),t.ceilingHeight!==this.defaultZone.ceilingHeight&&t.ceilingHeight&&(i.ceilingHeight=t.ceilingHeight),i});return(e.length===0||e[0].color!=="#101b2e")&&e.unshift({color:"#101b2e",x:0,y:0,w:0,h:0}),e}importZones(e){this.zones=[],this.selectedZoneId=null,Array.isArray(e)&&e.forEach((t,i)=>{let n={id:i,x:p(t.x||0,0,this.editor.width-1),y:p(t.y||0,0,this.editor.height-1),w:p(t.w||1,1,this.editor.width),h:p(t.h||1,1,this.editor.height),color:t.color||this.defaultZone.color,cielingColorFront:t.cielingColorFront||this.defaultZone.cielingColorFront,cielingColorBack:t.cielingColorBack||this.defaultZone.cielingColorBack,floorColorBack:t.floorColorBack||this.defaultZone.floorColorBack,fogColor:t.fogColor||this.defaultZone.fogColor,floorDepth:t.floorDepth!==void 0?t.floorDepth:this.defaultZone.floorDepth,name:t.name||this.defaultZone.name,ceilingHeight:t.ceilingHeight||this.defaultZone.ceilingHeight,spawnRules:Array.isArray(t.spawnRules)?t.spawnRules:[]};this.zones.push(n)})}moveZone(e,t){let i=this.zones.findIndex(o=>o.id===e);if(i===-1||t<0||t>=this.zones.length)return!1;let n=this.zones.splice(i,1)[0];return this.zones.splice(t,0,n),this.reassignZoneIds(),!0}moveZoneUp(e){let t=this.zones.findIndex(i=>i.id===e);return t>0?this.moveZone(e,t-1):!1}moveZoneDown(e){let t=this.zones.findIndex(i=>i.id===e);return t>=0&&t<this.zones.length-1?this.moveZone(e,t+1):!1}getZoneIndex(e){return this.zones.findIndex(t=>t.id===e)}getZoneDisplayInfo(){return this.zones.map((e,t)=>{let i=e.name&&e.name.trim()!==""?`Zone: ${e.name}`:`Zone ${e.id} (${e.x},${e.y} - ${e.w}x${e.h})`;return{id:e.id,index:t,priority:t+1,name:i,color:e.color,bounds:`${e.x},${e.y} - ${e.w}x${e.h}`,selected:e.id===this.selectedZoneId}})}clear(){this.zones=[],this.selectedZoneId=null}};var T=class{constructor(e,t){this.canvasContext=e,this.editor=t}drawZones(e="zone"){!this.editor.zoneManager||this.editor.zoneManager.zones.length===0||(this.canvasContext.save(),this.editor.zoneManager.zones.forEach(t=>{this.drawZone(t,e)}),this.editor.zoneManager.isCreating&&e==="zone"&&this.drawCreationPreview(),e==="zone"&&this.drawSelectionHandles(),this.canvasContext.restore())}drawZone(e,t){let i=this.editor.cellSize,n=e.x*i,o=e.y*i,s=e.w*i,r=e.h*i,d=t==="tile"?.15:.3;this.canvasContext.fillStyle=this.hexToRgba(e.color,d),this.canvasContext.fillRect(n,o,s,r);let l=t==="tile"?.25:.6;this.canvasContext.strokeStyle=this.hexToRgba(e.color,l),this.canvasContext.lineWidth=t==="tile"?1:2,this.canvasContext.strokeRect(n+.5,o+.5,s-1,r-1),t==="zone"&&this.drawZoneLabel(e,n,o,s,r)}drawZoneLabel(e,t,i,n,o){if(n<20||o<20)return;let s=t+n/2,r=i+o/2,l=this.editor.zoneManager.getZoneIndex(e.id)+1;this.canvasContext.fillStyle="rgba(0, 0, 0, 0.7)";let c=`#${e.id}:${l}`,h=this.canvasContext.measureText(c).width+8,g=16;this.canvasContext.fillRect(s-h/2,r-g/2,h,g),this.canvasContext.fillStyle="white",this.canvasContext.font="11px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle",this.canvasContext.fillText(c,s,r),l<=3&&this.drawPriorityIndicator(e,t,i,l)}drawPriorityIndicator(e,t,i,n){let s=["#ff0000","#ff8800","#ffff00"];this.canvasContext.fillStyle=s[n-1]||"#ffff00",this.canvasContext.fillRect(t+2,i+2,8,8),this.canvasContext.strokeStyle="#000000",this.canvasContext.lineWidth=1,this.canvasContext.strokeRect(t+2,i+2,8,8),this.canvasContext.fillStyle="#000000",this.canvasContext.font="8px monospace",this.canvasContext.textAlign="center",this.canvasContext.textBaseline="middle",this.canvasContext.fillText(n.toString(),t+2+8/2,i+2+8/2)}drawCreationPreview(){let e=this.editor.zoneManager;if(!e.creationStart||!e.creationEnd)return;let t=this.editor.cellSize,i=Math.min(e.creationStart.x,e.creationEnd.x),n=Math.min(e.creationStart.y,e.creationEnd.y),o=Math.max(e.creationStart.x,e.creationEnd.x),s=Math.max(e.creationStart.y,e.creationEnd.y),r=i*t,d=n*t,l=(o-i)*t,c=(s-n)*t;this.canvasContext.strokeStyle="rgba(255, 255, 255, 0.8)",this.canvasContext.lineWidth=2,this.canvasContext.setLineDash([5,5]),this.canvasContext.strokeRect(r+1,d+1,l-2,c-2),this.canvasContext.setLineDash([]),this.canvasContext.fillStyle="rgba(255, 255, 255, 0.1)",this.canvasContext.fillRect(r,d,l,c)}drawSelectionHandles(){let e=this.editor.zoneManager.getSelectedZone();if(!e)return;let t=this.editor.cellSize,i=e.x*t,n=e.y*t,o=e.w*t,s=e.h*t,r=8,d=r/2,l=[{x:i,y:n,type:"nw"},{x:i+o,y:n,type:"ne"},{x:i,y:n+s,type:"sw"},{x:i+o,y:n+s,type:"se"},{x:i+o/2,y:n,type:"n"},{x:i+o/2,y:n+s,type:"s"},{x:i,y:n+s/2,type:"w"},{x:i+o,y:n+s/2,type:"e"}];this.canvasContext.strokeStyle="#ffffff",this.canvasContext.lineWidth=2,this.canvasContext.strokeRect(i,n,o,s),l.forEach(c=>{this.canvasContext.fillStyle="#ffffff",this.canvasContext.fillRect(c.x-d,c.y-d,r,r),this.canvasContext.strokeStyle="#000000",this.canvasContext.lineWidth=1,this.canvasContext.strokeRect(c.x-d,c.y-d,r,r)})}getCursorForPosition(e,t){if(!this.editor.zoneManager)return"default";let i=this.editor.zoneManager.getResizeHandle(e,t);return i?this.getCursorForHandle(i):this.editor.zoneManager.getZoneAt(e,t)?"move":"crosshair"}getCursorForHandle(e){switch(e){case"nw":case"se":return"nw-resize";case"ne":case"sw":return"ne-resize";case"n":case"s":return"ns-resize";case"e":case"w":return"ew-resize";default:return"default"}}hexToRgba(e,t){e=e.replace("#","");let i=parseInt(e.substring(0,2),16),n=parseInt(e.substring(2,4),16),o=parseInt(e.substring(4,6),16);return`rgba(${i}, ${n}, ${o}, ${t})`}clear(){}};var f=class{constructor(e,t="default"){this.name=e,this.cursor=t,this.isActive=!1,this.previewData=null}onActivate(e){this.editor=e,this.isActive=!0,this.updateCanvasCursor()}onDeactivate(){this.isActive=!1,this.clearPreview(),this.previewData=null}onMouseDown(e,t,i){}onMouseMove(e,t,i){}onMouseUp(e,t,i){}onKeyDown(e){return!1}updateCanvasCursor(){this.editor&&this.editor.elements.canvas&&(this.editor.elements.canvas.style.cursor=this.cursor)}drawPreview(e){this.previewData&&(e.save(),e.globalAlpha=.5,e.fillStyle=this.getPreviewColor(),this.renderPreview(e,this.previewData),e.restore())}renderPreview(e,t){}getPreviewColor(){if(!this.editor)return"#ffffff";let e=this.editor.tileManager.tiles.find(t=>t.id===this.editor.activeId);return e?e.color:"#ffffff"}clearPreview(){this.previewData&&(this.previewData=null,this.editor&&this.editor.render())}applyChanges(e){!this.editor||!e.length||(e.forEach(t=>{t.x>=0&&t.x<this.editor.width&&t.y>=0&&t.y<this.editor.height&&(this.editor.map[t.y][t.x]=t.next)}),this.editor.undoManager.pushUndo(e,this.editor.map),this.editor.render())}getTileAt(e,t){return!this.editor||e<0||e>=this.editor.width||t<0||t>=this.editor.height?0:this.editor.map[t][e]}isInBounds(e,t){return e>=0&&e<this.editor.width&&t>=0&&t<this.editor.height}getDisplayName(){return this.name.toUpperCase()}getDescription(){return`${this.getDisplayName()} Tool`}};var Z=class{constructor(e){this.editor=e,this.tools=new Map,this.currentTool=null,this.toolOrder=[]}registerTool(e,t){if(!(t instanceof f))throw new Error("Tool must extend BaseTool class");this.tools.set(e,t),this.toolOrder.includes(e)||this.toolOrder.push(e),this.currentTool||this.setCurrentTool(e)}getTool(e){return this.tools.get(e)||null}getCurrentTool(){return this.currentTool}getCurrentToolId(){for(let[e,t]of this.tools)if(t===this.currentTool)return e;return null}setCurrentTool(e){let t=this.tools.get(e);return t?(this.currentTool&&this.currentTool.onDeactivate(),this.currentTool=t,this.currentTool.onActivate(this.editor),this.updateToolUI(),!0):(console.warn(`Tool with id '${e}' not found`),!1)}getAllTools(){return this.toolOrder.map(e=>({id:e,tool:this.tools.get(e)}))}nextTool(){if(this.toolOrder.length<=1)return;let e=this.getCurrentToolId(),i=(this.toolOrder.indexOf(e)+1)%this.toolOrder.length;this.setCurrentTool(this.toolOrder[i])}previousTool(){if(this.toolOrder.length<=1)return;let e=this.getCurrentToolId(),t=this.toolOrder.indexOf(e),i=t===0?this.toolOrder.length-1:t-1;this.setCurrentTool(this.toolOrder[i])}onMouseDown(e,t,i){this.currentTool&&this.currentTool.onMouseDown(e,t,i)}onMouseMove(e,t,i){this.currentTool&&this.currentTool.onMouseMove(e,t,i)}onMouseUp(e,t,i){this.currentTool&&this.currentTool.onMouseUp(e,t,i)}onKeyDown(e){return this.currentTool?this.currentTool.onKeyDown(e):!1}drawPreviews(e){this.currentTool&&this.currentTool.drawPreview(e)}updateToolUI(){this.currentTool&&(this.updateToolButtons(),this.editor&&this.editor.status&&this.editor.status(`Tool: ${this.currentTool.getDisplayName()}`))}updateToolButtons(){let e=this.editor?.elements?.canvas?.parentElement?.querySelectorAll("[data-tool-id]");if(!e)return;let t=this.getCurrentToolId();e.forEach(i=>{i.getAttribute("data-tool-id")===t?i.classList.add("active"):i.classList.remove("active")})}initializeUI(){let e=this.editor.elements.canvas?.parentElement?.querySelector(".canvas-controls .button-row");if(!e){console.warn("Canvas controls not found for tool UI");return}let t=document.createElement("div");t.className="tool-selection",t.innerHTML='<div class="section-header">TOOLS</div>';let i=document.createElement("div");i.className="tool-buttons",this.getAllTools().forEach(({id:n,tool:o})=>{let s=document.createElement("button");s.className="tool-btn",s.setAttribute("data-tool-id",n),s.textContent=o.getDisplayName(),s.title=o.getDescription(),s.addEventListener("click",()=>{this.setCurrentTool(n)}),i.appendChild(s)}),t.appendChild(i),e.parentNode.insertBefore(t,e.nextSibling),this.updateToolButtons()}destroy(){this.currentTool&&this.currentTool.onDeactivate(),this.tools.clear(),this.toolOrder=[],this.currentTool=null}};var k=class extends f{constructor(){super("Brush","crosshair"),this.isDrawing=!1,this.strokeChanges=[]}onMouseDown(e,t,i){if(i.button===2){let n=this.getTileAt(e,t);this.editor.setActiveId(n),this.editor.status(`Picked tile ID: ${n}`);return}i.button===0&&this.isInBounds(e,t)&&(this.isDrawing=!0,this.strokeChanges=[],this.paintCell(e,t))}onMouseMove(e,t,i){this.isDrawing&&this.isInBounds(e,t)&&this.paintCell(e,t);let n=this.getTileAt(e,t);this.editor.status(`(x:${e}, y:${t}) id:${n} | ${this.getDescription()}`)}onMouseUp(e,t,i){this.isDrawing&&(this.isDrawing=!1,this.strokeChanges.length>0&&this.applyChanges(this.strokeChanges),this.strokeChanges=[])}onDeactivate(){super.onDeactivate(),this.isDrawing&&(this.isDrawing=!1,this.strokeChanges.length>0&&this.applyChanges(this.strokeChanges),this.strokeChanges=[])}paintCell(e,t){let i=this.getTileAt(e,t),n=this.editor.activeId;i!==n&&(this.strokeChanges.push({x:e,y:t,prev:i,next:n}),this.editor.map[t][e]=n,this.editor.renderer.drawCell(e,t))}getDescription(){return"LMB: Paint | RMB: Eyedrop | Drag to paint multiple cells"}};var L=class extends f{constructor(){super("Hollow Rect","crosshair"),this.isDrawing=!1,this.startX=0,this.startY=0}onMouseDown(e,t,i){if(i.button===2){let n=this.getTileAt(e,t);this.editor.setActiveId(n),this.editor.status(`Picked tile ID: ${n}`);return}i.button===0&&this.isInBounds(e,t)&&(this.isDrawing=!0,this.startX=e,this.startY=t,this.updatePreview(e,t))}onMouseMove(e,t,i){this.isDrawing&&this.updatePreview(e,t);let n=this.getTileAt(e,t);if(this.isDrawing){let o=Math.abs(e-this.startX)+1,s=Math.abs(t-this.startY)+1;this.editor.status(`Drawing rectangle: ${o}x${s} | ${this.getDescription()}`)}else this.editor.status(`(x:${e}, y:${t}) id:${n} | ${this.getDescription()}`)}onMouseUp(e,t,i){this.isDrawing&&(this.isDrawing=!1,this.drawRectangle(this.startX,this.startY,e,t),this.clearPreview())}onDeactivate(){super.onDeactivate(),this.isDrawing=!1}updatePreview(e,t){this.previewData={startX:this.startX,startY:this.startY,endX:e,endY:t},this.editor.render()}renderPreview(e,t){let{startX:i,startY:n,endX:o,endY:s}=t,r=this.editor.cellSize,d=Math.min(i,o),l=Math.max(i,o),c=Math.min(n,s),a=Math.max(n,s);for(let h=d;h<=l;h++)for(let g=c;g<=a;g++)(h===d||h===l||g===c||g===a)&&this.isInBounds(h,g)&&e.fillRect(h*r,g*r,r,r)}drawRectangle(e,t,i,n){let o=[],s=this.editor.activeId,r=Math.min(e,i),d=Math.max(e,i),l=Math.min(t,n),c=Math.max(t,n);for(let a=r;a<=d;a++)for(let h=l;h<=c;h++)if((a===r||a===d||h===l||h===c)&&this.isInBounds(a,h)){let g=this.getTileAt(a,h);g!==s&&o.push({x:a,y:h,prev:g,next:s})}this.applyChanges(o)}getDescription(){return"LMB: Draw hollow rectangle | RMB: Eyedrop | Drag from corner to corner"}},P=class extends f{constructor(){super("Filled Rect","crosshair"),this.isDrawing=!1,this.startX=0,this.startY=0}onMouseDown(e,t,i){if(i.button===2){let n=this.getTileAt(e,t);this.editor.setActiveId(n),this.editor.status(`Picked tile ID: ${n}`);return}i.button===0&&this.isInBounds(e,t)&&(this.isDrawing=!0,this.startX=e,this.startY=t,this.updatePreview(e,t))}onMouseMove(e,t,i){this.isDrawing&&this.updatePreview(e,t);let n=this.getTileAt(e,t);if(this.isDrawing){let o=Math.abs(e-this.startX)+1,s=Math.abs(t-this.startY)+1;this.editor.status(`Drawing filled rectangle: ${o}x${s} | ${this.getDescription()}`)}else this.editor.status(`(x:${e}, y:${t}) id:${n} | ${this.getDescription()}`)}onMouseUp(e,t,i){this.isDrawing&&(this.isDrawing=!1,this.drawRectangle(this.startX,this.startY,e,t),this.clearPreview())}onDeactivate(){super.onDeactivate(),this.isDrawing=!1}updatePreview(e,t){this.previewData={startX:this.startX,startY:this.startY,endX:e,endY:t},this.editor.render()}renderPreview(e,t){let{startX:i,startY:n,endX:o,endY:s}=t,r=this.editor.cellSize,d=Math.min(i,o),l=Math.max(i,o),c=Math.min(n,s),a=Math.max(n,s);for(let h=d;h<=l;h++)for(let g=c;g<=a;g++)this.isInBounds(h,g)&&e.fillRect(h*r,g*r,r,r)}drawRectangle(e,t,i,n){let o=[],s=this.editor.activeId,r=Math.min(e,i),d=Math.max(e,i),l=Math.min(t,n),c=Math.max(t,n);for(let a=r;a<=d;a++)for(let h=l;h<=c;h++)if(this.isInBounds(a,h)){let g=this.getTileAt(a,h);g!==s&&o.push({x:a,y:h,prev:g,next:s})}this.applyChanges(o)}getDescription(){return"LMB: Draw filled rectangle | RMB: Eyedrop | Drag from corner to corner"}};var A=class extends f{constructor(){super("Line","crosshair"),this.isDrawing=!1,this.startX=0,this.startY=0}onMouseDown(e,t,i){if(i.button===2){let n=this.getTileAt(e,t);this.editor.setActiveId(n),this.editor.status(`Picked tile ID: ${n}`);return}i.button===0&&this.isInBounds(e,t)&&(this.isDrawing=!0,this.startX=e,this.startY=t,this.updatePreview(e,t))}onMouseMove(e,t,i){this.isDrawing&&this.updatePreview(e,t);let n=this.getTileAt(e,t);if(this.isDrawing){let o=Math.sqrt(Math.pow(e-this.startX,2)+Math.pow(t-this.startY,2)).toFixed(1);this.editor.status(`Drawing line: distance ${o} | ${this.getDescription()}`)}else this.editor.status(`(x:${e}, y:${t}) id:${n} | ${this.getDescription()}`)}onMouseUp(e,t,i){this.isDrawing&&(this.isDrawing=!1,this.drawLine(this.startX,this.startY,e,t),this.clearPreview())}onDeactivate(){super.onDeactivate(),this.isDrawing=!1}updatePreview(e,t){this.previewData={startX:this.startX,startY:this.startY,endX:e,endY:t},this.editor.render()}renderPreview(e,t){let{startX:i,startY:n,endX:o,endY:s}=t,r=this.editor.cellSize;this.getLinePoints(i,n,o,s).forEach(({x:l,y:c})=>{this.isInBounds(l,c)&&e.fillRect(l*r,c*r,r,r)})}drawLine(e,t,i,n){let o=[],s=this.editor.activeId;this.getLinePoints(e,t,i,n).forEach(({x:d,y:l})=>{if(this.isInBounds(d,l)){let c=this.getTileAt(d,l);c!==s&&o.push({x:d,y:l,prev:c,next:s})}}),this.applyChanges(o)}getLinePoints(e,t,i,n){let o=[],s=Math.abs(i-e),r=Math.abs(n-t),d=e<i?1:-1,l=t<n?1:-1,c=s-r,a=e,h=t;for(;o.push({x:a,y:h}),!(a===i&&h===n);){let g=2*c;g>-r&&(c-=r,a+=d),g<s&&(c+=s,h+=l)}return o}getDescription(){return"LMB: Draw line | RMB: Eyedrop | Drag from start to end point"}};var F=class{constructor(){console.log("In editor code"),this.width=_,this.height=H,this.cellSize=N,this.showGrid=!0,this.activeId=1,this.map=v(this.width,this.height,0),this.currentMode="tile",this.globalMapProperties={dontSpawnKey:!1,floorColorFront:"#054213",cielingColorFront:"#6495ed",cielingColorBack:"#6495ED",floorColorBack:"#03210A"},this.renderer=null,this.undoManager=null,this.tileManager=null,this.exportImport=null,this.zoneManager=null,this.zoneRenderer=null,this.toolManager=null,this.painting=!1,this.strokeChanges=null,this.idBuffer="",this.elements={},this.initializeDOM(),this.initializeComponents(),this.bindEvents(),this.render()}initializeDOM(){this.elements={canvas:document.getElementById("editor"),wInput:document.getElementById("w"),hInput:document.getElementById("h"),cellInput:document.getElementById("cell"),maxIdInput:document.getElementById("maxId"),activeIdInput:document.getElementById("activeId"),activeBadge:document.getElementById("activeBadge"),palListEl:document.getElementById("palList"),statusEl:document.getElementById("status"),io:document.getElementById("io"),gridBtn:document.getElementById("gridBtn"),mapNameInput:document.getElementById("mapName"),dontSpawnKey:document.getElementById("dontSpawnKey"),floorColorFront:document.getElementById("floorColorFront"),cielingColorFront:document.getElementById("cielingColorFront"),cielingColorBack:document.getElementById("cielingColorBack"),floorColorBack:document.getElementById("floorColorBack"),modeBtn:document.getElementById("modeBtn"),tilePanel:document.getElementById("tilePanel"),zonePanel:document.getElementById("zonePanel"),noZoneSelected:document.getElementById("noZoneSelected"),zoneEditor:document.getElementById("zoneEditor"),zoneId:document.getElementById("zoneId"),zoneX:document.getElementById("zoneX"),zoneY:document.getElementById("zoneY"),zoneW:document.getElementById("zoneW"),zoneH:document.getElementById("zoneH"),zoneColor:document.getElementById("zoneColor"),zoneCeilFront:document.getElementById("zoneCeilFront"),zoneCeilBack:document.getElementById("zoneCeilBack"),zoneFloorBack:document.getElementById("zoneFloorBack"),zoneFogColor:document.getElementById("zoneFogColor"),zoneFloorDepth:document.getElementById("zoneFloorDepth"),zoneCeilingHeight:document.getElementById("zoneCeilingHeight"),zoneName:document.getElementById("zoneName"),deleteZoneBtn:document.getElementById("deleteZoneBtn"),zoneMiniPanel:document.getElementById("zoneMiniPanel"),zoneMiniList:document.getElementById("zoneMiniList"),zoneLayerList:document.getElementById("zoneLayerList"),addZoneBtn:document.getElementById("addZoneBtn"),duplicateZoneButton:document.getElementById("duplicateZoneButton")},this.elements.wInput.value=String(this.width),this.elements.hInput.value=String(this.height),this.elements.cellInput.value=String(this.cellSize),this.elements.maxIdInput.value="7"}initializeComponents(){this.renderer=new I(this.elements.canvas,this),this.undoManager=new S,this.undoManager.setEditor(this),this.tileManager=new z(this,m),this.exportImport=new B(this),this.zoneManager=new E(this),this.zoneRenderer=new T(this.renderer.canvasContext,this),this.initializeToolSystem(),this.setActiveId(1)}initializeToolSystem(){this.toolManager=new Z(this),this.toolManager.registerTool("brush",new k),this.toolManager.registerTool("hollow-rect",new L),this.toolManager.registerTool("filled-rect",new P),this.toolManager.registerTool("line",new A),setTimeout(()=>{this.toolManager.initializeUI()},0)}bindEvents(){document.getElementById("genBtn").onclick=()=>this.tileManager.generateIds(),document.getElementById("resetNamesBtn").onclick=()=>this.tileManager.autoNameTiles(),document.getElementById("seedWolf3dBtn").onclick=()=>this.tileManager.seedFromUserSample(),document.getElementById("resizeBtn").onclick=()=>this.handleResize(),document.getElementById("clearBtn").onclick=()=>this.clearMap(),document.getElementById("fillBtn").onclick=()=>this.fillMap(),document.getElementById("gridBtn").onclick=()=>this.toggleGrid(),document.getElementById("undoBtn").onclick=()=>this.undoManager.undo(),document.getElementById("redoBtn").onclick=()=>this.undoManager.redo(),document.getElementById("loadArrayBtn").onclick=()=>this.exportImport.loadFromText(),document.getElementById("loadSampleBtn").onclick=()=>this.exportImport.loadSampleMapOnly(),document.getElementById("exportTsBtn").onclick=()=>this.exportImport.exportJS(),document.getElementById("copyTsBtn").onclick=()=>this.exportImport.copyJS(),document.getElementById("downloadTsBtn").onclick=()=>this.exportImport.downloadJS(),document.getElementById("downloadJsonBtn").onclick=()=>this.exportImport.downloadJSON(),this.elements.modeBtn.onclick=()=>this.toggleMode(),this.elements.addZoneBtn.onclick=()=>this.addNewZone(),this.elements.duplicateZoneButton.onclick=()=>this.duplicateSelectedZone(),this.elements.deleteZoneBtn.onclick=()=>this.deleteSelectedZone(),this.elements.zoneX.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneY.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneW.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneH.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneColor.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilFront.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilBack.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilFront.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneFloorBack.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneFogColor.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneFloorDepth.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneName.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.zoneCeilingHeight.oninput=()=>this.updateSelectedZoneFromInputs(),this.elements.dontSpawnKey.onchange=()=>this.updateGlobalMapProperties(),this.elements.floorColorFront.oninput=()=>this.updateGlobalMapProperties(),this.elements.cielingColorFront.oninput=()=>this.updateGlobalMapProperties(),this.elements.cielingColorBack.oninput=()=>this.updateGlobalMapProperties(),this.elements.floorColorBack.oninput=()=>this.updateGlobalMapProperties(),this.elements.activeIdInput.oninput=()=>{this.setActiveId(p(this.elements.activeIdInput.value,0,w))},this.elements.cellInput.addEventListener("input",()=>this.renderer.syncCanvasSize()),document.addEventListener("keydown",e=>this.handleKeyDown(e)),this.bindCanvasEvents()}bindCanvasEvents(){let e=this.elements.canvas;e.addEventListener("mousemove",t=>this.handleMouseMove(t)),e.addEventListener("mousedown",t=>this.handleMouseDown(t)),e.addEventListener("mouseup",t=>this.handleMouseUp(t)),e.addEventListener("mouseleave",()=>this.endStroke()),e.addEventListener("contextmenu",t=>t.preventDefault())}handleKeyDown(e){if(e.ctrlKey&&!e.shiftKey&&e.key.toLowerCase()==="z"){e.preventDefault(),this.undoManager.undo();return}if(e.ctrlKey&&e.key.toLowerCase()==="y"){e.preventDefault(),this.undoManager.redo();return}if(!(document.activeElement&&["INPUT","TEXTAREA"].includes(document.activeElement.tagName))){if(e.key.toLowerCase()==="e"){this.setActiveId(-1),this.status("Selected: infoPlayerStart (E)");return}if(e.key.toLowerCase()==="x"){this.setActiveId(-2),this.status("Selected: infoPlayerExit (X)");return}if(/^[0-9]$/.test(e.key)&&(this.idBuffer+=e.key,this.idBuffer.length>3&&(this.idBuffer=this.idBuffer.slice(-3)),this.status(`ID input: ${this.idBuffer}`)),e.key==="Enter"&&this.idBuffer){let t=this.tileManager.tiles.length?this.tileManager.tiles[this.tileManager.tiles.length-1].id:w;this.setActiveId(p(this.idBuffer,0,t)),this.idBuffer=""}}}handleMouseMove(e){let t=this.renderer.cellFromEvent(e);t.x>=0&&t.y>=0&&t.x<this.width&&t.y<this.height&&(this.currentMode==="zone"?this.handleZoneMouseMove(t):this.toolManager&&this.toolManager.onMouseMove(t.x,t.y,e))}handleMouseDown(e){e.preventDefault();let t=this.renderer.cellFromEvent(e);t.x<0||t.y<0||t.x>=this.width||t.y>=this.height||(this.currentMode==="zone"?this.handleZoneMouseDown(t,e):this.toolManager&&this.toolManager.onMouseDown(t.x,t.y,e))}handleMouseUp(e){let t=this.renderer.cellFromEvent(e);this.currentMode==="tile"&&this.toolManager&&this.toolManager.onMouseUp(t.x,t.y,e),this.endStroke()}endStroke(){this.painting&&(this.painting=!1,this.undoManager.pushUndo(this.strokeChanges,this.map),this.strokeChanges=null),this.currentMode==="zone"&&this.zoneManager&&(this.zoneManager.finishCreation(),this.zoneManager.endDrag(),this.zoneManager.endResize(),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render())}handleZoneMouseMove(e){let t=e.x,i=e.y;if(this.zoneRenderer){let o=this.zoneRenderer.getCursorForPosition(t,i);this.elements.canvas.style.cursor=o}this.zoneManager.isCreating?(this.zoneManager.updateCreation(t,i),this.render()):this.zoneManager.isDragging?(this.zoneManager.updateDrag(t,i),this.render()):this.zoneManager.isResizing&&(this.zoneManager.updateResize(t,i),this.render());let n=this.zoneManager.getZoneAt(t,i);n?this.status(`Zone #${n.id} (x:${t}, y:${i}) ${n.w}x${n.h}`):this.status(`(x:${t}, y:${i}) - Zone Mode`)}handleZoneMouseDown(e,t){let i=e.x,n=e.y;if(t.button===2){let s=this.zoneManager.getZoneAt(i,n);s&&(this.zoneManager.deleteZone(s.id),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render(),this.status(`Deleted zone #${s.id}`));return}let o=this.zoneManager.getResizeHandle(i,n);if(o)this.zoneManager.startResize(o),this.status(`Resizing zone #${this.zoneManager.getSelectedZone().id}`);else{let s=this.zoneManager.getZoneAt(i,n);s?(this.zoneManager.selectZone(s.id),this.zoneManager.startDrag(i,n),this.status(`Selected zone #${s.id} - drag to move`),this.updateZoneUI()):(this.zoneManager.startCreation(i,n),this.status("Creating zone - drag to set size"))}this.render()}paintCell(e,t,i){let n=this.map[t][e];n!==i&&(this.map[t][e]=i,this.strokeChanges.push({x:e,y:t,prev:n,next:i}),this.renderer.drawCell(e,t))}setActiveId(e){e===-1||e===-2?this.activeId=e:this.activeId=p(e,0,w),this.elements.activeIdInput.value=String(this.activeId),this.elements.activeBadge.textContent=`ID ${this.activeId}`;let t=this.tileManager.tiles.find(i=>i.id===this.activeId);this.elements.activeBadge.style.background=t?t.color:"transparent"}handleResize(){let e=p(this.elements.wInput.value,1,256),t=p(this.elements.hInput.value,1,256),i=p(this.elements.cellInput.value,2,48),n=v(e,t,0);for(let o=0;o<Math.min(this.height,t);o++)for(let s=0;s<Math.min(this.width,e);s++)n[o][s]=this.map[o][s];this.width=e,this.height=t,this.cellSize=i,this.map=n,this.render()}clearMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(0),this.render()}fillMap(){this.undoManager.pushUndo([],this.map),this.fillMapWithValue(this.activeId),this.render()}fillMapWithValue(e){for(let t=0;t<this.height;t++)for(let i=0;i<this.width;i++)this.map[t][i]=e}toggleGrid(){this.showGrid=!this.showGrid,this.elements.gridBtn.textContent=`Grid: ${this.showGrid?"on":"off"}`,this.render()}setMode(e){e!==this.currentMode&&(this.currentMode=e,this.updateModeUI(),this.currentMode==="zone"&&(this.endStroke(),this.zoneManager.cancelCreation()),this.render(),this.status(`Switched to ${e.toUpperCase()} mode`))}toggleMode(){let e=this.currentMode==="tile"?"zone":"tile";this.setMode(e)}updateModeUI(){this.elements.modeBtn.textContent=this.currentMode==="tile"?"MODE: TILE EDIT":"MODE: ZONE EDIT",this.currentMode==="zone"?(this.elements.tilePanel.style.display="none",this.elements.zonePanel.style.display="block",this.elements.zoneMiniPanel.style.display="none",this.initSpawnRulesUI()):(this.elements.tilePanel.style.display="block",this.elements.zonePanel.style.display="none",this.updateZoneMiniPanel()),this.updateCanvasCursor(),this.updateZoneUI()}addNewZone(){if(this.zoneManager){let e=this.zoneManager.addNewZone();this.status(`Created zone #${e.id}`),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render()}}duplicateSelectedZone(){if(this.zoneManager){let e=this.zoneManager.addNewZone(this.zoneManager.getSelectedZone());this.status(`Created zone #${e.id}`),this.updateZoneUI(),this.updateZoneMiniPanel(),this.render()}}deleteSelectedZone(){if(this.zoneManager&&this.zoneManager.selectedZoneId!==null){let e=this.zoneManager.selectedZoneId;this.zoneManager.deleteSelectedZone(),this.status(`Deleted zone #${e}`),this.updateZoneUI(),this.render()}}updateSelectedZoneFromInputs(){let e=this.zoneManager?.getSelectedZone();if(!e||this._updatingZoneUI)return;let t={x:p(parseInt(this.elements.zoneX.value)||0,0,this.width-1),y:p(parseInt(this.elements.zoneY.value)||0,0,this.height-1),w:p(parseInt(this.elements.zoneW.value)||1,1,this.width),h:p(parseInt(this.elements.zoneH.value)||1,1,this.height),color:this.elements.zoneColor.value,cielingColorFront:this.elements.zoneCeilFront.value,cielingColorBack:this.elements.zoneCeilBack.value,floorColorBack:this.elements.zoneFloorBack.value,fogColor:this.elements.zoneFogColor.value,floorDepth:parseInt(this.elements.zoneFloorDepth.value)||0,name:this.elements.zoneName.value||"",ceilingHeight:this.elements.zoneCeilingHeight.value||2};this.zoneManager.updateZone(e.id,t),this.render(),this.updateZoneMiniPanel()}updateZoneUI(){if(this.currentMode!=="zone"||!this.zoneManager)return;this.updateZoneLayerPanel();let e=this.zoneManager.getSelectedZone();e?(this.updateSpawnRulesDisplay(),this.elements.noZoneSelected.style.display="none",this.elements.zoneEditor.style.display="block",this._updatingZoneUI=!0,this.elements.zoneId.textContent=e.id,this.elements.zoneX.value=e.x,this.elements.zoneY.value=e.y,this.elements.zoneW.value=e.w,this.elements.zoneH.value=e.h,this.elements.zoneColor.value=e.color,this.elements.zoneCeilFront.value=e.cielingColorFront,this.elements.zoneCeilBack.value=e.cielingColorBack,this.elements.zoneFloorBack.value=e.floorColorBack,this.elements.zoneFogColor.value=e.fogColor,this.elements.zoneFloorDepth.value=e.floorDepth||0,this.elements.zoneName.value=e.name||"",this.elements.zoneCeilingHeight.value=e.ceilingHeight||2,this._updatingZoneUI=!1):(this.elements.noZoneSelected.style.display="block",this.elements.zoneEditor.style.display="none")}updateZoneLayerPanel(){if(!this.zoneManager||this.currentMode!=="zone")return;let e=this.zoneManager.getZoneDisplayInfo();if(this.elements.zoneLayerList.innerHTML="",e.length===0){let t=document.createElement("div");t.className="zone-empty-message",t.textContent="No zones created",this.elements.zoneLayerList.appendChild(t);return}e.forEach((t,i)=>{let n=document.createElement("div");n.className=`zone-layer-item ${t.selected?"selected":""}`,n.dataset.zoneId=t.id,n.draggable=!0,n.innerHTML=`
        <div class="zone-layer-color" style="background-color: ${t.color}"></div>
        <div class="zone-layer-priority">${t.priority}</div>
        <div class="zone-layer-info">${t.name}</div>
        <div class="zone-layer-controls">
          <button class="zone-layer-btn" data-action="up" ${i===0?"disabled":""}>\u2191</button>
          <button class="zone-layer-btn" data-action="down" ${i===e.length-1?"disabled":""}>\u2193</button>
        </div>
      `,n.addEventListener("click",o=>{if(o.target.classList.contains("zone-layer-btn")){let s=o.target.dataset.action;s==="up"?this.zoneManager.moveZoneUp(t.id):s==="down"&&this.zoneManager.moveZoneDown(t.id),this.updateZoneUI(),this.render(),o.stopPropagation()}else this.zoneManager.selectZone(t.id),this.updateZoneUI(),this.render()}),n.addEventListener("dragstart",o=>{o.dataTransfer.setData("text/plain",t.id.toString()),n.classList.add("dragging"),this.elements.zoneLayerList.classList.add("drag-active")}),n.addEventListener("dragend",()=>{n.classList.remove("dragging"),this.elements.zoneLayerList.classList.remove("drag-active")}),n.addEventListener("dragover",o=>{o.preventDefault()}),n.addEventListener("drop",o=>{o.preventDefault();let s=parseInt(o.dataTransfer.getData("text/plain")),r=Array.from(this.elements.zoneLayerList.children).indexOf(n);s!==t.id&&(this.zoneManager.moveZone(s,r),this.updateZoneUI(),this.render())}),this.elements.zoneLayerList.appendChild(n)})}updateZoneMiniPanel(){if(this.currentMode==="zone"||!this.zoneManager){this.elements.zoneMiniPanel.style.display="none";return}let e=this.zoneManager.zones;if(e.length===0){this.elements.zoneMiniPanel.style.display="none";return}this.elements.zoneMiniPanel.style.display="block",this.elements.zoneMiniList.innerHTML="",e.forEach(t=>{let i=document.createElement("div");i.className="zone-mini-item",i.textContent=`#${t.id}`,i.style.backgroundColor=t.color,i.title=`Zone ${t.id}: ${t.x},${t.y} (${t.w}x${t.h})`,this.elements.zoneMiniList.appendChild(i)})}updateCanvasCursor(){if(this.currentMode==="zone"&&this.zoneRenderer){let e=this.elements.canvas;e.style.cursor="crosshair"}else this.elements.canvas.style.cursor="default"}status(e){this.elements.statusEl.textContent=e}render(){if(this.renderer.draw(),this.zoneRenderer){let e=this.currentMode==="zone"?"zone":"tile";this.zoneRenderer.drawZones(e)}this.currentMode==="tile"&&this.toolManager&&this.toolManager.drawPreviews(this.renderer.canvasContext),this.currentMode==="zone"&&this.updateZoneLayerPanel()}initSpawnRulesUI(){this.updateSpawnRuleEntityDropdown();let e=document.getElementById("addSpawnRuleBtn"),t=document.getElementById("spawnRulesList");e&&!e.hasAttribute("data-listener-added")&&(e.addEventListener("click",i=>this.addSpawnRule(i)),e.setAttribute("data-listener-added","true")),t&&!t.hasAttribute("data-listener-added")&&(t.addEventListener("click",i=>{if(i.target.classList.contains("spawn-rule-delete")){let n=parseInt(i.target.getAttribute("data-index"));this.removeSpawnRule(n)}}),t.setAttribute("data-listener-added","true"))}updateSpawnRuleEntityDropdown(){let e=document.getElementById("spawnRuleEntity");e.innerHTML="",Object.values($).forEach(t=>{let i=document.createElement("option");i.value=t,i.textContent=t.toUpperCase(),e.appendChild(i)})}addSpawnRule(e){if(e.preventDefault(),!this.zoneManager||this.currentMode!=="zone")return;let t=this.zoneManager.getSelectedZone();if(!t)return;let i=document.getElementById("spawnRuleEntity").value,n=parseInt(document.getElementById("spawnRuleAmount").value);t.spawnRules||(t.spawnRules=[]),t.spawnRules.push({entityType:i,amount:n}),this.updateSpawnRulesDisplay()}updateSpawnRulesDisplay(){if(!this.zoneManager||this.currentMode!=="zone")return;let e=this.zoneManager.getSelectedZone(),t=document.getElementById("spawnRulesList");if(t.innerHTML="",!e||!e.spawnRules||e.spawnRules.length===0){t.innerHTML='<div class="terminal-text">No spawn rules defined</div>';return}e.spawnRules.forEach((i,n)=>{let o=document.createElement("div");o.className="spawn-rule-item",o.innerHTML=`
      <span class="spawn-rule-info">
        ENTITY: ${i.entityType.toUpperCase()} x${i.amount}
      </span>
      <button class="spawn-rule-delete" data-index="${n}">\xD7</button>
    `,t.appendChild(o)})}removeSpawnRule(e){if(!this.zoneManager||this.currentMode!=="zone")return;let t=this.zoneManager.getSelectedZone();t&&t.spawnRules&&(t.spawnRules.splice(e,1),this.updateSpawnRulesDisplay())}updateGlobalMapProperties(){this.globalMapProperties={dontSpawnKey:this.elements.dontSpawnKey.checked,floorColorFront:this.elements.floorColorFront.value,cielingColorFront:this.elements.cielingColorFront.value,cielingColorBack:this.elements.cielingColorBack.value,floorColorBack:this.elements.floorColorBack.value}}};new F;export{F as MapEditor};
